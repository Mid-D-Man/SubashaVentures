@using SubashaVentures.Services.Categories
@using SubashaVentures.Services.Brands
@using SubashaVentures.Domain.Product
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Pages.Shop
@using static SubashaVentures.Pages.Shop.Shop
@inject ICategoryService CategoryService
@inject IBrandService BrandService
@inject ILogger<ShopSidebar> Logger

<div class="shop-sidebar-content">
    @if (isLoading)
    {
        <div class="sidebar-loading">
            <div class="loading-spinner"></div>
            <span>Loading filters...</span>
        </div>
    }
    else
    {
        <!-- Categories Section -->
        <div class="filter-section">
            <h3 class="filter-title">Categories</h3>
            <div class="category-list">
                <a href="shop?category=all" class="category-item @(selectedCategory == "all" ? "active" : "")"
                   @onclick="@(() => HandleCategoryClick("all"))" @onclick:preventDefault>
                    <span class="category-icon">üì¶</span>
                    <span class="category-name">All Products</span>
                    <span class="category-count">(@totalProducts)</span>
                </a>
                @foreach (var category in categories)
                {
                    <a href="shop?category=@category.Slug" 
                       class="category-item @(selectedCategory == category.Slug ? "active" : "")"
                       @onclick="@(() => HandleCategoryClick(category.Slug))" @onclick:preventDefault>
                        <span class="category-icon">@(category.IconEmoji ?? "üìÅ")</span>
                        <span class="category-name">@category.Name</span>
                        <span class="category-count">(@category.ProductCount)</span>
                    </a>
                }
            </div>
        </div>

        <!-- Price Range Filter -->
        <div class="filter-section">
            <h3 class="filter-title">Price Range</h3>
            <div class="price-filter">
                <div class="price-inputs">
                    <InputField Type="number"
                               Placeholder="Min"
                               Value="@(minPrice?.ToString() ?? "")"
                               ValueChanged="@((string val) => HandleMinPriceChange(val))"
                               Size="InputField.InputSize.Small"
                               CssClass="price-input-field" />
                    <span class="price-separator">-</span>
                    <InputField Type="number"
                               Placeholder="Max"
                               Value="@(maxPrice?.ToString() ?? "")"
                               ValueChanged="@((string val) => HandleMaxPriceChange(val))"
                               Size="InputField.InputSize.Small"
                               CssClass="price-input-field" />
                </div>
                <button class="apply-price-btn" 
                        @onclick="ApplyPriceFilter"
                        disabled="@(!IsValidPriceRange)">
                    Apply
                </button>
            </div>
            
            <!-- Quick price ranges -->
            <div class="price-ranges">
                @foreach (var range in priceRanges)
                {
                    <button class="price-range-btn @(selectedPriceRange == range.Value ? "active" : "")" 
                            @onclick="@(() => SelectPriceRange(range.Value))">
                        @range.Label
                    </button>
                }
            </div>
        </div>

        <!-- Rating Filter -->
        <div class="filter-section">
            <h3 class="filter-title">Customer Rating</h3>
            <div class="rating-filter">
                @for (int i = 5; i >= 1; i--)
                {
                    var rating = i;
                    <label class="rating-option">
                        <input type="checkbox" 
                               checked="@selectedRatings.Contains(rating)"
                               @onchange="@(() => ToggleRating(rating))" />
                        <span class="rating-stars">
                            @for (int j = 0; j < rating; j++)
                            {
                                <span class="star filled">‚≠ê</span>
                            }
                            @for (int j = rating; j < 5; j++)
                            {
                                <span class="star">‚òÜ</span>
                            }
                        </span>
                        <span class="rating-text">& Up</span>
                    </label>
                }
            </div>
        </div>

        <!-- Brand Filter -->
        <div class="filter-section">
            <h3 class="filter-title">Brands</h3>
            <div class="brand-dropdown">
                <select class="brand-select" 
                        @onchange="HandleBrandChange"
                        value="@string.Empty">
                    <option value="">Select a brand...</option>
                    @foreach (var brand in allBrands)
                    {
                        <option value="@brand">@brand</option>
                    }
                </select>
            </div>
            
            @if (selectedBrands.Any())
            {
                <div class="selected-brands">
                    @foreach (var brand in selectedBrands)
                    {
                        <div class="selected-brand-tag">
                            <span>@brand</span>
                            <button class="remove-brand" @onclick="@(() => RemoveBrand(brand))">√ó</button>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Quick Filters -->
        <div class="filter-section">
            <h3 class="filter-title">Quick Filters</h3>
            <div class="quick-filters">
                <label class="quick-filter-chip @(inStockOnly ? "active" : "")">
                    <input type="checkbox" 
                           checked="@inStockOnly"
                           @onchange="ToggleInStock" />
                    <span>In Stock Only</span>
                </label>
                <label class="quick-filter-chip @(onSaleOnly ? "active" : "")">
                    <input type="checkbox" 
                           checked="@onSaleOnly"
                           @onchange="ToggleOnSale" />
                    <span>On Sale</span>
                </label>
            </div>
        </div>

        <!-- Clear Filters -->
        <div class="filter-actions">
            <button class="clear-filters-btn" @onclick="ClearAllFilters">
                Clear All Filters
            </button>
        </div>
    }
</div>

@code {
    [CascadingParameter] public SubashaVentures.Pages.Shop.Shop? ShopPage { get; set; }
    
    private List<CategoryViewModel> categories = new();
    private List<string> allBrands = new();
    private bool isLoading = true;
    private string selectedCategory = "all";
    private decimal? minPrice = null;
    private decimal? maxPrice = null;
    private string selectedPriceRange = "";
    private HashSet<int> selectedRatings = new();
    private HashSet<string> selectedBrands = new();
    private bool inStockOnly = false;
    private bool onSaleOnly = false;
    private int totalProducts = 0;

    private List<(string Value, string Label)> priceRanges = new()
    {
        ("0-5000", "Under ‚Ç¶5,000"),
        ("5000-10000", "‚Ç¶5,000 - ‚Ç¶10,000"),
        ("10000-20000", "‚Ç¶10,000 - ‚Ç¶20,000"),
        ("20000-50000", "‚Ç¶20,000 - ‚Ç¶50,000"),
        ("50000+", "‚Ç¶50,000 & Above")
    };

    private bool IsValidPriceRange => 
        minPrice.HasValue && 
        maxPrice.HasValue && 
        minPrice.Value >= 0 && 
        maxPrice.Value > minPrice.Value;

    protected override async Task OnInitializedAsync()
    {
        await LoadFiltersAsync();
    }

    private async Task LoadFiltersAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            categories = await CategoryService.GetTopLevelCategoriesAsync();
            
            var brandModels = await BrandService.GetAllBrandsAsync();
            allBrands = brandModels
                .Where(b => b.IsActive && b.ProductCount > 0)
                .Select(b => b.Name)
                .Distinct()
                .OrderBy(b => b)
                .ToList();

            Logger.LogInformation("Loaded {CategoryCount} categories and {BrandCount} brands", 
                categories.Count, allBrands.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load filters");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void HandleCategoryClick(string categorySlug)
    {
        selectedCategory = categorySlug;
    }

    private void HandleMinPriceChange(string value)
    {
        minPrice = decimal.TryParse(value, out var parsed) ? parsed : null;
    }

    private void HandleMaxPriceChange(string value)
    {
        maxPrice = decimal.TryParse(value, out var parsed) ? parsed : null;
    }

    private void HandleBrandChange(ChangeEventArgs e)
    {
        var brand = e.Value?.ToString();
        if (!string.IsNullOrEmpty(brand) && !selectedBrands.Contains(brand))
        {
            selectedBrands.Add(brand);
            AddBrandFilter(brand);
        }
    }

    private void AddBrandFilter(string brand)
    {
        if (ShopPage == null) return;

        ShopPage.AddFilter(new FilterTag
        {
            Id = $"brand-{brand}",
            DisplayText = brand,
            FilterType = FilterType.Brand,
            BrandName = brand
        });
    }

    private void RemoveBrand(string brand)
    {
        selectedBrands.Remove(brand);
        
        if (ShopPage != null)
        {
            ShopPage.RemoveFilter($"brand-{brand}");
        }
    }

    private void ApplyPriceFilter()
    {
        if (!IsValidPriceRange || ShopPage == null) return;

        selectedPriceRange = "custom";
        
        ShopPage.AddFilter(new FilterTag
        {
            Id = "price-custom",
            DisplayText = $"‚Ç¶{minPrice:N0} - ‚Ç¶{maxPrice:N0}",
            FilterType = FilterType.PriceRange,
            MinPrice = minPrice,
            MaxPrice = maxPrice
        });
    }

    private void SelectPriceRange(string range)
    {
        if (ShopPage == null) return;

        if (selectedPriceRange == range)
        {
            selectedPriceRange = "";
            ShopPage.RemoveFilter("price-range");
            return;
        }

        selectedPriceRange = range;
        
        var parts = range.Split('-');
        if (parts.Length == 2)
        {
            minPrice = decimal.Parse(parts[0]);
            maxPrice = parts[1].Contains("+") ? null : decimal.Parse(parts[1]);
        }

        var displayText = maxPrice.HasValue 
            ? $"‚Ç¶{minPrice:N0} - ‚Ç¶{maxPrice:N0}" 
            : $"‚Ç¶{minPrice:N0}+";

        ShopPage.AddFilter(new FilterTag
        {
            Id = "price-range",
            DisplayText = displayText,
            FilterType = FilterType.PriceRange,
            MinPrice = minPrice,
            MaxPrice = maxPrice
        });
    }

    private void ToggleRating(int rating)
    {
        if (ShopPage == null) return;

        if (selectedRatings.Contains(rating))
        {
            selectedRatings.Remove(rating);
            ShopPage.RemoveFilter($"rating-{rating}");
        }
        else
        {
            selectedRatings.Add(rating);
            ShopPage.AddFilter(new FilterTag
            {
                Id = $"rating-{rating}",
                DisplayText = $"{rating}+ Stars",
                FilterType = FilterType.Rating,
                MinRating = rating
            });
        }
    }

    private void ToggleInStock()
    {
        if (ShopPage == null) return;

        inStockOnly = !inStockOnly;
        
        if (inStockOnly)
        {
            ShopPage.AddFilter(new FilterTag
            {
                Id = "in-stock",
                DisplayText = "In Stock",
                FilterType = FilterType.InStock
            });
        }
        else
        {
            ShopPage.RemoveFilter("in-stock");
        }
    }

    private void ToggleOnSale()
    {
        if (ShopPage == null) return;

        onSaleOnly = !onSaleOnly;
        
        if (onSaleOnly)
        {
            ShopPage.AddFilter(new FilterTag
            {
                Id = "on-sale",
                DisplayText = "On Sale",
                FilterType = FilterType.OnSale
            });
        }
        else
        {
            ShopPage.RemoveFilter("on-sale");
        }
    }

    private void ClearAllFilters()
    {
        selectedCategory = "all";
        minPrice = null;
        maxPrice = null;
        selectedPriceRange = "";
        selectedRatings.Clear();
        selectedBrands.Clear();
        inStockOnly = false;
        onSaleOnly = false;

        ShopPage?.ClearAllFilters();
    }
}
