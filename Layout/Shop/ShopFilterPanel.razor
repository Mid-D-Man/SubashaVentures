@inject CategoryService CategoryService
@inject BrandService BrandService

<div class="filter-panel @(IsOpen ? "open" : "")">
    <div class="filter-header">
        <h3>Filters</h3>
        <button class="close-btn" @onclick="() => IsOpen = false">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="filter-content">
        <!-- Search Bar -->
        <div class="filter-section search-section">
            <InputField 
                @bind-Value="SearchQuery"
                Placeholder="Search products..."
                Type="text"
                OnInput="OnSearchInput"
                Icon="fa-search" />
        </div>

        <!-- Price Range -->
        <div class="filter-section">
            <h4>Price Range</h4>
            <div class="price-inputs">
                <InputField 
                    @bind-Value="MinPrice"
                    Placeholder="Min"
                    Type="number"
                    OnInput="OnPriceChange" />
                <span>-</span>
                <InputField 
                    @bind-Value="MaxPrice"
                    Placeholder="Max"
                    Type="number"
                    OnInput="OnPriceChange" />
            </div>
        </div>

        <!-- Categories -->
        <div class="filter-section">
            <h4>Categories</h4>
            <div class="filter-options">
                @foreach (var category in Categories)
                {
                    <label class="filter-checkbox">
                        <input type="checkbox" 
                               checked="@SelectedCategories.Contains(category.Id)"
                               @onchange="() => ToggleCategory(category.Id)" />
                        <span>@category.Name</span>
                    </label>
                }
            </div>
        </div>

        <!-- Brands -->
        <div class="filter-section">
            <h4>Brands</h4>
            <div class="filter-options">
                @foreach (var brand in Brands)
                {
                    <label class="filter-checkbox">
                        <input type="checkbox" 
                               checked="@SelectedBrands.Contains(brand.Id)"
                               @onchange="() => ToggleBrand(brand.Id)" />
                        <span>@brand.Name</span>
                    </label>
                }
            </div>
        </div>

        <!-- Rating -->
        <div class="filter-section">
            <h4>Rating</h4>
            <div class="filter-options">
                @for (int i = 5; i >= 1; i--)
                {
                    var rating = i;
                    <label class="filter-checkbox">
                        <input type="radio" 
                               name="rating" 
                               checked="@(MinRating == rating)"
                               @onchange="() => OnRatingChange(rating)" />
                        <span>
                            @for (int j = 0; j < rating; j++)
                            {
                                <i class="fas fa-star"></i>
                            }
                            & Up
                        </span>
                    </label>
                }
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="filter-actions">
            <button class="btn-clear" @onclick="ClearFilters">
                Clear All
            </button>
            <button class="btn-apply" @onclick="ApplyFilters">
                Apply Filters
            </button>
        </div>
    </div>
</div>

@if (IsOpen)
{
    <div class="filter-overlay" @onclick="() => IsOpen = false"></div>
}

@code {
    [Parameter] public EventCallback<FilterOptions> OnFilterChange { get; set; }
    [Parameter] public bool IsOpen { get; set; }

    private List<Category> Categories = new();
    private List<Brand> Brands = new();
    
    private string SearchQuery = "";
    private string MinPrice = "";
    private string MaxPrice = "";
    private HashSet<int> SelectedCategories = new();
    private HashSet<int> SelectedBrands = new();
    private int? MinRating = null;

    protected override async Task OnInitializedAsync()
    {
        Categories = await CategoryService.GetAllCategoriesAsync();
        Brands = await BrandService.GetAllBrandsAsync();
    }

    private async Task OnSearchInput()
    {
        await ApplyFilters();
    }

    private async Task OnPriceChange()
    {
        await ApplyFilters();
    }

    private void ToggleCategory(int categoryId)
    {
        if (SelectedCategories.Contains(categoryId))
            SelectedCategories.Remove(categoryId);
        else
            SelectedCategories.Add(categoryId);
    }

    private void ToggleBrand(int brandId)
    {
        if (SelectedBrands.Contains(brandId))
            SelectedBrands.Remove(brandId);
        else
            SelectedBrands.Add(brandId);
    }

    private void OnRatingChange(int rating)
    {
        MinRating = rating;
    }

    private async Task ApplyFilters()
    {
        var filterOptions = new FilterOptions
        {
            SearchQuery = SearchQuery,
            MinPrice = string.IsNullOrWhiteSpace(MinPrice) ? null : decimal.Parse(MinPrice),
            MaxPrice = string.IsNullOrWhiteSpace(MaxPrice) ? null : decimal.Parse(MaxPrice),
            CategoryIds = SelectedCategories.ToList(),
            BrandIds = SelectedBrands.ToList(),
            MinRating = MinRating
        };

        await OnFilterChange.InvokeAsync(filterOptions);
    }

    private async Task ClearFilters()
    {
        SearchQuery = "";
        MinPrice = "";
        MaxPrice = "";
        SelectedCategories.Clear();
        SelectedBrands.Clear();
        MinRating = null;
        
        await ApplyFilters();
    }
}

