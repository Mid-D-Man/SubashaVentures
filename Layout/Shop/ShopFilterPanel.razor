@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Services.Categories
@using SubashaVentures.Services.Brands
@inject ICategoryService CategoryService
@inject IBrandService BrandService

<div class="filter-overlay @(IsOpen ? "active" : "")" @onclick="Close">
    <div class="filter-panel @(IsOpen ? "active" : "")" @onclick:stopPropagation>
        <div class="panel-header">
            <h3>Filters</h3>
            <button class="close-btn" @onclick="Close">âœ•</button>
        </div>

        <div class="panel-body">
            @if (isLoading)
            {
                <div class="loading">Loading filters...</div>
            }
            else
            {
                <!-- Categories -->
                <div class="filter-group">
                    <h4>Categories</h4>
                    <div class="filter-list">
                        @foreach (var category in categories)
                        {
                            <label class="filter-item">
                                <input type="checkbox" 
                                       checked="@selectedCategories.Contains(category.Id)"
                                       @onchange="@(() => ToggleCategory(category.Id))" />
                                <span>@category.Name</span>
                                <span class="count">(@category.ProductCount)</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Brands -->
                <div class="filter-group">
                    <h4>Brands</h4>
                    <InputField 
                        Type="text"
                        Placeholder="Search brands..."
                        Value="@brandSearch"
                        ValueChanged="@((string val) => brandSearch = val)"
                        Size="InputField.InputSize.Small" />
                    <div class="filter-list">
                        @foreach (var brand in FilteredBrands.Take(10))
                        {
                            <label class="filter-item">
                                <input type="checkbox" 
                                       checked="@selectedBrands.Contains(brand.Name)"
                                       @onchange="@(() => ToggleBrand(brand.Name))" />
                                <span>@brand.Name</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Price Range -->
                <div class="filter-group">
                    <h4>Price Range</h4>
                    <div class="price-inputs">
                        <InputField 
                            Type="number"
                            Placeholder="Min"
                            Value="@(minPrice?.ToString() ?? "")"
                            ValueChanged="@((string val) => minPrice = decimal.TryParse(val, out var p) ? p : null)"
                            Size="InputField.InputSize.Small" />
                        <span>-</span>
                        <InputField 
                            Type="number"
                            Placeholder="Max"
                            Value="@(maxPrice?.ToString() ?? "")"
                            ValueChanged="@((string val) => maxPrice = decimal.TryParse(val, out var p) ? p : null)"
                            Size="InputField.InputSize.Small" />
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="filter-group">
                    <h4>Quick Filters</h4>
                    <label class="filter-item">
                        <input type="checkbox" 
                               checked="@inStockOnly"
                               @onchange="@(() => inStockOnly = !inStockOnly)" />
                        <span>In Stock Only</span>
                    </label>
                    <label class="filter-item">
                        <input type="checkbox" 
                               checked="@onSaleOnly"
                               @onchange="@(() => onSaleOnly = !onSaleOnly)" />
                        <span>On Sale</span>
                    </label>
                </div>
            }
        </div>

        <div class="panel-footer">
            <button class="clear-btn" @onclick="ClearFilters">Clear All</button>
            <button class="apply-btn" @onclick="ApplyFilters">Apply</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<FilterState> OnApply { get; set; }

    private bool isLoading = true;
    private List<CategoryViewModel> categories = new();
    private List<BrandModel> brands = new();
    private string brandSearch = "";

    private HashSet<string> selectedCategories = new();
    private HashSet<string> selectedBrands = new();
    private decimal? minPrice;
    private decimal? maxPrice;
    private bool inStockOnly;
    private bool onSaleOnly;

    private IEnumerable<BrandModel> FilteredBrands =>
        string.IsNullOrWhiteSpace(brandSearch)
            ? brands
            : brands.Where(b => b.Name.Contains(brandSearch, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadFilters();
    }

    private async Task LoadFilters()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            categories = await CategoryService.GetTopLevelCategoriesAsync();
            var allBrands = await BrandService.GetAllBrandsAsync();
            brands = allBrands.Where(b => b.IsActive && b.ProductCount > 0).ToList();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleCategory(string id)
    {
        if (selectedCategories.Contains(id))
            selectedCategories.Remove(id);
        else
            selectedCategories.Add(id);
    }

    private void ToggleBrand(string name)
    {
        if (selectedBrands.Contains(name))
            selectedBrands.Remove(name);
        else
            selectedBrands.Add(name);
    }

    private void ClearFilters()
    {
        selectedCategories.Clear();
        selectedBrands.Clear();
        minPrice = null;
        maxPrice = null;
        inStockOnly = false;
        onSaleOnly = false;
    }

    private async Task ApplyFilters()
    {
        var state = new FilterState
        {
            Categories = selectedCategories.ToList(),
            Brands = selectedBrands.ToList(),
            MinPrice = minPrice,
            MaxPrice = maxPrice,
            InStockOnly = inStockOnly,
            OnSaleOnly = onSaleOnly
        };

        await OnApply.InvokeAsync(state);
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    public class FilterState
    {
        public List<string> Categories { get; set; } = new();
        public List<string> Brands { get; set; } = new();
        public decimal? MinPrice { get; set; }
        public decimal? MaxPrice { get; set; }
        public bool InStockOnly { get; set; }
        public bool OnSaleOnly { get; set; }
    }
}
