@using SubashaVentures.Domain.Product
@using SubashaVentures.Models.Firebase

<div class="shop-filter-panel @CssClass">
    <h2 class="filter-title">Filters</h2>

    @* Categories Section *@
    <div class="filter-section">
        <h3 class="section-title">CATEGORIES</h3>
        <div class="filter-options">
            @foreach (var category in Categories)
            {
                <label class="filter-checkbox">
                    <input type="checkbox" 
                           checked="@SelectedCategories.Contains(category)"
                           @onchange="@(e => HandleCategoryToggle(category))" />
                    <span class="checkbox-label">@category</span>
                </label>
            }
        </div>
    </div>

    @* Brands Section *@
    <div class="filter-section">
        <h3 class="section-title">BRANDS</h3>
        <div class="filter-options">
            @foreach (var brand in Brands)
            {
                <label class="filter-checkbox">
                    <input type="checkbox" 
                           checked="@SelectedBrands.Contains(brand)"
                           @onchange="@(e => HandleBrandToggle(brand))" />
                    <span class="checkbox-label">@brand</span>
                </label>
            }
        </div>
    </div>

    @* Rating Filter Section *@
    <div class="filter-section">
        <h3 class="section-title">MINIMUM RATING</h3>
        <div class="rating-options">
            @foreach (var rating in new[] { 4, 3, 2, 1 })
            {
                <button class="rating-button @(MinRating == rating ? "active" : "")"
                        @onclick="@(() => SetMinRating(rating))">
                    <div class="rating-stars">
                        @for (int i = 0; i < 5; i++)
                        {
                            <span class="star @(i < rating ? "filled" : "")">â˜…</span>
                        }
                    </div>
                    <span class="rating-text">& Up</span>
                </button>
            }
        </div>
    </div>

    @* Price Range Section *@
    <div class="filter-section">
        <h3 class="section-title">PRICE RANGE</h3>
        <div class="price-range-container">
            <input type="range" 
                   class="price-slider" 
                   min="0" 
                   max="500" 
                   step="10"
                   value="@PriceRange[0]"
                   @oninput="@(e => UpdateMinPrice(e))" />
            <input type="range" 
                   class="price-slider" 
                   min="0" 
                   max="500" 
                   step="10"
                   value="@PriceRange[1]"
                   @oninput="@(e => UpdateMaxPrice(e))" />
            <div class="price-labels">
                <span class="price-label">$@PriceRange[0]</span>
                <span class="price-separator">to</span>
                <span class="price-label">$@PriceRange[1]</span>
            </div>
        </div>
    </div>

    @* Other Filters Section *@
    <div class="filter-section">
        <h3 class="section-title">OTHER FILTERS</h3>
        <div class="filter-options">
            <label class="filter-checkbox">
                <input type="checkbox" 
                       checked="@OnSale"
                       @onchange="@(e => OnSale = (bool)(e.Value ?? false))" />
                <span class="checkbox-label">On Sale</span>
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" 
                       checked="@FreeShipping"
                       @onchange="@(e => FreeShipping = (bool)(e.Value ?? false))" />
                <span class="checkbox-label">Free Shipping</span>
            </label>
        </div>
    </div>

    @* Action Buttons *@
    <div class="filter-actions">
        <button class="btn-apply" @onclick="HandleApplyFilters">
            Apply Filters
        </button>
        <button class="btn-reset" @onclick="HandleResetFilters">
            Reset Filters
        </button>
    </div>
</div>

@code {
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public EventCallback<FilterState> OnFiltersChange { get; set; }

    private List<string> Categories { get; set; } = new()
    {
        "Women Shoes", "Men Shoes", "Lifestyle", "Skateboarding", "Running", "Sports"
    };

    private List<string> Brands { get; set; } = new()
    {
        "Nike", "Adidas", "Puma", "New Balance", "Converse", "Vans", "Reebok"
    };

    private List<string> SelectedCategories { get; set; } = new();
    private List<string> SelectedBrands { get; set; } = new();
    private int MinRating { get; set; } = 0;
    private int[] PriceRange { get; set; } = new[] { 0, 500 };
    private bool OnSale { get; set; }
    private bool FreeShipping { get; set; }

    private void HandleCategoryToggle(string category)
    {
        if (SelectedCategories.Contains(category))
            SelectedCategories.Remove(category);
        else
            SelectedCategories.Add(category);
    }

    private void HandleBrandToggle(string brand)
    {
        if (SelectedBrands.Contains(brand))
            SelectedBrands.Remove(brand);
        else
            SelectedBrands.Add(brand);
    }

    private void SetMinRating(int rating)
    {
        MinRating = MinRating == rating ? 0 : rating;
    }

    private void UpdateMinPrice(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            PriceRange[0] = Math.Min(value, PriceRange[1]);
        }
    }

    private void UpdateMaxPrice(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            PriceRange[1] = Math.Max(value, PriceRange[0]);
        }
    }

    private async Task HandleApplyFilters()
    {
        var filterState = new FilterState
        {
            Categories = SelectedCategories,
            Brands = SelectedBrands,
            MinRating = MinRating,
            PriceRange = PriceRange,
            OnSale = OnSale,
            FreeShipping = FreeShipping
        };

        if (OnFiltersChange.HasDelegate)
        {
            await OnFiltersChange.InvokeAsync(filterState);
        }
    }

    private async Task HandleResetFilters()
    {
        SelectedCategories.Clear();
        SelectedBrands.Clear();
        MinRating = 0;
        PriceRange = new[] { 0, 500 };
        OnSale = false;
        FreeShipping = false;

        await HandleApplyFilters();
    }

    public class FilterState
    {
        public List<string> Categories { get; set; } = new();
        public List<string> Brands { get; set; } = new();
        public int MinRating { get; set; }
        public int[] PriceRange { get; set; } = new[] { 0, 500 };
        public bool OnSale { get; set; }
        public bool FreeShipping { get; set; }
    }
}
