@inherits LayoutComponentBase
@using SubashaVentures.Services.Cart
@using SubashaVentures.Services.Auth
@using SubashaVentures.Services.Supabase
@inject NavigationManager NavigationManager
@inject ShopStateService ShopState
@inject ICartService CartService
@inject SupabaseAuthService AuthService

<div class="shop-layout-wrapper">
    @* Top Navigation - Uses ShopStateService *@
    <ShopTop CartItemCount="@CartItemCount" OnSearchChanged="HandleSearchFromNav" />

    @* Main Shop Container *@
    <div class="shop-container">
        
        @* Desktop Filter Sidebar (Left - 30%) *@
        <aside class="shop-sidebar desktop-only">
            <ShopFilterPanel OnFiltersChanged="HandleFiltersFromSidebar" />
        </aside>

        @* Main Shop Content (Right - 70%) *@
        <main class="shop-content">
            @Body
        </main>
    </div>
</div>

@code {
    private int CartItemCount { get; set; } = 0;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // Get current user and cart count
        await LoadCartCountAsync();
    }

    private async Task LoadCartCountAsync()
    {
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user != null)
            {
                currentUserId = user.Id;
                CartItemCount = await CartService.GetCartItemCountAsync(currentUserId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cart count: {ex.Message}");
        }
    }

    private async Task HandleSearchFromNav(string query)
    {
        await ShopState.NotifySearchChanged(query);
    }

    private async Task HandleFiltersFromSidebar(FilterState filters)
    {
        await ShopState.NotifyFiltersChanged(filters);
    }
}
