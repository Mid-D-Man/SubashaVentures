@* Layout/Main/SidePanel.razor *@
@using SubashaVentures.Components.Shared.Buttons
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="side-panel-overlay @(IsOpen ? "active" : "")" @onclick="HandleOverlayClick">
    <div class="side-panel @(IsOpen ? "active" : "")" @onclick:stopPropagation="true">
        <div class="panel-content">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-icon">SV</span>
                    <span class="panel-brand">SubashaVentures</span>
                </div>
                <button class="panel-close" @onclick="ClosePanel" aria-label="Close menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M18 6L6 18M6 6L18 18" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>

            @if (IsLoggedIn)
            {
                <div class="user-profile-section">
                    <div class="user-profile-card">
                        <div class="user-avatar-large">
                            @UserName.Substring(0, 1).ToUpper()
                        </div>
                        <div class="user-info-text">
                            <span class="user-name-display">@UserName</span>
                            <span class="user-email-display">@UserEmail</span>
                        </div>
                    </div>
                </div>
            }

            <div class="panel-nav">
                @if (IsLoggedIn)
                {
                    <div class="nav-section">
                        <h4 class="section-title">My Account</h4>
                        <a class="nav-link" @onclick="() => NavigateTo(ProfileDirectory)">
                            <span class="nav-text">Profile Settings</span>
                        </a>
                        <a class="nav-link" @onclick="() => NavigateTo(OrdersDirectory)">
                            <span class="nav-text">My Orders</span>
                        </a>
                        <a class="nav-link" @onclick="() => NavigateTo(WishlistDirectory)">
                            <span class="nav-text">Wishlist</span>
                        </a>
                    </div>
                }

                <div class="nav-section">
                    <h4 class="section-title">Shop</h4>
                    <a class="nav-link" @onclick="() => NavigateTo(HomeDirectory)">
                        <span class="nav-text">Home</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(ShopDirectory)">
                        <span class="nav-text">All Products</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(DealsDirectory)">
                        <span class="nav-text">Deals & Sales</span>
                    </a>
                </div>

                <div class="nav-section">
                    <h4 class="section-title">Categories</h4>
                    <a class="nav-link" @onclick="() => NavigateTo(MenDirectory)">
                        <span class="nav-text">Men's Fashion</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(WomenDirectory)">
                        <span class="nav-text">Women's Fashion</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(KidsDirectory)">
                        <span class="nav-text">Kids & Baby</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(HomeGoodsDirectory)">
                        <span class="nav-text">Home & Living</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(AccessoriesDirectory)">
                        <span class="nav-text">Accessories</span>
                    </a>
                </div>

                <div class="nav-section">
<h4 class="section-title">Support</h4>
<a class="nav-link" @onclick="() => NavigateTo(AboutDirectory)">
<span class="nav-text">About Us</span>
</a>
<a class="nav-link" @onclick="() => NavigateTo(ContactDirectory)">
<span class="nav-text">Contact</span>
</a>
<a class="nav-link" @onclick="() => NavigateTo(HelpDirectory)">
<span class="nav-text">Help Center</span>
</a>
<a class="nav-link" @onclick="() => NavigateTo(TrackOrderDirectory)">
<span class="nav-text">Track Orders</span>
</a>
</div>
</div><div class="panel-actions">
            @if (IsLoggedIn)
            {
                <button class="action-btn sign-out" @onclick="HandleLogout">
                    <span class="btn-text">Sign Out</span>
                </button>
            }
            else
            {
                <button class="action-btn sign-in" @onclick="HandleSignIn">
                    <span class="btn-text">Sign In</span>
                </button>
                <button class="action-btn sign-up" @onclick="HandleSignUp">
                    <span class="btn-text">Sign Up</span>
                </button>
            }
        </div>
    </div>
</div></div>
@code {
private const string HomeDirectory = "";
private const string ShopDirectory = "shop";
private const string DealsDirectory = "shop/deals";
private const string MenDirectory = "shop/men";
private const string WomenDirectory = "shop/women";
private const string KidsDirectory = "shop/kids";
private const string HomeGoodsDirectory = "shop/home";
private const string AccessoriesDirectory = "shop/accessories";
private const string AboutDirectory = "about";
private const string ContactDirectory = "contact";
private const string HelpDirectory = "help";
private const string TrackOrderDirectory = "orders/track";
private const string ProfileDirectory = "profile";
private const string OrdersDirectory = "orders";
private const string WishlistDirectory = "wishlist";
private const string SignInDirectory = "signin";
private const string SignUpDirectory = "signup";[Parameter] public bool IsOpen { get; set; } = false;
[Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
[Parameter] public bool IsLoggedIn { get; set; } = false;
[Parameter] public string UserName { get; set; } = "";
[Parameter] public string UserEmail { get; set; } = "";
[Parameter] public EventCallback<ActionType> OnActionClick { get; set; }
[Parameter] public EventCallback<string> OnNavigate { get; set; }

public enum ActionType
{
    SignIn,
    SignUp,
    Profile,
    Logout
}

protected override async Task OnInitializedAsync()
{
    await CheckAuthStatus();
}

private async Task CheckAuthStatus()
{
    try
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        IsLoggedIn = user?.Identity?.IsAuthenticated ?? false;
        
        if (IsLoggedIn)
        {
            UserEmail = user?.FindFirst("email")?.Value ?? "";
            var firstName = user?.FindFirst("given_name")?.Value ?? "";
            var lastName = user?.FindFirst("family_name")?.Value ?? "";
            UserName = !string.IsNullOrEmpty(firstName) ? $"{firstName} {lastName}".Trim() : UserEmail.Split('@')[0];
        }
        
        StateHasChanged();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error checking auth status: {ex.Message}");
    }
}

private async Task ClosePanel()
{
    IsOpen = false;
    await IsOpenChanged.InvokeAsync(IsOpen);
}

private async Task HandleOverlayClick()
{
    await ClosePanel();
}

private async Task NavigateTo(string url)
{
    await ClosePanel();
    NavigationManager.NavigateTo(url);
    
    if (OnNavigate.HasDelegate)
    {
        await OnNavigate.InvokeAsync(url);
    }
}

private async Task HandleSignIn()
{
    await ClosePanel();
    NavigationManager.NavigateTo(SignInDirectory);
    
    if (OnActionClick.HasDelegate)
    {
        await OnActionClick.InvokeAsync(ActionType.SignIn);
    }
}

private async Task HandleSignUp()
{
    await ClosePanel();
    NavigationManager.NavigateTo(SignUpDirectory);
    
    if (OnActionClick.HasDelegate)
    {
        await OnActionClick.InvokeAsync(ActionType.SignUp);
    }
}

private async Task HandleLogout()
{
    await ClosePanel();
    
    if (OnActionClick.HasDelegate)
    {
        await OnActionClick.InvokeAsync(ActionType.Logout);
    }
}}
