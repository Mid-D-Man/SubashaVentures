@using SubashaVentures.Components.Shared.Buttons
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using SubashaVentures.Services.Categories
@using SubashaVentures.Services.Storage
@using SubashaVentures.Domain.Product
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ICategoryService CategoryService
@inject IBlazorAppLocalStorageService LocalStorage

<div class="side-panel-overlay @(IsOpen ? "active" : "")" @onclick="HandleOverlayClick">
    <div class="side-panel @(IsOpen ? "active" : "")" @onclick:stopPropagation="true">
        <div class="panel-content">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-icon">SV</span>
                    <span class="panel-brand">SubashaVentures</span>
                </div>
                <button class="panel-close" @onclick="ClosePanel" aria-label="Close menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M18 6L6 18M6 6L18 18" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>

            @if (isAuthenticated)
            {
                <div class="user-profile-section">
                    <div class="user-profile-card">
                        <div class="user-avatar-large">
                            @GetUserInitial()
                        </div>
                        <div class="user-info-text">
                            <span class="user-name-display">@userName</span>
                            <span class="user-email-display">@userEmail</span>
                        </div>
                    </div>
                </div>
            }

            <div class="panel-nav">
                @if (isAuthenticated)
                {
                    <div class="nav-section">
                        <h4 class="section-title">My Account</h4>
                        <a class="nav-link" @onclick="() => NavigateTo(UserDirectory)">
                            <span class="nav-text">Me</span>
                        </a>
                        <a class="nav-link" @onclick="() => NavigateTo(ProfileDirectory)">
                            <span class="nav-text">Profile Settings</span>
                        </a>
                        <a class="nav-link" @onclick="() => NavigateTo(OrdersDirectory)">
                            <span class="nav-text">My Orders</span>
                        </a>
                        <a class="nav-link" @onclick="() => NavigateTo(WishlistDirectory)">
                            <span class="nav-text">Wishlist</span>
                        </a>
                    </div>
                }

                <div class="nav-section">
                    <h4 class="section-title">Shop</h4>
                    <a class="nav-link" @onclick="() => NavigateTo(HomeDirectory)">
                        <span class="nav-text">Home</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(ShopDirectory)">
                        <span class="nav-text">All Products</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(DealsDirectory)">
                        <span class="nav-text">Deals & Sales</span>
                    </a>
                </div>

                <div class="nav-section">
                    <h4 class="section-title">Categories</h4>
                    
                    @if (IsLoadingCategories)
                    {
                        <div class="category-loading">
                            <div class="loading-spinner-small"></div>
                            <span class="loading-text">Loading categories...</span>
                        </div>
                    }
                    else if (TopCategories.Any())
                    {
                        @foreach (var category in TopCategories)
                        {
                            <a class="nav-link" @onclick="() => NavigateToShopWithCategory(category)">
                                @if (!string.IsNullOrEmpty(category.IconEmoji))
                                {
                                    <span class="category-icon">@category.IconEmoji</span>
                                }
                                <span class="nav-text">@category.Name</span>
                            </a>
                        }
                        
                        @if (HasMoreCategories)
                        {
                            <a class="nav-link view-all-link" @onclick="() => NavigateTo(ShopDirectory)">
                                <span class="nav-text">View All Categories</span>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="category-empty">
                            <span class="empty-text">No categories available</span>
                        </div>
                    }
                </div>

                <div class="nav-section">
                    <h4 class="section-title">Support</h4>
                    <a class="nav-link" @onclick="() => NavigateTo(AboutDirectory)">
                        <span class="nav-text">About Us</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(ContactDirectory)">
                        <span class="nav-text">Contact</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(HelpDirectory)">
                        <span class="nav-text">Help Center</span>
                    </a>
                    <a class="nav-link" @onclick="() => NavigateTo(TrackOrderDirectory)">
                        <span class="nav-text">Track Orders</span>
                    </a>
                </div>
            </div>

            <div class="panel-actions">
                @if (isAuthenticated)
                {
                    <button class="action-btn sign-out" @onclick="HandleLogout">
                        <span class="btn-text">Sign Out</span>
                    </button>
                }
                else
                {
                    <button class="action-btn sign-in" @onclick="HandleSignIn">
                        <span class="btn-text">Sign In</span>
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private const string HomeDirectory = "";
    private const string ShopDirectory = "shop";
    private const string DealsDirectory = "shop/deals";
    private const string AboutDirectory = "about";
    private const string ContactDirectory = "contact";
    private const string HelpDirectory = "help";
    private const string TrackOrderDirectory = "orders/track";
    private const string UserDirectory = "user";
    private const string ProfileDirectory = "user/settings";
    private const string OrdersDirectory = "user/orders";
    private const string WishlistDirectory = "wishlist";
    private const string SignInDirectory = "signin";
    private const string SignUpDirectory = "signup";
    
    private const int MAX_CATEGORIES_TO_SHOW = 4;
    private const string CATEGORY_FILTER_KEY = "shop_category_filter";

    [Parameter] public bool IsOpen { get; set; } = false;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback<ActionType> OnActionClick { get; set; }
    [Parameter] public EventCallback<string> OnNavigate { get; set; }

    private bool isAuthenticated = false;
    private string userName = "";
    private string userEmail = "";
    
    private List<CategoryViewModel> TopCategories = new();
    private bool IsLoadingCategories = true;
    private bool HasMoreCategories = false;

    public enum ActionType
    {
        SignIn,
        SignUp,
        Profile,
        Logout
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthenticationState();
        await LoadTopCategories();
        
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen)
        {
            // ✅ FIXED: Reload auth state when panel opens
            await LoadAuthenticationState();
            
            if (!TopCategories.Any() && !IsLoadingCategories)
            {
                await LoadTopCategories();
            }
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await LoadAuthenticationState();
    }

    private async Task LoadAuthenticationState()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            isAuthenticated = user?.Identity?.IsAuthenticated ?? false;
            
            if (isAuthenticated)
            {
                userEmail = user?.FindFirst(ClaimTypes.Email)?.Value ?? "";
                var firstName = user?.FindFirst(ClaimTypes.GivenName)?.Value ?? "";
                var lastName = user?.FindFirst(ClaimTypes.Surname)?.Value ?? "";
                
                userName = !string.IsNullOrEmpty(firstName) 
                    ? $"{firstName} {lastName}".Trim() 
                    : userEmail.Split('@')[0];
                
                Console.WriteLine($"✓ SidePanel: User authenticated - {userEmail}");
            }
            else
            {
                userName = "";
                userEmail = "";
                Console.WriteLine("ℹ️ SidePanel: User not authenticated");
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ SidePanel: Error loading auth state - {ex.Message}");
            isAuthenticated = false;
            userName = "";
            userEmail = "";
        }
    }

    private string GetUserInitial()
    {
        if (string.IsNullOrEmpty(userName)) return "?";
        return userName.Substring(0, 1).ToUpper();
    }

    private async Task LoadTopCategories()
    {
        IsLoadingCategories = true;
        StateHasChanged();
        
        try
        {
            var allCategories = await CategoryService.GetTopLevelCategoriesAsync();
            
            if (allCategories != null && allCategories.Any())
            {
                TopCategories = allCategories
                    .Take(MAX_CATEGORIES_TO_SHOW)
                    .ToList();
                
                HasMoreCategories = allCategories.Count > MAX_CATEGORIES_TO_SHOW;
                
                Console.WriteLine($"✓ Loaded {TopCategories.Count} categories for side panel");
            }
            else
            {
                TopCategories = new List<CategoryViewModel>();
                HasMoreCategories = false;
                Console.WriteLine("⚠ No categories found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading categories: {ex.Message}");
            TopCategories = new List<CategoryViewModel>();
            HasMoreCategories = false;
        }
        finally
        {
            IsLoadingCategories = false;
            StateHasChanged();
        }
    }

    private async Task NavigateToShopWithCategory(CategoryViewModel category)
    {
        try
        {
            await LocalStorage.SetItemAsync(CATEGORY_FILTER_KEY, category.Name);
            Console.WriteLine($"✓ Stored category filter: {category.Name}");
            
            await ClosePanel();
            NavigationManager.NavigateTo(ShopDirectory);
            
            if (OnNavigate.HasDelegate)
            {
                await OnNavigate.InvokeAsync(ShopDirectory);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error navigating with category: {ex.Message}");
            await ClosePanel();
            NavigationManager.NavigateTo(ShopDirectory);
        }
    }

    private async Task ClosePanel()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private async Task HandleOverlayClick()
    {
        await ClosePanel();
    }

    private async Task NavigateTo(string url)
    {
        await ClosePanel();
        NavigationManager.NavigateTo(url);
        
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync(url);
        }
    }

    private async Task HandleSignIn()
    {
        await ClosePanel();
        NavigationManager.NavigateTo(SignInDirectory);
        
        if (OnActionClick.HasDelegate)
        {
            await OnActionClick.InvokeAsync(ActionType.SignIn);
        }
    }

    private async Task HandleLogout()
    {
        await ClosePanel();
        
        if (OnActionClick.HasDelegate)
        {
            await OnActionClick.InvokeAsync(ActionType.Logout);
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
