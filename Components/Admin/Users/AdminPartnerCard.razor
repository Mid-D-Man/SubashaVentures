@using SubashaVentures.Models.Supabase
@using SubashaVentures.Components.Shared.Buttons

<div class="admin-partner-card @CssClass @(IsSelected ? "selected" : "")" 
     @onclick="HandleCardClick"
     @onmouseenter="() => isHovered = true"
     @onmouseleave="() => isHovered = false">
    
    <!-- Selection Checkbox -->
    @if (AllowSelection)
    {
        <input type="checkbox" 
               class="partner-checkbox"
               checked="@IsSelected"
               @onclick:stopPropagation="true"
               @onchange="HandleSelectionChange" />
    }

    <!-- Partner Header -->
    <div class="partner-header-section">
        <div class="partner-avatar">
            @GetInitials(Partner.Name)
        </div>
        
        <div class="partner-badges">
            @if (!Partner.IsActive)
            {
                <span class="badge inactive" title="Inactive">‚è∏Ô∏è</span>
            }
            @if (Partner.VerificationStatus == "verified")
            {
                <span class="badge verified" title="Verified">‚úì</span>
            }
            else if (Partner.VerificationStatus == "pending")
            {
                <span class="badge pending" title="Pending Verification">‚è≥</span>
            }
            else if (Partner.VerificationStatus == "rejected")
            {
                <span class="badge rejected" title="Rejected">‚úï</span>
            }
            @if (Partner.PendingPayout >= 10000)
            {
                <span class="badge payout-due" title="Payout Due">üí∞</span>
            }
        </div>

        <!-- Quick Actions Overlay -->
        <div class="quick-actions @(isHovered ? "visible" : "")">
            <button class="action-btn edit" 
                    @onclick="HandleEdit"
                    @onclick:stopPropagation="true"
                    title="Edit Partner">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.49998C18.8978 2.10216 19.4374 1.87866 20 1.87866C20.5626 1.87866 21.1022 2.10216 21.5 2.49998C21.8978 2.89781 22.1213 3.43737 22.1213 3.99998C22.1213 4.56259 21.8978 5.10216 21.5 5.49998L12 15L8 16L9 12L18.5 2.49998Z" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <button class="action-btn delete" 
                    @onclick="HandleDelete"
                    @onclick:stopPropagation="true"
                    title="Delete Partner">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Partner Info -->
    <div class="partner-info-section">
        <div class="partner-name-section">
            <h3 class="partner-name" title="@Partner.Name">@Partner.Name</h3>
            <span class="partner-id">@Partner.UniquePartnerId</span>
        </div>

        @if (!string.IsNullOrEmpty(Partner.CompanyName))
        {
            <div class="company-name">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="3" width="7" height="18" rx="1" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="8" width="7" height="13" rx="1" stroke="currentColor" stroke-width="2"/>
                    <path d="M6 7H7M6 11H7M6 15H7M17 12H18M17 16H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@Partner.CompanyName</span>
            </div>
        }

        <div class="contact-info">
            <div class="contact-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                    <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 6L12 13L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="contact-text">@Partner.Email</span>
            </div>
            
            @if (!string.IsNullOrEmpty(Partner.PhoneNumber))
            {
                <div class="contact-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M22 16.92V19.92C22 20.4696 21.5523 20.9166 21.0026 20.9192C18.4967 20.9408 16.0247 20.2695 13.8131 19.0015C11.7316 17.8174 9.94476 16.1638 8.58176 14.1614C6.53539 11.3793 5.30851 7.97193 5.0786 4.43488C5.04293 3.88507 5.47521 3.42 6.02565 3.42H9.02565C9.55086 3.42 9.98502 3.82463 10.0211 4.34758C10.0894 5.35602 10.2761 6.35141 10.5768 7.31142C10.7247 7.80806 10.5597 8.34747 10.1597 8.67761L8.62789 9.91409C9.94335 12.2209 11.8792 14.1568 14.186 15.4722L15.4225 13.9404C15.7526 13.5404 16.292 13.3754 16.7887 13.5233C17.7487 13.824 18.7441 14.0108 19.7525 14.079C20.2755 14.1151 20.68 14.5493 20.68 15.0745V18.0745C20.68 18.6268 20.2201 19.0868 19.6679 19.0868L22 16.92Z" 
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="contact-text">@Partner.PhoneNumber</span>
                </div>
            }
        </div>

        <!-- Financial Metrics -->
        <div class="metrics-section">
            <div class="metric-item">
                <span class="metric-label">Commission Rate</span>
                <span class="metric-value commission">@Partner.CommissionRate%</span>
            </div>
            
            <div class="metric-item">
                <span class="metric-label">Total Sales</span>
                <span class="metric-value sales">‚Ç¶@Partner.TotalSales.ToString("N0")</span>
            </div>
            
            <div class="metric-item">
                <span class="metric-label">Total Commission</span>
                <span class="metric-value commission-earned">‚Ç¶@Partner.TotalCommission.ToString("N0")</span>
            </div>
            
            <div class="metric-item">
                <span class="metric-label">Pending Payout</span>
                <span class="metric-value payout @(Partner.PendingPayout >= 10000 ? "high" : "")">
                    ‚Ç¶@Partner.PendingPayout.ToString("N0")
                </span>
            </div>
        </div>

        <!-- Product Count -->
        <div class="product-count">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M3 9H21M9 3V9M15 3V9" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>@Partner.TotalProducts product@(Partner.TotalProducts != 1 ? "s" : "")</span>
        </div>

        <!-- Dates -->
        <div class="partner-dates">
            <span class="date-created" title="@Partner.CreatedAt.ToString("MMMM dd, yyyy HH:mm")">
                Created: @GetTimeAgo(Partner.CreatedAt)
            </span>
        </div>
    </div>

    <!-- Actions Footer -->
    <div class="partner-actions-footer">
        <label class="toggle-switch" title="Active Status">
            <input type="checkbox" 
                   checked="@Partner.IsActive"
                   @onchange="HandleToggleActive"
                   @onclick:stopPropagation="true" />
            <span class="toggle-slider"></span>
            <span class="toggle-label">Active</span>
        </label>

        <div class="verification-status @Partner.VerificationStatus">
            @Partner.VerificationStatus
        </div>
    </div>
</div>

@code {
    [Parameter] public PartnerModel Partner { get; set; } = new();
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public bool AllowSelection { get; set; } = true;
    [Parameter] public bool IsSelected { get; set; }
    
    [Parameter] public EventCallback<PartnerModel> OnEdit { get; set; }
    [Parameter] public EventCallback<PartnerModel> OnDelete { get; set; }
    [Parameter] public EventCallback<(PartnerModel partner, bool isActive)> OnToggleActive { get; set; }
    [Parameter] public EventCallback<(Guid partnerId, bool isSelected)> OnSelectionChanged { get; set; }
    [Parameter] public EventCallback<PartnerModel> OnCardClick { get; set; }

    private bool isHovered = false;

    private async Task HandleEdit(MouseEventArgs e)
    {
        if (OnEdit.HasDelegate)
            await OnEdit.InvokeAsync(Partner);
    }

    private async Task HandleDelete(MouseEventArgs e)
    {
        if (OnDelete.HasDelegate)
            await OnDelete.InvokeAsync(Partner);
    }

    private async Task HandleToggleActive(ChangeEventArgs e)
    {
        if (e.Value is bool isActive && OnToggleActive.HasDelegate)
            await OnToggleActive.InvokeAsync((Partner, isActive));
    }

    private async Task HandleSelectionChange(ChangeEventArgs e)
    {
        if (e.Value is bool isSelected && OnSelectionChanged.HasDelegate)
            await OnSelectionChanged.InvokeAsync((Partner.Id, isSelected));
    }

    private async Task HandleCardClick(MouseEventArgs e)
    {
        if (OnCardClick.HasDelegate)
            await OnCardClick.InvokeAsync(Partner);
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "??";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return parts[0].Length >= 2 
            ? parts[0].Substring(0, 2).ToUpper() 
            : parts[0].ToUpper();
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalDays > 365) return $"{(int)(span.TotalDays / 365)}y ago";
        if (span.TotalDays > 30) return $"{(int)(span.TotalDays / 30)}mo ago";
        if (span.TotalDays > 1) return $"{(int)span.TotalDays}d ago";
        if (span.TotalHours > 1) return $"{(int)span.TotalHours}h ago";
        if (span.TotalMinutes > 1) return $"{(int)span.TotalMinutes}m ago";
        return "Just now";
    }
}