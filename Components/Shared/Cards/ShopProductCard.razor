@using SubashaVentures.Domain.Product
@using SubashaVentures.Services.Navigation
@inject INavigationService NavigationService

<div class="shop-product-card @(Product.IsFeatured ? "featured" : "")"
     @onclick="HandleCardClick"
     @onclick:stopPropagation="false">
    
    @* Product Image *@
    <div class="product-image-container">
        <img src="@GetPrimaryImage()" 
             alt="@Product.Name" 
             class="product-image"
             loading="lazy" />
        
        @* Featured Badge *@
        @if (Product.IsFeatured)
        {
            <div class="badge badge-featured">Featured</div>
        }
        
        @* Sale Badge *@
        @if (Product.IsOnSale && Product.Discount > 0)
        {
            <div class="badge badge-sale">@Product.Discount% OFF</div>
        }
    </div>

    @* Product Details *@
    <div class="product-details">
        
        @* Category & Brand *@
        <div class="product-meta">
            <span class="category">@Product.Category.ToUpper()</span>
            @if (!string.IsNullOrEmpty(Product.Brand))
            {
                <span class="separator">•</span>
                <span class="brand">@Product.Brand</span>
            }
        </div>

        @* Product Name & Price *@
        <div class="product-header">
            <h3 class="product-name" title="@Product.Name">
                @Product.Name
            </h3>
            <div class="product-pricing">
                <span class="current-price">@Product.DisplayPrice</span>
                @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                {
                    <span class="original-price">@Product.DisplayOriginalPrice</span>
                }
            </div>
        </div>

        @* Rating *@
        @if (Product.Rating > 0)
        {
            <div class="product-rating">
                <div class="stars">
                    @for (int i = 0; i < 5; i++)
                    {
                        int starIndex = i;
                        <span class="star @(starIndex < Math.Floor(Product.Rating) ? "filled" : "")">
                            ★
                        </span>
                    }
                </div>
                <span class="rating-text">
                    @Product.DisplayRating (@Product.ReviewCount)
                </span>
            </div>
        }

        @* Action Buttons *@
        <div class="product-actions">
            <button class="btn-add-cart @(Product.IsInStock ? "" : "disabled")"
                    @onclick="HandleAddToCart"
                    @onclick:stopPropagation="true"
                    disabled="@(!Product.IsInStock)">
                @if (Product.IsInStock)
                {
                    <text>ADD TO CART</text>
                }
                else
                {
                    <text>OUT OF STOCK</text>
                }
            </button>
            
            <button class="btn-favorite @(IsFavorite ? "active" : "")"
                    @onclick="HandleToggleFavorite"
                    @onclick:stopPropagation="true"
                    title="@(IsFavorite ? "Remove from favorites" : "Add to favorites")">
                <span class="heart-icon">@(IsFavorite ? "♥" : "♡")</span>
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public ProductViewModel Product { get; set; } = null!;
    [Parameter] public EventCallback<int> OnAddToCart { get; set; }
    [Parameter] public EventCallback<int> OnToggleFavorite { get; set; }

    private bool IsFavorite { get; set; }

    private string GetPrimaryImage()
    {
        return Product.Images?.FirstOrDefault() ?? "/diverse-products-still-life.png";
    }

    private void HandleCardClick()
    {
        NavigationService.NavigateTo($"/shop/{Product.Slug}");
    }

    private async Task HandleAddToCart(MouseEventArgs e)
    {
        if (OnAddToCart.HasDelegate && Product.IsInStock)
        {
            await OnAddToCart.InvokeAsync(Product.Id);
        }
    }

    private async Task HandleToggleFavorite(MouseEventArgs e)
    {
        IsFavorite = !IsFavorite;
        
        if (OnToggleFavorite.HasDelegate)
        {
            await OnToggleFavorite.InvokeAsync(Product.Id);
        }
    }
}
