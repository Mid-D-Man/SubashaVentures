@using SubashaVentures.Domain.Product
@using SubashaVentures.Services.VisualElements
@using SubashaVentures.Domain.Enums
@inject IVisualElementsService VisualElementsService

<div class="review-card @CssClass">
    <div class="review-header">
        <div class="reviewer-info">
            @if (!string.IsNullOrEmpty(Review.UserAvatar))
            {
                <img src="@Review.UserAvatar" alt="@Review.UserName" class="reviewer-avatar" loading="lazy" />
            }
            else
            {
                <div class="reviewer-avatar-placeholder">
                    <span class="avatar-initial">@GetInitial(Review.UserName)</span>
                </div>
            }
            
            <div class="reviewer-details">
                <h4 class="reviewer-name">@Review.UserName</h4>
                <p class="review-date">@Review.TimeAgo</p>
            </div>
        </div>
        
        <div class="review-rating-badge">
            <span class="rating-number">@Review.Rating</span>
            <span class="rating-stars">
                @if (!string.IsNullOrEmpty(starSvg))
                {
                    @for (int i = 0; i < Review.Rating; i++)
                    {
                        <span class="star filled">@((MarkupString)starSvg)</span>
                    }
                }
            </span>
        </div>
    </div>
    
    @if (!string.IsNullOrEmpty(Review.Title))
    {
        <h3 class="review-title">@Review.Title</h3>
    }
    
    <p class="review-comment @(IsExpanded ? "expanded" : "")">@Review.Comment</p>
    
    @if (Review.Comment.Length > 200)
    {
        <button class="review-read-more" @onclick="ToggleExpanded">
            @(IsExpanded ? "Read Less" : "Read More")
        </button>
    }
    
    @if (Review.Images?.Any() == true)
    {
        <div class="review-images">
            @foreach (var image in Review.Images.Take(3))
            {
                <div class="review-image-wrapper" @onclick="() => HandleImageClick(image)">
                    <img src="@image" alt="Review image" class="review-image" loading="lazy" />
                </div>
            }
            @if (Review.Images.Count > 3)
            {
                <div class="review-image-more" @onclick="HandleShowMoreImages">
                    <span class="more-count">+@(Review.Images.Count - 3)</span>
                </div>
            }
        </div>
    }
    
    <div class="review-footer">
        <div class="review-badges">
            @if (Review.IsVerifiedPurchase)
            {
                <span class="badge verified">
                    @if (!string.IsNullOrEmpty(checkMarkSvg))
                    {
                        <span class="badge-icon">@((MarkupString)checkMarkSvg)</span>
                    }
                    <span>Verified Purchase</span>
                </span>
            }
        </div>
        
        <div class="review-actions">
            <button class="review-helpful @(IsHelpful ? "active" : "")" 
                    @onclick="HandleHelpfulClick"
                    title="Mark as helpful">
                @if (!string.IsNullOrEmpty(thumbsUpSvg))
                {
                    <span class="helpful-icon @(IsHelpful ? "filled" : "")">@((MarkupString)thumbsUpSvg)</span>
                }
                <span>Helpful (@GetHelpfulCount())</span>
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public ReviewViewModel Review { get; set; } = new();
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public bool IsHelpful { get; set; }
    [Parameter] public EventCallback<ReviewViewModel> OnHelpfulClick { get; set; }
    [Parameter] public EventCallback<string> OnImageClick { get; set; }
    [Parameter] public EventCallback<ReviewViewModel> OnShowMoreImages { get; set; }

    private bool IsExpanded { get; set; }
    
    // SVG strings
    private string starSvg = string.Empty;
    private string checkMarkSvg = string.Empty;
    private string thumbsUpSvg = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSvgsAsync();
    }

    private async Task LoadSvgsAsync()
    {
        try
        {
            // Load all SVGs in parallel
            var starTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.Star, 
                width: 14, 
                height: 14,
                fillColor: "currentColor"
            );
            
            var checkMarkTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.CheckMark, 
                width: 14, 
                height: 14,
                fillColor: "currentColor"
            );
            
            var thumbsUpTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.ThumbsUp, 
                width: 16, 
                height: 16,
                fillColor: "currentColor"
            );

            await Task.WhenAll(starTask, checkMarkTask, thumbsUpTask);
            
            starSvg = await starTask;
            checkMarkSvg = await checkMarkTask;
            thumbsUpSvg = await thumbsUpTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading review card SVGs: {ex.Message}");
        }
    }

    private string GetInitial(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        return name.Substring(0, 1).ToUpper();
    }

    private int GetHelpfulCount()
    {
        return Review.HelpfulCount + (IsHelpful ? 1 : 0);
    }

    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    private async Task HandleHelpfulClick()
    {
        if (OnHelpfulClick.HasDelegate)
        {
            await OnHelpfulClick.InvokeAsync(Review);
        }
    }

    private async Task HandleImageClick(string imageUrl)
    {
        if (OnImageClick.HasDelegate)
        {
            await OnImageClick.InvokeAsync(imageUrl);
        }
    }

    private async Task HandleShowMoreImages()
    {
        if (OnShowMoreImages.HasDelegate)
        {
            await OnShowMoreImages.InvokeAsync(Review);
        }
    }
}
