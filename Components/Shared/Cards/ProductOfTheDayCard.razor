@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Domain.Product
@using SubashaVentures.Services.Wishlist
@using SubashaVentures.Services.Cart
@using SubashaVentures.Services.Authorization
@using SubashaVentures.Services.VisualElements
@using SubashaVentures.Domain.Enums
@inject NavigationManager NavigationManager
@inject IPermissionService PermissionService
@inject ICartService CartService
@inject IWishlistService WishlistService
@inject IVisualElementsService VisualElementsService

<div class="potd-card @CssClass">
    <div class="potd-header">
        <div class="potd-badge">
            @if (!string.IsNullOrEmpty(starSvg))
            {
                <span class="badge-icon">@((MarkupString)starSvg)</span>
            }
            <span class="badge-text">Product of the Day</span>
        </div>
        <div class="potd-timer" title="Refreshes daily">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <polyline points="12 6 12 12 16 14" stroke-width="2"/>
            </svg>
            <span>@GetTimeRemaining()</span>
        </div>
    </div>

    @if (Product != null)
    {
        <div class="potd-content" @onclick="HandleCardClick">
            <div class="potd-image-wrapper">
                @if (!string.IsNullOrEmpty(Product.Images?.FirstOrDefault()))
                {
                    <img src="@Product.Images.First()" alt="@Product.Name" class="potd-image" loading="eager" />
                }
                else
                {
                    <div class="potd-placeholder">
                        <span class="placeholder-icon">âœ¨</span>
                    </div>
                }

                @if (Product.IsOnSale && Product.Discount > 0)
                {
                    <div class="potd-discount">
                        <span class="discount-value">-@Product.Discount%</span>
                        <span class="discount-label">OFF</span>
                    </div>
                }
                
                @* Wishlist Button with SVG *@
                <button class="potd-wishlist-btn @(isInWishlist ? "active" : "") @(IsTogglingWishlist ? "loading" : "")" 
                        @onclick="HandleWishlistToggle" 
                        @onclick:stopPropagation="true"
                        disabled="@IsTogglingWishlist"
                        title="@(isInWishlist ? "Remove from wishlist" : "Add to wishlist")">
                    @if (IsTogglingWishlist)
                    {
                        <span class="spinner-icon"></span>
                    }
                    else if (!string.IsNullOrEmpty(heartSvg))
                    {
                        <span class="heart-icon @(isInWishlist ? "filled" : "")">
                            @((MarkupString)heartSvg)
                        </span>
                    }
                </button>
            </div>

            <div class="potd-info">
                <div class="potd-meta">
                    <span class="potd-category">@Product.Category</span>
                    @if (Product.Rating > 0)
                    {
                        <div class="potd-rating">
                            @if (!string.IsNullOrEmpty(starSvg))
                            {
                                <span class="rating-icon">@((MarkupString)starSvg)</span>
                            }
                            <span class="rating-value">@Product.Rating.ToString("F1")</span>
                            <span class="rating-count">(@Product.ReviewCount)</span>
                        </div>
                    }
                </div>

                <h2 class="potd-name">@Product.Name</h2>

                @if (!string.IsNullOrEmpty(Product.Description))
                {
                    <p class="potd-description">@Product.Description</p>
                }

                <div class="potd-price-section">
                    <div class="price-wrapper">
                        @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                        {
                            <span class="potd-original-price">@Product.DisplayOriginalPrice</span>
                        }
                        <span class="potd-current-price">@Product.DisplayPrice</span>
                    </div>
                    
                    @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                    {
                        <div class="savings-badge">
                            You save: @GetSavingsAmount()
                        </div>
                    }
                </div>

                <div class="potd-actions">
                    <button class="potd-add-cart-btn @(IsAddingToCart ? "loading" : "")"
                            @onclick="HandleAddToCart"
                            @onclick:stopPropagation="true"
                            disabled="@(!Product.IsInStock || IsAddingToCart)">
                        @if (IsAddingToCart)
                        {
                            <span class="btn-spinner"></span>
                            <span>Adding...</span>
                        }
                        else if (Product.IsInStock)
                        {
                            @if (!string.IsNullOrEmpty(cartSvg))
                            {
                                <span class="btn-icon">@((MarkupString)cartSvg)</span>
                            }
                            <span>Add to Cart</span>
                        }
                        else
                        {
                            <span>Out of Stock</span>
                        }
                    </button>
                    
                    <button class="potd-view-btn"
                            @onclick="HandleViewDetails"
                            @onclick:stopPropagation="true">
                        View Details
                    </button>
                </div>
            </div>
        </div>
    }
    else if (IsLoading)
    {
        <div class="potd-loading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading today's special product...</p>
        </div>
    }
    else
    {
        <div class="potd-empty">
            <div class="empty-icon">ðŸ“¦</div>
            <h3 class="empty-title">No Product Selected</h3>
            <p class="empty-text">Check back tomorrow for our next featured product!</p>
        </div>
    }
</div>

@code {
    [Parameter] public ProductViewModel? Product { get; set; }
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnClick { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnAddToCart { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnViewDetails { get; set; }

    private bool isInWishlist = false;
    private bool IsAddingToCart = false;
    private bool IsTogglingWishlist = false;
    private string? currentUserId;
    
    // SVG strings
    private string starSvg = string.Empty;
    private string heartSvg = string.Empty;
    private string cartSvg = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Load SVGs
        await LoadSvgsAsync();
        
        // Check if user is authenticated and get their wishlist status
        if (Product != null && await PermissionService.IsAuthenticatedAsync())
        {
            currentUserId = await PermissionService.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(currentUserId))
            {
                isInWishlist = await WishlistService.IsInWishlistAsync(currentUserId, Product.Id.ToString());
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Update wishlist status if product changes
        if (Product != null && await PermissionService.IsAuthenticatedAsync())
        {
            if (string.IsNullOrEmpty(currentUserId))
            {
                currentUserId = await PermissionService.GetCurrentUserIdAsync();
            }
            
            if (!string.IsNullOrEmpty(currentUserId))
            {
                isInWishlist = await WishlistService.IsInWishlistAsync(currentUserId, Product.Id.ToString());
                StateHasChanged();
            }
        }
    }

    private async Task LoadSvgsAsync()
    {
        try
        {
            var starTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.Star, 
                width: 16, 
                height: 16,
                fillColor: "currentColor"
            );
            
            var heartTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.Heart, 
                width: 24, 
                height: 24,
                fillColor: "currentColor"
            );
            
            var cartTask = VisualElementsService.GetCustomSvgAsync(
                SvgType.Cart, 
                width: 18, 
                height: 18,
                fillColor: "currentColor"
            );

            await Task.WhenAll(starTask, heartTask, cartTask);
            
            starSvg = await starTask;
            heartSvg = await heartTask;
            cartSvg = await cartTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading SVGs: {ex.Message}");
        }
    }

    private string GetTimeRemaining()
    {
        var now = DateTime.UtcNow;
        var tomorrow = now.Date.AddDays(1);
        var remaining = tomorrow - now;
        
        return $"{remaining.Hours:D2}:{remaining.Minutes:D2}:{remaining.Seconds:D2}";
    }

    private string GetSavingsAmount()
    {
        if (Product?.OriginalPrice.HasValue == true)
        {
            var savings = Product.OriginalPrice.Value - Product.Price;
            return $"â‚¦{savings:N0}";
        }
        return "â‚¦0";
    }

    private void HandleCardClick()
    {
        if (Product != null)
        {
            NavigationManager.NavigateTo($"product/{Product.Slug}");
        }
    }

    private async Task HandleAddToCart(MouseEventArgs e)
    {
        if (Product == null || !Product.IsInStock || IsAddingToCart) return;

        IsAddingToCart = true;
        StateHasChanged();

        try
        {
            // Check authentication
            if (!await PermissionService.EnsureAuthenticatedAsync($"product/{Product.Slug}"))
            {
                return;
            }

            if (string.IsNullOrEmpty(currentUserId))
            {
                currentUserId = await PermissionService.GetCurrentUserIdAsync();
            }

            if (string.IsNullOrEmpty(currentUserId))
            {
                PermissionService.ShowAuthRequiredMessage("add items to cart");
                return;
            }

            // Add to cart
            var success = await CartService.AddToCartAsync(
                currentUserId, 
                Product.Id.ToString(), 
                quantity: 1
            );
            
            if (success)
            {
                // Invoke parent callback if provided
                if (OnAddToCart.HasDelegate)
                {
                    await OnAddToCart.InvokeAsync(Product);
                }
                
                Console.WriteLine($"âœ“ Added {Product.Name} to cart");
            }
        }
        finally
        {
            IsAddingToCart = false;
            StateHasChanged();
        }
    }

    private void HandleViewDetails(MouseEventArgs e)
    {
        if (Product != null)
        {
            NavigationManager.NavigateTo($"product/{Product.Slug}");
        }
    }

    private async Task HandleWishlistToggle(MouseEventArgs e)
    {
        if (Product == null || IsTogglingWishlist) return;

        IsTogglingWishlist = true;
        StateHasChanged();

        try
        {
            // Check authentication
            if (!await PermissionService.EnsureAuthenticatedAsync($"product/{Product.Slug}"))
            {
                return;
            }

            if (string.IsNullOrEmpty(currentUserId))
            {
                currentUserId = await PermissionService.GetCurrentUserIdAsync();
            }

            if (string.IsNullOrEmpty(currentUserId))
            {
                PermissionService.ShowAuthRequiredMessage("add items to wishlist");
                return;
            }

            // Toggle wishlist
            var success = await WishlistService.ToggleWishlistAsync(currentUserId, Product.Id.ToString());
            
            if (success)
            {
                isInWishlist = !isInWishlist;
                StateHasChanged();
            }
        }
        finally
        {
            IsTogglingWishlist = false;
            StateHasChanged();
        }
    }
}
