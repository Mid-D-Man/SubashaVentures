@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Domain.Product

@using SubashaVentures.Services.Wishlist
@using SubashaVentures.Services.Cart
@using SubashaVentures.Services.Authorization
@inject NavigationManager NavigationManager
@inject IPermissionService PermissionService
@inject ICartService CartService
@inject IWishlistService WishlistService

<div class="potd-card @CssClass">
    <div class="potd-header">
        <div class="potd-badge">
            <span class="badge-icon">üåü</span>
            <span class="badge-text">Product of the Day</span>
        </div>
        <div class="potd-timer" title="Refreshes daily">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <polyline points="12 6 12 12 16 14" stroke-width="2"/>
            </svg>
            <span>@GetTimeRemaining()</span>
        </div>
    </div>

    @if (Product != null)
    {
        <div class="potd-content" @onclick="HandleCardClick">
            <div class="potd-image-wrapper">
                @if (!string.IsNullOrEmpty(Product.Images?.FirstOrDefault()))
                {
                    <img src="@Product.Images.First()" alt="@Product.Name" class="potd-image" loading="eager" />
                }
                else
                {
                    <div class="potd-placeholder">
                        <span class="placeholder-icon">‚ú®</span>
                    </div>
                }

                @if (Product.IsOnSale && Product.Discount > 0)
                {
                    <div class="potd-discount">
                        <span class="discount-value">-@Product.Discount%</span>
                        <span class="discount-label">OFF</span>
                    </div>
                }
                
                @* Wishlist Button *@
                <button class="potd-wishlist-btn @(isInWishlist ? "active" : "")" 
                        @onclick="HandleWishlistToggle" 
                        @onclick:stopPropagation="true"
                        title="@(isInWishlist ? "Remove from wishlist" : "Add to wishlist")">
                    <span class="heart-icon">@(isInWishlist ? "‚ô•" : "‚ô°")</span>
                </button>
            </div>

            <div class="potd-info">
                <div class="potd-meta">
                    <span class="potd-category">@Product.Category</span>
                    @if (Product.Rating > 0)
                    {
                        <div class="potd-rating">
                            <span class="rating-icon">‚≠ê</span>
                            <span class="rating-value">@Product.Rating.ToString("F1")</span>
                            <span class="rating-count">(@Product.ReviewCount)</span>
                        </div>
                    }
                </div>

                <h2 class="potd-name">@Product.Name</h2>

                @if (!string.IsNullOrEmpty(Product.Description))
                {
                    <p class="potd-description">@Product.Description</p>
                }

                <div class="potd-price-section">
                    <div class="price-wrapper">
                        @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                        {
                            <span class="potd-original-price">@Product.DisplayOriginalPrice</span>
                        }
                        <span class="potd-current-price">@Product.DisplayPrice</span>
                    </div>
                    
                    @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                    {
                        <div class="savings-badge">
                            You save: @GetSavingsAmount()
                        </div>
                    }
                </div>

                <div class="potd-actions">
                    <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                  OnClick="HandleAddToCart"
                                  IsDisabled="@(!Product.IsInStock)"
                                  CssClass="potd-add-cart-btn">
                        @(Product.IsInStock ? "üõí Add to Cart" : "Out of Stock")
                    </PrimaryButton>
                    
                    <SecondaryButton Size="SecondaryButton.ButtonSize.Large"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    OnClick="HandleViewDetails"
                                    CssClass="potd-view-btn">
                        View Details
                    </SecondaryButton>
                </div>
            </div>
        </div>
    }
    else if (IsLoading)
    {
        <div class="potd-loading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading today's special product...</p>
        </div>
    }
    else
    {
        <div class="potd-empty">
            <div class="empty-icon">üì¶</div>
            <h3 class="empty-title">No Product Selected</h3>
            <p class="empty-text">Check back tomorrow for our next featured product!</p>
        </div>
    }
</div>

@code {
    [Parameter] public ProductViewModel? Product { get; set; }
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnClick { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnAddToCart { get; set; }
    [Parameter] public EventCallback<ProductViewModel> OnViewDetails { get; set; }

    private bool isInWishlist = false;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated and get their wishlist status
        if (Product != null && await PermissionService.IsAuthenticatedAsync())
        {
            currentUserId = await PermissionService.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(currentUserId))
            {
                isInWishlist = await WishlistService.IsInWishlistAsync(currentUserId, Product.Id.ToString());
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Update wishlist status if product changes
        if (Product != null && await PermissionService.IsAuthenticatedAsync())
        {
            if (string.IsNullOrEmpty(currentUserId))
            {
                currentUserId = await PermissionService.GetCurrentUserIdAsync();
            }
            
            if (!string.IsNullOrEmpty(currentUserId))
            {
                isInWishlist = await WishlistService.IsInWishlistAsync(currentUserId, Product.Id.ToString());
                StateHasChanged();
            }
        }
    }

    private string GetTimeRemaining()
    {
        var now = DateTime.UtcNow;
        var tomorrow = now.Date.AddDays(1);
        var remaining = tomorrow - now;
        
        return $"{remaining.Hours:D2}:{remaining.Minutes:D2}:{remaining.Seconds:D2}";
    }

    private string GetSavingsAmount()
    {
        if (Product?.OriginalPrice.HasValue == true)
        {
            var savings = Product.OriginalPrice.Value - Product.Price;
            return $"‚Ç¶{savings:N0}";
        }
        return "‚Ç¶0";
    }

    private void HandleCardClick()
    {
        if (Product != null)
        {
            // Navigate to product details page
            NavigationManager.NavigateTo($"product/{Product.Slug}");
        }
    }

    private async Task HandleAddToCart(MouseEventArgs e)
    {
        if (Product == null || !Product.IsInStock) return;

        // Check authentication
        if (!await PermissionService.EnsureAuthenticatedAsync($"product/{Product.Slug}"))
        {
            return;
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            currentUserId = await PermissionService.GetCurrentUserIdAsync();
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            PermissionService.ShowAuthRequiredMessage("add items to cart");
            return;
        }

        // Add to cart
        var success = await CartService.AddToCartAsync(
            currentUserId, 
            Product.Id.ToString(), 
            quantity: 1
        );
        
        if (success)
        {
            // Invoke parent callback if provided
            if (OnAddToCart.HasDelegate)
            {
                await OnAddToCart.InvokeAsync(Product);
            }
            
            Console.WriteLine($"‚úì Added {Product.Name} to cart");
        }
    }

    private void HandleViewDetails(MouseEventArgs e)
    {
        if (Product != null)
        {
            // Navigate to product details page
            NavigationManager.NavigateTo($"product/{Product.Slug}");
        }
    }

    private async Task HandleWishlistToggle(MouseEventArgs e)
    {
        if (Product == null) return;

        // Check authentication
        if (!await PermissionService.EnsureAuthenticatedAsync($"product/{Product.Slug}"))
        {
            return;
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            currentUserId = await PermissionService.GetCurrentUserIdAsync();
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            PermissionService.ShowAuthRequiredMessage("add items to wishlist");
            return;
        }

        // Toggle wishlist
        var success = await WishlistService.ToggleWishlistAsync(currentUserId, Product.Id.ToString());
        
        if (success)
        {
            isInWishlist = !isInWishlist;
            StateHasChanged();
        }
    }
}
