@* Components/Shared/Popups/ImageSelectorPopup.razor - FIXED *@
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Admin.Images

<div class="image-selector-overlay @(IsOpen ? "open" : "")" @onclick="HandleOverlayClick">
    <div class="image-selector-popup @(IsOpen ? "open" : "")" @onclick:stopPropagation="true">
        
        <!-- Header -->
        <div class="isp-header">
            <div class="isp-header-left">
                <h2 class="isp-title">
                    @(AllowMultiple ? "Select Images" : "Select Image")
                </h2>
                <p class="isp-subtitle">
                    @if (SelectedImages.Count > 0)
                    {
                        <span>@SelectedImages.Count selected</span>
                    }
                    else
                    {
                        <span>Choose from your media library</span>
                    }
                </p>
            </div>
            <button class="isp-close" @onclick="Close" title="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>

        <!-- Toolbar -->
        <div class="isp-toolbar">
            <div class="isp-filters">
                <!-- Folder Selection Dropdown - Replace the existing one -->
                <select class="isp-select" @onchange="HandleFolderFilter">
                    <option value="">All Folders</option>
                    @if (categories.Any())
                    {
                        @foreach (var category in categories)
                        {
                            <option value="@category.Slug">@category.Name</option>
                        }
                    }
                    else
                    {
                        <option value="products">Products</option>
                        <option value="banners">Banners</option>
                        <option value="categories">Categories</option>
                    }
                </select>

                <InputField @bind-Value="searchQuery"
                           Placeholder="Search images..."
                           PrefixIcon="üîç"
                           ShowClearButton="true"
                           Size="InputField.InputSize.Small"
                           CssClass="isp-search" />
            </div>

            <div class="isp-view-controls">
                @if (!AllowMultiple && SelectedImages.Count > 0)
                {
                    <button class="clear-selection" @onclick="ClearSelection">
                        Clear Selection
                    </button>
                }
                <button class="view-toggle-btn @(viewSize == "small" ? "active" : "")" 
                        @onclick="@(() => viewSize = "small")">
                    ‚ñ¶‚ñ¶
                </button>
                <button class="view-toggle-btn @(viewSize == "medium" ? "active" : "")" 
                        @onclick="@(() => viewSize = "medium")">
                    ‚ñ¶
                </button>
                <button class="view-toggle-btn @(viewSize == "large" ? "active" : "")" 
                        @onclick="@(() => viewSize = "large")">
                    ‚ñ¢
                </button>
            </div>
        </div>

        <!-- Image Grid using AdminImageCard -->
        <div class="isp-content">
            @if (isLoading)
            {
                <div class="isp-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading images...</p>
                </div>
            }
            else if (!filteredImages.Any())
            {
                <div class="isp-empty">
                    <div class="empty-icon">üñºÔ∏è</div>
                    <h3>No images found</h3>
                    <p>@(string.IsNullOrEmpty(searchQuery) ? "No images available in this folder" : "Try adjusting your search")</p>
                </div>
            }
            else
            {
                <div class="isp-grid @viewSize">
                    @foreach (var image in filteredImages)
                    {
                        var isSelected = SelectedImages.Contains(image.PublicUrl);
                        
                        <AdminImageCard Image="@image"
                                       IsSelected="@isSelected"
                                       OnClick="@(() => HandleImageSelect(image))"
                                       OnSelectionChanged="@((args) => HandleImageSelect(image))" />
                    }
                </div>
            }
        </div>

        <!-- Footer Actions -->
        <div class="isp-footer">
            <div class="isp-footer-info">
                @if (SelectedImages.Count > 0)
                {
                    <span class="selected-count">
                        @SelectedImages.Count image@(SelectedImages.Count != 1 ? "s" : "") selected
                    </span>
                }
            </div>
            <div class="isp-footer-actions">
                <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                                Size="SecondaryButton.ButtonSize.Medium"
                                OnClick="Close">
                    Cancel
                </SecondaryButton>
                <PrimaryButton Size="PrimaryButton.ButtonSize.Medium"
                              OnClick="HandleConfirm"
                              IsDisabled="@(SelectedImages.Count == 0)">
                    @(AllowMultiple ? $"Select {SelectedImages.Count}" : "Select Image")
                </PrimaryButton>
            </div>
        </div>

    </div>
</div>
