@page "/checkout/{slug}"
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Layout.Shop
@layout ShopLayout

<PageTitle>Checkout - SubashaVentures</PageTitle>

<div class="checkout-page">
    @if (IsLoading)
    {
        <div class="checkout-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large"
                            Message="Loading checkout..." />
        </div>
    }
    else if (CheckoutModel == null || !CheckoutModel.Items.Any())
    {
        <div class="empty-checkout">
            <div class="empty-icon">üõí</div>
            <h2>Your cart is empty</h2>
            <p>Add items to your cart before checking out</p>
            <PrimaryButton OnClick="NavigateToShop"
                           Size="PrimaryButton.ButtonSize.Large">
                Continue Shopping
            </PrimaryButton>
        </div>
    }
    else
    {
        <div class="checkout-header">
            <h1 class="checkout-title">Checkout</h1>
            <div class="checkout-steps">
                <div class="step @(CurrentStep >= 1 ? "active" : "") @(CurrentStep > 1 ? "completed" : "")">
                    <span class="step-number">1</span>
                    <span class="step-label">Shipping</span>
                </div>
                <div class="step-divider"></div>
                <div class="step @(CurrentStep >= 2 ? "active" : "") @(CurrentStep > 2 ? "completed" : "")">
                    <span class="step-number">2</span>
                    <span class="step-label">Delivery</span>
                </div>
                <div class="step-divider"></div>
                <div class="step @(CurrentStep >= 3 ? "active" : "") @(CurrentStep > 3 ? "completed" : "")">
                    <span class="step-number">3</span>
                    <span class="step-label">Payment</span>
                </div>
                <div class="step-divider"></div>
                <div class="step @(CurrentStep >= 4 ? "active" : "")">
                    <span class="step-number">4</span>
                    <span class="step-label">Review</span>
                </div>
            </div>
        </div>

        <div class="checkout-container">
            <!-- Left: Checkout Forms -->
            <div class="checkout-forms">
                @if (CurrentStep == 1)
                {
                    <!-- STEP 1: Shipping Address -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="title-icon">üìç</span>
                            Shipping Address
                        </h2>

                        @if (UserAddresses.Any())
                        {
                            <div class="saved-addresses">
                                <p class="section-hint">Select a saved address or enter a new one</p>
                                
                                @foreach (var address in UserAddresses)
                                {
                                    <div class="address-card @(SelectedAddressId == address.Id ? "selected" : "")"
                                         @onclick="() => SelectAddress(address)">
                                        <div class="address-header">
                                            <input type="radio" 
                                                   name="address" 
                                                   checked="@(SelectedAddressId == address.Id)"
                                                   @onclick:stopPropagation />
                                            <div class="address-info">
                                                <span class="address-name">@address.FullName</span>
                                                @if (address.IsDefault)
                                                {
                                                    <span class="default-badge">Default</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="address-details">
                                            <p>@address.AddressLine1</p>
                                            @if (!string.IsNullOrEmpty(address.AddressLine2))
                                            {
                                                <p>@address.AddressLine2</p>
                                            }
                                            <p>@address.City, @address.State @address.PostalCode</p>
                                            <p>üìû @address.PhoneNumber</p>
                                        </div>
                                    </div>
                                }
                                
                                <button class="btn-add-address" @onclick="ShowNewAddressForm">
                                    <span>‚ûï</span>
                                    <span>Add New Address</span>
                                </button>
                            </div>
                        }
                        
                        @if (!UserAddresses.Any() || ShowAddressForm)
                        {
                            <div class="new-address-form">
                                @if (UserAddresses.Any())
                                {
                                    <div class="form-header">
                                        <h3>New Address</h3>
                                        <button class="btn-cancel" @onclick="HideNewAddressForm">‚úï</button>
                                    </div>
                                }
                                
                                <div class="form-grid">
                                    <InputField Label="Full name"
                                                Type="text"
                                                @bind-Value="NewAddress.FullName"
                                                IsRequired="true"
                                                Placeholder="John Doe" />
                                </div>

                                <InputField Label="Phone Number"
                                            Type="tel"
                                            @bind-Value="NewAddress.PhoneNumber"
                                            PrefixIcon="üìû"
                                            IsRequired="true"
                                            Placeholder="0801 234 5678" />

                                <InputField Label="Email (Optional)"
                                            Type="email"
                                            @bind-Value="NewAddress.Email"
                                            PrefixIcon="üìß"
                                            IsRequired="false"
                                            Placeholder="john@example.com" />

                                <InputField Label="Address Line 1"
                                            Type="text"
                                            @bind-Value="NewAddress.AddressLine1"
                                            IsRequired="true"
                                            Placeholder="Street address, P.O. box" />

                                <InputField Label="Address Line 2 (Optional)"
                                            Type="text"
                                            @bind-Value="NewAddress.AddressLine2"
                                            Placeholder="Apartment, suite, unit, building, floor" />

                                <div class="form-grid">
                                    <InputField Label="City"
                                                Type="text"
                                                @bind-Value="NewAddress.City"
                                                IsRequired="true"
                                                Placeholder="Lagos" />
                                    
                                    <InputField Label="State"
                                                Type="text"
                                                @bind-Value="NewAddress.State"
                                                IsRequired="true"
                                                Placeholder="Lagos" />
                                </div>

                                <InputField Label="Postal Code"
                                            Type="text"
                                            @bind-Value="NewAddress.PostalCode"
                                            IsRequired="true"
                                            MaxLength="6"
                                            Placeholder="100001" />

                                <div class="form-checkbox">
                                    <label class="checkbox-label">
                                        <input type="checkbox" @bind="SaveNewAddress" />
                                        <span>Save this address for future orders</span>
                                    </label>
                                </div>
                            </div>
                        }

                        <div class="section-actions">
                            <button class="btn-back" @onclick="NavigateToProduct">
                                <span>‚Üê</span>
                                <span>Back to Product</span>
                            </button>
                            <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                           OnClick="GoToDeliveryStep"
                                           IsDisabled="@(!HasValidAddress)">
                                Continue to Delivery
                            </PrimaryButton>
                        </div>
                    </div>
                }
                else if (CurrentStep == 2)
                {
                    <!-- STEP 2: Delivery Method -->
                    <div class="checkout-section">
                        <div class="section-title-wrapper">
                            <h2 class="section-title">
                                <span class="title-icon">üöö</span>
                                Delivery Method
                            </h2>
                            <span class="test-badge">üß™ TEST ONLY</span>
                        </div>

                        @if (IsLoadingShipping)
                        {
                            <div class="loading-shipping">
                                <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Medium"
                                                Message="Calculating shipping options..." />
                            </div>
                        }
                        else if (ShippingMethods.Any())
                        {
                            <div class="shipping-methods">
                                @foreach (var method in ShippingMethods)
                                {
                                    <label class="shipping-option @(SelectedShippingMethod == method.Id ? "selected" : "")"
                                           @onclick="() => SelectShippingMethod(method)">
                                        <input type="radio" 
                                               name="shipping" 
                                               value="@method.Id"
                                               checked="@(SelectedShippingMethod == method.Id)" />
                                        <div class="shipping-content">
                                            <span class="shipping-icon">@method.Icon</span>
                                            <div class="shipping-details">
                                                <span class="shipping-name">@method.Name</span>
                                                <span class="shipping-desc">@method.Description</span>
                                                <span class="shipping-eta">‚è±Ô∏è @method.EstimatedDays</span>
                                            </div>
                                            <div class="shipping-price">
                                                <span class="price-label">@method.DisplayCost</span>
                                            </div>
                                        </div>
                                    </label>
                                }
                            </div>
                        }

                        <div class="section-actions">
                            <button class="btn-back" @onclick="GoToShippingStep">
                                <span>‚Üê</span>
                                <span>Back to Shipping</span>
                            </button>
                            <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                           OnClick="GoToPaymentStep"
                                           IsDisabled="@string.IsNullOrEmpty(SelectedShippingMethod)">
                                Continue to Payment
                            </PrimaryButton>
                        </div>
                    </div>
                }
                else if (CurrentStep == 3)
                {
                    <!-- STEP 3: Payment Method -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="title-icon">üí≥</span>
                            Payment Method
                        </h2>

                        <div class="payment-methods">
                            <label class="payment-option @(SelectedPaymentMethod == "Card" ? "selected" : "")"
                                   @onclick='() => SelectPaymentMethod("Card")'>
                                <input type="radio" name="payment" value="Card" checked="@(SelectedPaymentMethod == "Card")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üí≥</span>
                                    <div class="payment-details">
                                        <span class="payment-name">Credit/Debit Card</span>
                                        <span class="payment-desc">Pay securely with Paystack or Flutterwave</span>
                                    </div>
                                </div>
                            </label>

                            @if (WalletBalance > 0)
                            {
                                <label class="payment-option @(SelectedPaymentMethod == "Wallet" ? "selected" : "")"
                                       @onclick='() => SelectPaymentMethod("Wallet")'>
                                    <input type="radio" name="payment" value="Wallet" checked="@(SelectedPaymentMethod == "Wallet")" />
                                    <div class="payment-content">
                                        <span class="payment-icon">üëõ</span>
                                        <div class="payment-details">
                                            <span class="payment-name">Wallet</span>
                                            <span class="payment-desc">Balance: @FormatCurrency(WalletBalance)</span>
                                            @if (WalletBalance < CheckoutModel.Total)
                                            {
                                                <span class="payment-warning">‚ö†Ô∏è Insufficient balance</span>
                                            }
                                        </div>
                                    </div>
                                </label>
                            }

                            <label class="payment-option @(SelectedPaymentMethod == "PayOnDelivery" ? "selected" : "")"
                                   @onclick='() => SelectPaymentMethod("PayOnDelivery")'>
                                <input type="radio" name="payment" value="PayOnDelivery" checked="@(SelectedPaymentMethod == "PayOnDelivery")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üí∞</span>
                                    <div class="payment-details">
                                        <span class="payment-name">Pay on Delivery</span>
                                        <span class="payment-desc">Pay when you receive your order</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="section-actions">
                            <button class="btn-back" @onclick="GoToDeliveryStep">
                                <span>‚Üê</span>
                                <span>Back to Delivery</span>
                            </button>
                            <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                           OnClick="GoToReviewStep"
                                           IsDisabled="@(!IsPaymentMethodValid)">
                                Continue to Review
                            </PrimaryButton>
                        </div>
                    </div>
                }
                else if (CurrentStep == 4)
                {
                    <!-- STEP 4: Review Order -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="title-icon">üìã</span>
                            Review Your Order
                        </h2>

                        <!-- Shipping Address Review -->
                        <div class="review-card">
                            <div class="review-header">
                                <h3>Shipping Address</h3>
                                <button class="btn-edit" @onclick="GoToShippingStep">Edit</button>
                            </div>
                            <div class="review-content">
                                @if (CheckoutModel.ShippingAddress != null)
                                {
                                    <p><strong>@CheckoutModel.ShippingAddress.FullName</strong></p>
                                    <p>@CheckoutModel.ShippingAddress.AddressLine1</p>
                                    @if (!string.IsNullOrEmpty(CheckoutModel.ShippingAddress.AddressLine2))
                                    {
                                        <p>@CheckoutModel.ShippingAddress.AddressLine2</p>
                                    }
                                    <p>@CheckoutModel.ShippingAddress.City, @CheckoutModel.ShippingAddress.State @CheckoutModel.ShippingAddress.PostalCode</p>
                                    <p>üìû @CheckoutModel.ShippingAddress.PhoneNumber</p>
                                }
                            </div>
                        </div>

                        <!-- Delivery Method Review -->
                        <div class="review-card">
                            <div class="review-header">
                                <h3>Delivery Method</h3>
                                <button class="btn-edit" @onclick="GoToDeliveryStep">Edit</button>
                            </div>
                            <div class="review-content">
                                @if (SelectedShippingMethodObj != null)
                                {
                                    <p><strong>@SelectedShippingMethodObj.Name</strong></p>
                                    <p>@SelectedShippingMethodObj.Description</p>
                                    <p>‚è±Ô∏è Estimated delivery: @SelectedShippingMethodObj.EstimatedDays</p>
                                    <p>üí∞ Cost: @SelectedShippingMethodObj.DisplayCost</p>
                                }
                            </div>
                        </div>

                        <!-- Payment Method Review -->
                        <div class="review-card">
                            <div class="review-header">
                                <h3>Payment Method</h3>
                                <button class="btn-edit" @onclick="GoToPaymentStep">Edit</button>
                            </div>
                            <div class="review-content">
                                <p><strong>@GetPaymentMethodDisplay(SelectedPaymentMethod)</strong></p>
                            </div>
                        </div>

                        <!-- Order Items Review -->
                        <div class="review-card">
                            <div class="review-header">
                                <h3>Order Items (@CheckoutModel.Items.Count)</h3>
                            </div>
                            <div class="review-items">
                                @foreach (var item in CheckoutModel.Items)
                                {
                                    <div class="review-item">
                                        <img src="@item.ImageUrl" alt="@item.Name" class="item-image" />
                                        <div class="item-details">
                                            <h4>@item.Name</h4>
                                            @if (!string.IsNullOrEmpty(item.Size) || !string.IsNullOrEmpty(item.Color))
                                            {
                                                <p class="item-variant">
                                                    @if (!string.IsNullOrEmpty(item.Size))
                                                    {
                                                        <span>Size: @item.Size</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.Color))
                                                    {
                                                        <span>Color: @item.Color</span>
                                                    }
                                                </p>
                                            }
                                            <p class="item-quantity">Qty: @item.Quantity</p>
                                        </div>
                                        <div class="item-price">
                                            <span>@FormatCurrency(item.Subtotal)</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="section-actions">
                            <button class="btn-back" @onclick="GoToPaymentStep">
                                <span>‚Üê</span>
                                <span>Back to Payment</span>
                            </button>
                            <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                           OnClick="PlaceOrder"
                                           IsDisabled="@IsProcessing">
                                @if (IsProcessing)
                                {
                                    <span class="btn-spinner"></span>
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>Place Order - @FormatCurrency(CheckoutModel.Total)</span>
                                }
                            </PrimaryButton>
                        </div>
                    </div>
                }
            </div>

            <!-- Right: Order Summary Sidebar -->
            <div class="order-summary-sidebar">
                <div class="summary-card">
                    <h3 class="summary-title">Order Summary</h3>
                    
                    <div class="summary-items">
                        @foreach (var item in CheckoutModel.Items)
                        {
                            <div class="summary-item">
                                <span class="item-name">@item.Name √ó@item.Quantity</span>
                                <span class="item-price">@FormatCurrency(item.Subtotal)</span>
                            </div>
                        }
                    </div>

                    <div class="summary-divider"></div>
                    
                    <div class="summary-details">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>@FormatCurrency(CheckoutModel.Subtotal)</span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping</span>
                            <span>@FormatCurrency(CheckoutModel.ShippingCost)</span>
                        </div>
                        @if (CheckoutModel.PromoDiscount > 0)
                        {
                            <div class="summary-row discount">
                                <span>Discount</span>
                                <span>-@FormatCurrency(CheckoutModel.PromoDiscount)</span>
                            </div>
                        }
                        <div class="summary-divider"></div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>@FormatCurrency(CheckoutModel.Total)</span>
                        </div>
                    </div>

                    <div class="secure-badge">
                        <span class="secure-icon">üîí</span>
                        <span class="secure-text">Secure Checkout</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Success Modal -->
<DynamicModal @ref="SuccessModal"
              Title="Order Placed Successfully! üéâ"
              Size="DynamicModal.ModalSize.Medium"
              IsOpen="@ShowSuccessModal"
              OnConfirm="NavigateToOrders"
              OnCancel="NavigateToShop"
              ConfirmText="View Order"
              CancelText="Continue Shopping"
              ShowCancelButton="true">
    <BodyContent>
        <div class="success-content">
            <div class="success-icon">‚úÖ</div>
            <h3>Thank you for your order!</h3>
            <p class="order-number">Order Number: <strong>@OrderNumber</strong></p>
            <p class="success-message">
                We've received your order and will send you a confirmation email shortly.
                You can track your order status in your orders page.
            </p>
        </div>
    </BodyContent>
</DynamicModal>

<!-- Error Modal -->
<InfoPopup @ref="ErrorPopup"
           IsOpen="@ShowErrorModal"
           Title="Order Failed"
           Message="@ErrorMessage"
           OnClose="CloseErrorModal" />
