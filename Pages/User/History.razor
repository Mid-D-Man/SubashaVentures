@page "/user/history"
@layout UserLayout
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Layout.User
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IPermissionService PermissionService
@inject IProductService ProductService

<div class="history-page">
    <div class="page-header">
        <div>
            <h1>Browsing History</h1>
            <p>Your recently viewed products and activity</p>
        </div>
        @if (ViewedProducts.Any())
        {
            <button class="btn-clear" @onclick="ClearViewedProducts">
                Clear Viewed Products
            </button>
        }
    </div>

    @if (IsLoading)
    {
        <div class="history-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading history..." />
        </div>
    }
    else
    {
        <!-- Tabs -->
        <div class="history-tabs">
            <button class="tab-button @(ActiveTab == "viewed" ? "active" : "")" 
                    @onclick='() => ActiveTab = "viewed"'>
                <span class="tab-icon">üëÅÔ∏è</span>
                Recently Viewed (@ViewedProducts.Count)
            </button>
            
            @if (IsAuthenticated)
            {
                <button class="tab-button @(ActiveTab == "orders" ? "active" : "")" 
                        @onclick='() => ActiveTab = "orders"'>
                    <span class="tab-icon">üì¶</span>
                    Recent Orders (@RecentOrders.Count)
                </button>
                
                <button class="tab-button @(ActiveTab == "wishlist" ? "active" : "")" 
                        @onclick='() => ActiveTab = "wishlist"'>
                    <span class="tab-icon">üíù</span>
                    Recent Wishlist (@RecentWishlistItems.Count)
                </button>
            }
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            @if (ActiveTab == "viewed")
            {
                @if (!ViewedProducts.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">üïí</div>
                        <h2>No Browsing History</h2>
                        <p>Products you view will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToShop">Browse Products</button>
                    </div>
                }
                else
                {
                    <div class="history-grid">
                        @foreach (var product in ViewedProducts)
                        {
                            <div class="history-card" @onclick="() => ViewProduct(product.ProductId)">
                                <button class="btn-remove" 
                                        @onclick="(e) => RemoveViewedProduct(product.ProductId, e)" 
                                        @onclick:stopPropagation="true" 
                                        title="Remove">
                                    ‚úï
                                </button>
                                <img src="@product.ImageUrl" alt="@product.ProductName" loading="lazy" />
                                <div class="card-content">
                                    <h3>@product.ProductName</h3>
                                    <p class="product-price">‚Ç¶@product.Price.ToString("N0")</p>
                                    <span class="viewed-time">Viewed @product.ViewedTime</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (ActiveTab == "orders" && IsAuthenticated)
            {
                @if (!RecentOrders.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h2>No Recent Orders</h2>
                        <p>Your recent orders will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToShop">Start Shopping</button>
                    </div>
                }
                else
                {
                    <div class="orders-list">
                        @foreach (var order in RecentOrders)
                        {
                            <div class="order-card" @onclick="() => ViewOrder(order.Id)">
                                <div class="order-header">
                                    <div>
                                        <h3>Order #@order.OrderNumber</h3>
                                        <span class="order-date">@order.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <span class="order-status status-@order.Status.ToString().ToLower()">
                                        @order.Status
                                    </span>
                                </div>
                                <div class="order-details">
                                    <span class="order-items">@order.ItemCount item(s)</span>
                                    <span class="order-total">@order.DisplayTotal</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (ActiveTab == "wishlist" && IsAuthenticated)
            {
                @if (!RecentWishlistItems.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">üíù</div>
                        <h2>No Wishlist Items</h2>
                        <p>Your wishlist additions will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToWishlist">View Wishlist</button>
                    </div>
                }
                else
                {
                    <div class="history-grid">
                        @foreach (var item in RecentWishlistItems)
                        {
                            <div class="history-card" @onclick="() => ViewProduct(item.ProductId)">
                                <img src="@item.ImageUrl" alt="@item.ProductName" loading="lazy" />
                                <div class="card-content">
                                    <h3>@item.ProductName</h3>
                                    <p class="product-price">‚Ç¶@item.Price.ToString("N0")</p>
                                    <span class="viewed-time">Added @item.AddedTime</span>
                                    @if (!item.IsInStock)
                                    {
                                        <span class="out-of-stock">Out of Stock</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

<ConfirmationPopup @ref="ClearConfirmation"
                   Title="Clear Viewed Products?"
                   Message="Are you sure you want to clear your viewing history?"
                   ConfirmText="Clear All"
                   OnConfirm="ConfirmClearViewedProducts" />

@code {
    // See History.razor.cs for implementation
}
