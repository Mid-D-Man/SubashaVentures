@page "/user/history"
@layout UserLayout
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Layout.User
@using SubashaVentures.Domain.Enums
@using SubashaVentures.Services.VisualElements

@inject IVisualElementsService VisualElements

<div class="history-page">
    <div class="page-header">
        <div class="header-content">
            <h1>Browsing History</h1>
            <p>Your recently viewed products and activity</p>
        </div>
        @if (ViewedProducts.Any())
        {
            <button class="btn-clear" @onclick="ClearViewedProducts">
                <span class="btn-icon">@((MarkupString)trashIconSvg)</span>
                <span class="btn-text">Clear History</span>
            </button>
        }
    </div>

    @if (IsLoading)
    {
        <div class="history-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading history..." />
        </div>
    }
    else
    {
        <div class="history-tabs">
            <button class="tab-button @(ActiveTab == "viewed" ? "active" : "")" 
                    @onclick='() => ActiveTab = "viewed"'>
                <span class="tab-icon">@((MarkupString)eyeIconSvg)</span>
                <span class="tab-label">Recently Viewed</span>
                <span class="tab-count">(@ViewedProducts.Count)</span>
            </button>
            
            @if (IsAuthenticated)
            {
                <button class="tab-button @(ActiveTab == "orders" ? "active" : "")" 
                        @onclick='() => ActiveTab = "orders"'>
                    <span class="tab-icon">@((MarkupString)orderIconSvg)</span>
                    <span class="tab-label">Recent Orders</span>
                    <span class="tab-count">(@RecentOrders.Count)</span>
                </button>
                
                <button class="tab-button @(ActiveTab == "wishlist" ? "active" : "")" 
                        @onclick='() => ActiveTab = "wishlist"'>
                    <span class="tab-icon">@((MarkupString)wishlistIconSvg)</span>
                    <span class="tab-label">Recent Wishlist</span>
                    <span class="tab-count">(@RecentWishlistItems.Count)</span>
                </button>
            }
        </div>

        <div class="tab-content">
            @if (ActiveTab == "viewed")
            {
                @if (!ViewedProducts.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">@((MarkupString)emptyHistoryIconSvg)</div>
                        <h2>No Browsing History</h2>
                        <p>Products you view will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToShop">Browse Products</button>
                    </div>
                }
                else
                {
                    <div class="history-grid">
                        @foreach (var product in ViewedProducts)
                        {
                            <div class="history-card" @onclick="() => ViewProduct(product.ProductId)">
                                <button class="btn-remove" 
                                        @onclick="(e) => RemoveViewedProduct(product.ProductId, e)" 
                                        @onclick:stopPropagation="true" 
                                        title="Remove"
                                        aria-label="Remove from history">
                                    @((MarkupString)closeIconSvg)
                                </button>
                                
                                <div class="card-image">
                                    @if (!string.IsNullOrEmpty(product.ImageUrl))
                                    {
                                        <img src="@product.ImageUrl" alt="@product.ProductName" loading="lazy" />
                                    }
                                    else
                                    {
                                        <div class="image-placeholder">
                                            <span class="placeholder-icon">@((MarkupString)placeholderIconSvg)</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="card-content">
                                    <h3>@product.ProductName</h3>
                                    <p class="product-price">₦@product.Price.ToString("N0")</p>
                                    <div class="card-meta">
                                        <span class="viewed-time">
                                            <span class="meta-icon">@((MarkupString)clockIconSvg)</span>
                                            @product.ViewedTime
                                        </span>
                                        @if (product.DurationSeconds > 0)
                                        {
                                            <span class="view-duration">
                                                <span class="meta-icon">@((MarkupString)timerIconSvg)</span>
                                                @product.ViewDuration
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (ActiveTab == "orders" && IsAuthenticated)
            {
                @if (!RecentOrders.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">@((MarkupString)emptyOrdersIconSvg)</div>
                        <h2>No Recent Orders</h2>
                        <p>Your recent orders will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToShop">Start Shopping</button>
                    </div>
                }
                else
                {
                    <div class="orders-list">
                        @foreach (var order in RecentOrders)
                        {
                            <div class="order-card" @onclick="() => ViewOrder(order.Id)">
                                <div class="order-header">
                                    <div class="order-info">
                                        <h3>Order #@order.OrderNumber</h3>
                                        <span class="order-date">@order.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <span class="order-status status-@order.Status.ToString().ToLower()">
                                        @order.Status
                                    </span>
                                </div>
                                <div class="order-details">
                                    <span class="order-items">@order.ItemCount item(s)</span>
                                    <span class="order-total">@order.DisplayTotal</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (ActiveTab == "wishlist" && IsAuthenticated)
            {
                @if (!RecentWishlistItems.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">@((MarkupString)emptyWishlistIconSvg)</div>
                        <h2>No Wishlist Items</h2>
                        <p>Your wishlist additions will appear here</p>
                        <button class="btn-primary" @onclick="NavigateToWishlist">View Wishlist</button>
                    </div>
                }
                else
                {
                    <div class="history-grid">
                        @foreach (var item in RecentWishlistItems)
                        {
                            <div class="history-card" @onclick="() => ViewProduct(item.ProductId)">
                                <div class="card-image">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@item.ImageUrl" alt="@item.ProductName" loading="lazy" />
                                    }
                                    else
                                    {
                                        <div class="image-placeholder">
                                            <span class="placeholder-icon">@((MarkupString)placeholderIconSvg)</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="card-content">
                                    <h3>@item.ProductName</h3>
                                    <p class="product-price">₦@item.Price.ToString("N0")</p>
                                    <div class="card-meta">
                                        <span class="viewed-time">
                                            <span class="meta-icon">@((MarkupString)clockIconSvg)</span>
                                            Added @item.AddedTime
                                        </span>
                                        @if (!item.IsInStock)
                                        {
                                            <span class="out-of-stock">
                                                <span class="stock-icon">@((MarkupString)warningIconSvg)</span>
                                                Out of Stock
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

<ConfirmationPopup @ref="ClearConfirmation"
                   Title="Clear Viewed Products?"
                   Message="Are you sure you want to clear your viewing history? This action cannot be undone."
                   ConfirmButtonText="Clear All"
                   Variant="ConfirmationPopup.ConfirmationVariant.Warning"
                   OnConfirm="ConfirmClearViewedProducts" />

@code {
    private string trashIconSvg = string.Empty;
    private string eyeIconSvg = string.Empty;
    private string orderIconSvg = string.Empty;
    private string wishlistIconSvg = string.Empty;
    private string closeIconSvg = string.Empty;
    private string clockIconSvg = string.Empty;
    private string timerIconSvg = string.Empty;
    private string warningIconSvg = string.Empty;
    private string placeholderIconSvg = string.Empty;
    private string emptyHistoryIconSvg = string.Empty;
    private string emptyOrdersIconSvg = string.Empty;
    private string emptyWishlistIconSvg = string.Empty;


    private async Task LoadSvgIconsAsync()
    {
        try
        {
            // Tab and button icons (24x24)
            trashIconSvg = VisualElements.GenerateSvg(
                "<path d='M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/>",
                24, 24, "0 0 24 24"
            );

            eyeIconSvg = VisualElements.GenerateSvg(
                "<path d='M12 5C7 5 2.73 8.11 1 12.5 2.73 16.89 7 20 12 20s9.27-3.11 11-7.5C21.27 8.11 17 5 12 5zm0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z' fill='currentColor'/>",
                24, 24, "0 0 24 24"
            );

            orderIconSvg = await VisualElements.GetCustomSvgAsync(
                SvgType.Order,
                width: 24,
                height: 24
            );

            wishlistIconSvg = await VisualElements.GetCustomSvgAsync(
                SvgType.Heart,
                width: 24,
                height: 24
            );

            // Card action icons (20x20)
            closeIconSvg = VisualElements.GenerateSvg(
                "<path d='M6 6L14 14M14 6L6 14' stroke='currentColor' stroke-width='2' stroke-linecap='round'/>",
                20, 20, "0 0 20 20"
            );

            // Metadata icons (16x16)
            clockIconSvg = VisualElements.GenerateSvg(
                "<path d='M8 4a4 4 0 100 8 4 4 0 000-8zM8 1a7 7 0 100 14A7 7 0 008 1zm.5 3.5v3.793l2.146 2.147-.707.707L7.5 8.707V4.5h1z' fill='currentColor'/>",
                16, 16, "0 0 16 16"
            );

            timerIconSvg = VisualElements.GenerateSvg(
                "<path d='M8 1a7 7 0 100 14A7 7 0 008 1zM8 13A5 5 0 118 3a5 5 0 010 10zm.5-8.5V8H11v1H7V4.5h1.5z' fill='currentColor'/>",
                16, 16, "0 0 16 16"
            );

            warningIconSvg = await VisualElements.GetCustomSvgAsync(
                SvgType.Warning,
                width: 16,
                height: 16
            );

            // Empty state icons (64x64)
            emptyHistoryIconSvg = VisualElements.GenerateSvg(
                "<path d='M32 8C19.85 8 9.64 15.45 4 26c5.64 10.55 15.85 18 28 18s22.36-7.45 28-18C54.36 15.45 44.15 8 32 8zm0 30c-6.63 0-12-5.37-12-12s5.37-12 12-12 12 5.37 12 12-5.37 12-12 12zm0-19.5c-4.14 0-7.5 3.36-7.5 7.5s3.36 7.5 7.5 7.5 7.5-3.36 7.5-7.5-3.36-7.5-7.5-7.5z' fill='currentColor' opacity='0.3'/>",
                64, 64, "0 0 64 64"
            );

            emptyOrdersIconSvg = VisualElements.GenerateSvg(
                "<path d='M52 12H12c-2.2 0-4 1.8-4 4v32c0 2.2 1.8 4 4 4h40c2.2 0 4-1.8 4-4V16c0-2.2-1.8-4-4-4zm0 36H12V16h40v32zM18 24h28v4H18v-4zm0 8h20v4H18v-4z' fill='currentColor' opacity='0.3'/>",
                64, 64, "0 0 64 64"
            );

            emptyWishlistIconSvg = VisualElements.GenerateSvg(
                "<path d='M32 54.4L28.8 51.52C17.2 41.04 9.6 34.24 9.6 25.84c0-6.56 5.12-11.68 11.68-11.68 3.68 0 7.2 1.76 9.52 4.48 2.32-2.72 5.84-4.48 9.52-4.48 6.56 0 11.68 5.12 11.68 11.68 0 8.4-7.6 15.2-19.2 25.68L32 54.4z' fill='currentColor' opacity='0.3'/>",
                64, 64, "0 0 64 64"
            );

            // Placeholder icon (48x48)
            placeholderIconSvg = VisualElements.GenerateSvg(
                "<rect width='48' height='48' rx='4' fill='currentColor' opacity='0.1'/><path d='M24 14a10 10 0 100 20 10 10 0 000-20zm0 18a8 8 0 110-16 8 8 0 010 16zm-1-13v6l5 3 1-1.5-4-2.5V19h-2z' fill='currentColor' opacity='0.3'/>",
                48, 48, "0 0 48 48"
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load SVG icons for History page");
        }
    }
}
