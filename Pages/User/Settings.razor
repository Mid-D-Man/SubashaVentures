@page "/user/settings"
@layout UserLayout
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.QRCode
@using SubashaVentures.Layout.User
@using Microsoft.AspNetCore.Components.Forms

<div class="settings-container">
    <div class="settings-header">
        <h1>Settings</h1>
        <p>Manage your account preferences and security.</p>
    </div>

    @if (IsLoading)
    {
        <LoadingSpinner />
    }
    else
    {
        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)profileIconSvg)</span>
                <h2>Profile</h2>
            </div>
            <div class="section-content">
                <div class="profile-display" @onclick="OpenProfileModal">
                    <div class="profile-avatar">
                        @if (!string.IsNullOrEmpty(UserProfile?.AvatarUrl))
                        {
                            <img src="@UserProfile.AvatarUrl" alt="Profile" />
                        }
                        else
                        {
                            <div class="avatar-initials">@UserProfile?.Initials</div>
                        }
                    </div>
                    <div class="profile-info">
                        <h3>@UserProfile?.DisplayName</h3>
                        <p>@UserProfile?.Email</p>
                        @if (!string.IsNullOrEmpty(UserProfile?.PhoneNumber))
                        {
                            <p class="phone-info">@UserProfile.PhoneNumber</p>
                        }
                    </div>
                    <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)notificationIconSvg)</span>
                <h2>Notifications</h2>
            </div>
            <div class="section-content">
                <div class="settings-item">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)emailIconSvg)</span>
                        <div class="item-text">
                            <span>Email Notifications</span>
                            <small>Receive order updates via email</small>
                        </div>
                    </div>
                    <div class="item-right">
                        <label class="toggle-switch">
                            <input type="checkbox" checked="@EmailNotificationsEnabled" @onchange="HandleEmailNotificationToggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)smsIconSvg)</span>
                        <div class="item-text">
                            <span>SMS Notifications</span>
                            <small>Receive order updates via SMS</small>
                        </div>
                    </div>
                    <div class="item-right">
                        <label class="toggle-switch">
                            <input type="checkbox" checked="@SmsNotificationsEnabled" @onchange="HandleSmsNotificationToggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)settingsIconSvg)</span>
                <h2>Preferences</h2>
            </div>
            <div class="section-content">
                <div class="settings-item" @onclick="OpenCurrencyModal">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)currencyIconSvg)</span>
                        <span>Currency</span>
                    </div>
                    <div class="item-right">
                        <span class="item-value">@SelectedCurrency</span>
                        <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                    </div>
                </div>
                <div class="settings-item" @onclick="OpenLanguageModal">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)languageIconSvg)</span>
                        <span>Language</span>
                    </div>
                    <div class="item-right">
                        <span class="item-value">@SelectedLanguage</span>
                        <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)securityIconSvg)</span>
                <h2>Security</h2>
            </div>
            <div class="section-content">
                @if (CanChangePassword)
                {
                    <div class="settings-item" @onclick="OpenSecurityModal">
                        <div class="item-left">
                            <span class="item-icon">@((MarkupString)keyIconSvg)</span>
                            <span>Change Password</span>
                        </div>
                        <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                    </div>
                }
                else
                {
                    <div class="settings-item disabled">
                        <div class="item-left">
                            <span class="item-icon">@((MarkupString)keyIconSvg)</span>
                            <div class="item-text">
                                <span>Change Password</span>
                                <small>Not available for Google sign-in</small>
                            </div>
                        </div>
                    </div>
                }
                <div class="settings-item" @onclick="OpenMfaModal">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)mfaIconSvg)</span>
                        <div class="item-text">
                            <span>Two-Factor Authentication</span>
                            <small>@(IsMfaEnabled ? "Enabled" : "Not enabled")</small>
                        </div>
                    </div>
                    <div class="item-right">
                        @if (IsMfaEnabled)
                        {
                            <span class="badge badge-success">Active</span>
                        }
                        <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)infoIconSvg)</span>
                <h2>Account Information</h2>
            </div>
            <div class="section-content">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Member Since</span>
                        <span class="info-value">@UserProfile?.MemberSince</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Login</span>
                        <span class="info-value">@(UserProfile?.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email Status</span>
                        <span class="info-value">
                            @if (UserProfile?.IsEmailVerified == true)
                            {
                                <span class="badge badge-success">Verified</span>
                            }
                            else
                            {
                                <span class="badge badge-warning">Not Verified</span>
                            }
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phone Status</span>
                        <span class="info-value">
                            @if (UserProfile?.IsPhoneVerified == true)
                            {
                                <span class="badge badge-success">Verified</span>
                            }
                            else
                            {
                                <span class="badge badge-warning">Not Verified</span>
                            }
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Membership Tier</span>
                        <span class="info-value">
                            <span class="badge badge-@GetMembershipBadgeClass()">@UserProfile?.MembershipTier</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Orders</span>
                        <span class="info-value">@UserProfile?.TotalOrders</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Spent</span>
                        <span class="info-value">@UserProfile?.DisplayTotalSpent</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Loyalty Points</span>
                        <span class="info-value">@UserProfile?.DisplayLoyaltyPoints</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-header">
                <span class="header-icon">@((MarkupString)settingsIconSvg)</span>
                <h2>Account Actions</h2>
            </div>
            <div class="section-content">
                <div class="settings-item" @onclick="ExportMyData">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)downloadIconSvg)</span>
                        <span>Export My Data</span>
                    </div>
                    <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                </div>
                <div class="settings-item danger-item" @onclick="ShowDeleteAccountConfirmation">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)deleteIconSvg)</span>
                        <span>Delete Account</span>
                    </div>
                    <span class="nav-arrow">@((MarkupString)arrowRightSvg)</span>
                </div>
            </div>
        </div>

        <div class="settings-section logout-section">
            <div class="section-content">
                <div class="settings-item logout-item" @onclick="ShowLogoutConfirmation">
                    <div class="item-left">
                        <span class="item-icon">@((MarkupString)logoutIconSvg)</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    }

    <DynamicModal @ref="ProfileModal"
                  IsOpen="IsProfileModalOpen"
                  Title="Edit Profile"
                  Size="DynamicModal.ModalSize.Medium"
                  ShowFooter="false"
                  OnClose="CloseProfileModal">
        <BodyContent>
            <div class="modal-form">
                <div class="profile-picture-upload">
                    <div class="current-picture">
                        @if (!string.IsNullOrEmpty(TempAvatarUrl))
                        {
                            <img src="@TempAvatarUrl" alt="Profile" />
                        }
                        else
                        {
                            <div class="avatar-initials">@UserProfile?.Initials</div>
                        }
                    </div>
                    <InputFile OnChange="HandleAvatarUpload" accept="image/*" class="file-input" id="avatar-upload" />
                    <label for="avatar-upload" class="upload-btn">
                        <span class="upload-icon">@((MarkupString)cameraIconSvg)</span>
                        Change Picture
                    </label>
                    @if (IsUploadingAvatar)
                    {
                        <small class="upload-status">Uploading...</small>
                    }
                    <small class="upload-hint">Max size: 1MB (JPG, PNG, WebP)</small>
                </div>

                <InputField Label="First Name"
                           @bind-Value="TempFirstName"
                           Placeholder="Enter your first name"
                           IsRequired="true"
                           MaxLength="50" />

                <InputField Label="Last Name"
                           @bind-Value="TempLastName"
                           Placeholder="Enter your last name"
                           IsRequired="true"
                           MaxLength="50" />

                <InputField Label="Nickname (Display Name)"
                           @bind-Value="TempNickname"
                           Placeholder="Optional display name"
                           HelperText="This will be shown instead of your real name"
                           MaxLength="50"
                           ShowCharacterCount="true" />

                <InputField Label="Phone Number"
                           @bind-Value="TempPhoneNumber"
                           Placeholder="+234 XXX XXX XXXX"
                           Type="tel"
                           MaxLength="20" />

                <div class="input-field">
                    <label class="input-label">Date of Birth</label>
                    <input type="date"
                           class="input-control"
                           @bind="TempDateOfBirth"
                           max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>

                <div class="input-field">
                    <label class="input-label">Gender</label>
                    <select class="input-control" @bind="TempGender">
                        <option value="">Prefer not to say</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                                    OnClick="CloseProfileModal"
                                    IsDisabled="IsSavingProfile">
                        Cancel
                    </SecondaryButton>
                    <PrimaryButton OnClick="SaveProfile"
                                  IsLoading="IsSavingProfile"
                                  IsDisabled="IsSavingProfile">
                        Save Changes
                    </PrimaryButton>
                </div>
            </div>
        </BodyContent>
    </DynamicModal>

    <DynamicModal @ref="CurrencyModal"
                  IsOpen="IsCurrencyModalOpen"
                  Title="Select Currency"
                  Size="DynamicModal.ModalSize.Small"
                  ShowFooter="false"
                  OnClose="CloseCurrencyModal">
        <BodyContent>
            <div class="modal-list">
                @foreach (var currency in AvailableCurrencies)
                {
                    <div class="list-item @(currency.Code == SelectedCurrency ? "selected" : "")"
                         @onclick="() => SelectCurrency(currency.Code)">
                        <div class="currency-info">
                            <span class="currency-code">@currency.Code</span>
                            <span class="currency-name">@currency.Name</span>
                        </div>
                        @if (currency.Code == SelectedCurrency)
                        {
                            <span class="check-icon">@((MarkupString)checkIconSvg)</span>
                        }
                    </div>
                }
            </div>
        </BodyContent>
    </DynamicModal>

    <DynamicModal @ref="LanguageModal"
                  IsOpen="IsLanguageModalOpen"
                  Title="Select Language"
                  Size="DynamicModal.ModalSize.Small"
                  ShowFooter="false"
                  OnClose="CloseLanguageModal">
        <BodyContent>
            <div class="modal-list">
                @foreach (var language in AvailableLanguages)
                {
                    <div class="list-item @(language == SelectedLanguage ? "selected" : "")"
                         @onclick="() => SelectLanguage(language)">
                        <span>@language</span>
                        @if (language == SelectedLanguage)
                        {
                            <span class="check-icon">@((MarkupString)checkIconSvg)</span>
                        }
                    </div>
                }
            </div>
        </BodyContent>
    </DynamicModal>

    <DynamicModal @ref="SecurityModal"
                  IsOpen="IsSecurityModalOpen"
                  Title="Change Password"
                  Size="DynamicModal.ModalSize.Small"
                  ShowFooter="false"
                  OnClose="CloseSecurityModal">
        <BodyContent>
            <div class="modal-form">
                <InputField Label="Current Password"
                           @bind-Value="CurrentPassword"
                           Type="password"
                           Placeholder="Enter current password"
                           IsRequired="true" />

                <InputField Label="New Password"
                           @bind-Value="NewPassword"
                           Type="password"
                           Placeholder="Enter new password"
                           IsRequired="true"
                           HelperText="Minimum 8 characters" />

                <InputField Label="Confirm New Password"
                           @bind-Value="ConfirmPassword"
                           Type="password"
                           Placeholder="Confirm new password"
                           IsRequired="true" />

                @if (!string.IsNullOrEmpty(PasswordChangeError))
                {
                    <div class="error-message">
                        <span class="error-icon">@((MarkupString)warningIconSvg)</span>
                        @PasswordChangeError
                    </div>
                }

                <div class="modal-actions">
                    <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                                    OnClick="CloseSecurityModal"
                                    IsDisabled="IsChangingPassword">
                        Cancel
                    </SecondaryButton>
                    <PrimaryButton OnClick="ChangePassword"
                                  IsLoading="IsChangingPassword"
                                  IsDisabled="IsChangingPassword">
                        Change Password
                    </PrimaryButton>
                </div>
            </div>
        </BodyContent>
    </DynamicModal>

    <DynamicModal @ref="MfaModal"
                  IsOpen="IsMfaModalOpen"
                  Title="Two-Factor Authentication"
                  Size="DynamicModal.ModalSize.Medium"
                  ShowFooter="false"
                  OnClose="CloseMfaModal">
        <BodyContent>
            <div class="modal-form mfa-content">
                @if (IsMfaEnabled)
                {
                    <div class="mfa-status enabled">
                        <span class="status-icon">@((MarkupString)shieldCheckIconSvg)</span>
                        <h3>Two-Factor Authentication is Active</h3>
                        <p>Your account is protected with TOTP authentication.</p>
                    </div>

                    <PrimaryButton Variant="PrimaryButton.ButtonVariant.Outline"
                                  OnClick="DisableMfa"
                                  IsLoading="IsProcessingMfa">
                        Disable Two-Factor Authentication
                    </PrimaryButton>
                }
                else
                {
                    @if (MfaEnrollmentStep == 0)
                    {
                        <div class="mfa-info">
                            <span class="info-icon-large">@((MarkupString)mfaIconSvg)</span>
                            <h3>Secure Your Account</h3>
                            <p>Add an extra layer of security by requiring a code from your authenticator app when signing in.</p>

                            <div class="mfa-features">
                                <div class="feature-item">
                                    <span class="feature-icon">@((MarkupString)checkIconSvg)</span>
                                    <span>Works with any TOTP app</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">@((MarkupString)checkIconSvg)</span>
                                    <span>No phone number required</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">@((MarkupString)checkIconSvg)</span>
                                    <span>100% Free</span>
                                </div>
                            </div>
                        </div>

                        <PrimaryButton OnClick="StartMfaEnrollment"
                                      IsLoading="IsProcessingMfa">
                            Enable Two-Factor Authentication
                        </PrimaryButton>
                    }
                    else if (MfaEnrollmentStep == 1)
                    {
                        <div class="mfa-enrollment">
                            <h4>Step 1: Scan QR Code</h4>
                            <p>Open your authenticator app and scan this QR code:</p>

                            @if (!string.IsNullOrEmpty(MfaQrCodeUrl))
                            {
                                <QRCodeComponent Data="@MfaQrCodeUrl"
                                                Size="256"
                                                ShowDownloadButton="true"
                                                CssClass="mfa-qr-code" />
                            }

                            @if (!string.IsNullOrEmpty(MfaSecret))
                            {
                                <div class="manual-entry">
                                    <p>Or enter this code manually:</p>
                                    <code class="secret-code">@MfaSecret</code>
                                </div>
                            }

                            <h4>Step 2: Enter Verification Code</h4>
                            <InputField Label="6-digit code from your app"
                                       @bind-Value="MfaVerificationCode"
                                       Placeholder="000000"
                                       MaxLength="6"
                                       IsRequired="true" />

                            @if (!string.IsNullOrEmpty(MfaEnrollmentError))
                            {
                                <div class="error-message">
                                    <span class="error-icon">@((MarkupString)warningIconSvg)</span>
                                    @MfaEnrollmentError
                                </div>
                            }

                            <div class="modal-actions">
                                <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                                                OnClick="CancelMfaEnrollment"
                                                IsDisabled="IsProcessingMfa">
                                    Cancel
                                </SecondaryButton>
                                <PrimaryButton OnClick="VerifyAndEnableMfa"
                                              IsLoading="IsProcessingMfa"
                                              IsDisabled="IsProcessingMfa || string.IsNullOrEmpty(MfaVerificationCode)">
                                    Verify & Enable
                                </PrimaryButton>
                            </div>
                        </div>
                    }
                }
            </div>
        </BodyContent>
    </DynamicModal>

    <ConfirmationPopup @ref="LogoutPopup"
                      IsOpen="ShowLogoutPopup"
                      Title="Logout"
                      Message="Are you sure you want to logout?"
                      Variant="ConfirmationPopup.ConfirmationVariant.Warning"
                      ConfirmButtonText="Logout"
                      CancelButtonText="Cancel"
                      OnConfirm="ConfirmLogout"
                      OnCancel="CancelLogout" />

    <ConfirmationPopup @ref="DeleteAccountPopup"
                      IsOpen="ShowDeleteAccountPopup"
                      Title="Delete Account"
                      Message="Are you sure you want to delete your account? This action cannot be undone."
                      WarningText="All your data, orders, and preferences will be permanently deleted."
                      Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                      ConfirmButtonText="Delete Account"
                      CancelButtonText="Cancel"
                      OnConfirm="ConfirmDeleteAccount"
                      OnCancel="CancelDeleteAccount"
                      IsProcessing="IsDeletingAccount" />
</div>
