@page "/user/offers"
@layout UserLayout
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Loading

<div class="offers-page">
    <div class="page-header">
        <div>
            <h1>Offers & Deals</h1>
            <p>Exclusive promotions just for you</p>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="offers-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" 
                          Message="Loading offers..." />
        </div>
    }
    else
    {
        <!-- Active Promo Codes -->
        @if (ActivePromoCodes.Any())
        {
            <div class="section">
                <h2 class="section-title">Your Promo Codes</h2>
                <div class="promo-codes-grid">
                    @foreach (var promo in ActivePromoCodes)
                    {
                        <div class="promo-card">
                            <div class="promo-badge">@promo.Discount</div>
                            <div class="promo-content">
                                <h3>@promo.Title</h3>
                                <p>@promo.Description</p>
                                <div class="promo-code-container">
                                    <code class="promo-code">@promo.Code</code>
                                    <button class="btn-copy" 
                                            @onclick="() => CopyPromoCode(promo.Code)"
                                            title="Copy code">
                                        üìã
                                    </button>
                                </div>
                                <span class="promo-expiry">Expires: @promo.ExpiryDate.ToString("MMM dd, yyyy")</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Flash Deals -->
        @if (FlashDeals.Any())
        {
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">‚ö° Flash Deals</h2>
                    <span class="timer">Ends in @TimeRemaining</span>
                </div>
                <div class="deals-grid">
                    @foreach (var deal in FlashDeals)
                    {
                        <div class="deal-card" @onclick="() => ViewDeal(deal.ProductId)">
                            <div class="deal-image">
                                <img src="@deal.ImageUrl" alt="@deal.ProductName" />
                                <span class="deal-discount">-@deal.DiscountPercentage%</span>
                            </div>
                            <div class="deal-info">
                                <h3>@deal.ProductName</h3>
                                <div class="deal-prices">
                                    <span class="deal-price">‚Ç¶@deal.SalePrice.ToString("N0")</span>
                                    <span class="deal-original">‚Ç¶@deal.OriginalPrice.ToString("N0")</span>
                                </div>
                                <div class="deal-stock">
                                    <div class="stock-bar">
                                        <div class="stock-fill" style="width: @deal.StockPercentage%"></div>
                                    </div>
                                    <span class="stock-text">Only @deal.StockRemaining left!</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Personalized Offers -->
        @if (PersonalizedOffers.Any())
        {
            <div class="section">
                <h2 class="section-title">üíù Just For You</h2>
                <div class="offers-grid">
                    @foreach (var offer in PersonalizedOffers)
                    {
                        <div class="offer-card" @onclick="() => ViewOffer(offer.Id)">
                            <div class="offer-icon">@offer.Icon</div>
                            <div class="offer-content">
                                <h3>@offer.Title</h3>
                                <p>@offer.Description</p>
                                <span class="offer-value">@offer.Value</span>
                            </div>
                            <div class="offer-arrow">‚Üí</div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Loyalty Rewards -->
        <div class="section">
            <h2 class="section-title">üéÅ Loyalty Rewards</h2>
            <div class="loyalty-card">
                <div class="loyalty-points">
                    <div class="points-icon">‚≠ê</div>
                    <div class="points-info">
                        <span class="points-label">Your Points</span>
                        <h3 class="points-value">@LoyaltyPoints</h3>
                    </div>
                </div>
                <div class="loyalty-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @ProgressPercentage%"></div>
                    </div>
                    <p class="progress-text">@PointsToNextTier points to @NextTier tier</p>
                </div>
                <PrimaryButton OnClick="ViewRewards" 
                              Size="PrimaryButton.ButtonSize.Medium">
                    View Rewards
                </PrimaryButton>
            </div>
        </div>

        <!-- Referral Program -->
        <div class="section">
            <h2 class="section-title">ü§ù Refer & Earn</h2>
            <div class="referral-card">
                <div class="referral-info">
                    <h3>Invite Friends, Get Rewards!</h3>
                    <p>Share your referral code and earn ‚Ç¶5,000 for each friend who makes their first purchase.</p>
                    <div class="referral-code-container">
                        <code class="referral-code">@ReferralCode</code>
                        <button class="btn-copy" 
                                @onclick="() => CopyPromoCode(ReferralCode)"
                                title="Copy referral code">
                            üìã
                        </button>
                    </div>
                </div>
                <div class="referral-stats">
                    <div class="stat">
                        <span class="stat-value">@ReferralCount</span>
                        <span class="stat-label">Referrals</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">‚Ç¶@ReferralEarnings.ToString("N0")</span>
                        <span class="stat-label">Earned</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private List<PromoCodeViewModel> ActivePromoCodes = new();
    private List<FlashDealViewModel> FlashDeals = new();
    private List<PersonalizedOfferViewModel> PersonalizedOffers = new();
    
    private bool IsLoading = true;
    private int LoyaltyPoints = 1250;
    private int PointsToNextTier = 750;
    private string NextTier = "Gold";
    private int ProgressPercentage = 62;
    private string ReferralCode = "REF-JOHN2024";
    private int ReferralCount = 3;
    private decimal ReferralEarnings = 15000;
    private string TimeRemaining = "2h 45m";

    protected override async Task OnInitializedAsync()
    {
        await LoadOffers();
    }

    private async Task LoadOffers()
    {
        IsLoading = true;
        try
        {
            // TODO: Load from actual service
            await Task.Delay(500);

            ActivePromoCodes = new()
            {
                new() { Code = "WELCOME20", Title = "Welcome Bonus", Description = "20% off your next purchase", Discount = "20% OFF", ExpiryDate = DateTime.Now.AddDays(7) },
                new() { Code = "FREESHIP", Title = "Free Shipping", Description = "Free delivery on orders over ‚Ç¶20,000", Discount = "FREE", ExpiryDate = DateTime.Now.AddDays(3) }
            };

            FlashDeals = new()
            {
                new() { ProductId = "1", ProductName = "Premium Cotton T-Shirt", ImageUrl = "/images/placeholder.jpg", OriginalPrice = 25000, SalePrice = 15000, DiscountPercentage = 40, StockRemaining = 12, StockPercentage = 30 },
                new() { ProductId = "2", ProductName = "Designer Jeans", ImageUrl = "/images/placeholder.jpg", OriginalPrice = 45000, SalePrice = 30000, DiscountPercentage = 33, StockRemaining = 8, StockPercentage = 20 }
            };

            PersonalizedOffers = new()
            {
                new() { Id = "1", Icon = "üéÇ", Title = "Birthday Bonus", Description = "Special 30% discount for your birthday month!", Value = "30% OFF" },
                new() { Id = "2", Icon = "üíé", Title = "VIP Early Access", Description = "Get first access to new arrivals", Value = "EXCLUSIVE" },
                new() { Id = "3", Icon = "üéÅ", Title = "Bundle Deal", Description = "Buy 3 items, get 1 free", Value = "BUY 3 GET 1" }
            };
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CopyPromoCode(string code)
    {
        // TODO: Implement actual clipboard copy
        Console.WriteLine($"Copied: {code}");
    }

    private void ViewDeal(string productId)
    {
        Navigation.NavigateTo($"/products/{productId}");
    }

    private void ViewOffer(string offerId)
    {
        // TODO: Navigate to offer details
    }

    private void ViewRewards()
    {
        // TODO: Navigate to rewards page
    }

    private class PromoCodeViewModel
    {
        public string Code { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Discount { get; set; } = "";
        public DateTime ExpiryDate { get; set; }
    }

    private class FlashDealViewModel
    {
        public string ProductId { get; set; } = "";
        public string ProductName { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public decimal OriginalPrice { get; set; }
        public decimal SalePrice { get; set; }
        public int DiscountPercentage { get; set; }
        public int StockRemaining { get; set; }
        public int StockPercentage { get; set; }
    }

    private class PersonalizedOfferViewModel
    {
        public string Id { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
