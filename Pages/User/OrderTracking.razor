@page "/user/orders/track/{OrderId}"
@layout SubashaVentures.Layout.User.UserLayout
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Domain.Order

<div class="order-tracking-page">
    @if (IsLoading)
    {
        <div class="tracking-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" 
                          Message="Loading tracking information..." />
        </div>
    }
    else if (Order == null)
    {
        <div class="tracking-error">
            <div class="error-icon">ðŸ“¦</div>
            <h2>Order Not Found</h2>
            <p>We couldn't find the order you're looking for.</p>
            <button class="btn-back" @onclick="NavigateToOrders">
                Back to Orders
            </button>
        </div>
    }
    else
    {
        @* Page Header *@
        <div class="tracking-header">
            <button class="btn-back-nav" @onclick="NavigateToOrders">
                <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Back to Orders
            </button>
            <div class="header-info">
                <h1>Track Order</h1>
                <p class="order-number">Order #@Order.OrderNumber</p>
            </div>
        </div>

        @* Delivery Progress Bar *@
        <div class="delivery-progress-section">
            <div class="progress-header">
                <h2>Delivery Progress</h2>
                <span class="progress-status @GetStatusClass(Order.Status)">
                    @Order.Status
                </span>
            </div>

            @* Animated Progress Bar with Truck *@
            <div class="progress-bar-container">
                <div class="progress-track">
                    <div class="progress-fill" style="width: @(ProgressPercentage)%"></div>
                    <div class="progress-truck" style="left: calc(@(ProgressPercentage)% - 20px)">
                        <svg class="truck-icon" width="40" height="40" viewBox="0 0 64 64" fill="none">
                            <rect x="8" y="24" width="28" height="20" rx="2" fill="currentColor"/>
                            <rect x="36" y="28" width="16" height="16" rx="2" fill="currentColor"/>
                            <circle cx="20" cy="48" r="4" fill="currentColor"/>
                            <circle cx="44" cy="48" r="4" fill="currentColor"/>
                            <path d="M36 32L40 28H48L52 32V44H36V32Z" fill="currentColor"/>
                        </svg>
                    </div>
                </div>
                
                @* Progress Milestones *@
                <div class="progress-milestones">
                    <div class="milestone @(ProgressPercentage >= 0 ? "completed" : "")">
                        <div class="milestone-dot"></div>
                        <span class="milestone-label">Order Placed</span>
                    </div>
                    <div class="milestone @(ProgressPercentage >= 33 ? "completed" : "")">
                        <div class="milestone-dot"></div>
                        <span class="milestone-label">Processing</span>
                    </div>
                    <div class="milestone @(ProgressPercentage >= 66 ? "completed" : "")">
                        <div class="milestone-dot"></div>
                        <span class="milestone-label">Shipped</span>
                    </div>
                    <div class="milestone @(ProgressPercentage >= 100 ? "completed" : "")">
                        <div class="milestone-dot"></div>
                        <span class="milestone-label">Delivered</span>
                    </div>
                </div>
            </div>

            @* Estimated Delivery Time *@
            <div class="delivery-estimate">
                @if (Order.Status == OrderStatus.Delivered && Order.DeliveredAt.HasValue)
                {
                    <div class="estimate-completed">
                        <svg class="icon-success" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="estimate-text">
                            <strong>Delivered!</strong>
                            <p>Your order was delivered on @Order.DeliveredAt.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                        </div>
                    </div>
                }
                else if (EstimatedDelivery.HasValue)
                {
                    <div class="estimate-pending">
                        <svg class="icon-clock" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <div class="estimate-text">
                            <strong>Estimated Delivery</strong>
                            <p>@EstimatedDelivery.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                            <span class="time-remaining">@GetTimeRemaining()</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Order Timeline *@
        <div class="order-timeline-section">
            <h2>Order Timeline</h2>
            <div class="timeline">
                @foreach (var update in OrderUpdates)
                {
                    <div class="timeline-item @(update.IsCurrent ? "current" : "")">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <strong class="timeline-title">@update.Title</strong>
                                <span class="timeline-time">@update.Timestamp.ToString("MMM dd, hh:mm tt")</span>
                            </div>
                            @if (!string.IsNullOrEmpty(update.Description))
                            {
                                <p class="timeline-description">@update.Description</p>
                            }
                            @if (!string.IsNullOrEmpty(update.Location))
                            {
                                <span class="timeline-location">
                                    <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 13.43C13.7231 13.43 15.12 12.0331 15.12 10.31C15.12 8.58687 13.7231 7.19 12 7.19C10.2769 7.19 8.88 8.58687 8.88 10.31C8.88 12.0331 10.2769 13.43 12 13.43Z" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M3.62 8.49C5.59 -0.169998 18.42 -0.159997 20.38 8.5C21.53 13.58 18.37 17.88 15.6 20.54C13.59 22.48 10.41 22.48 8.39 20.54C5.63 17.88 2.47 13.57 3.62 8.49Z" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    @update.Location
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Shipping Details *@
        <div class="shipping-details-section">
            <h2>Shipping Details</h2>
            <div class="details-grid">
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 13.43C13.7231 13.43 15.12 12.0331 15.12 10.31C15.12 8.58687 13.7231 7.19 12 7.19C10.2769 7.19 8.88 8.58687 8.88 10.31C8.88 12.0331 10.2769 13.43 12 13.43Z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M3.62 8.49C5.59 -0.169998 18.42 -0.159997 20.38 8.5C21.53 13.58 18.37 17.88 15.6 20.54C13.59 22.48 10.41 22.48 8.39 20.54C5.63 17.88 2.47 13.57 3.62 8.49Z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Delivery Address</span>
                        <p class="detail-value">@Order.ShippingAddress</p>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12.37 2.15L21.37 5.75C22.16 6.06 22.16 6.69 21.37 7L12.37 10.6C12.15 10.69 11.85 10.69 11.63 10.6L2.63 7C1.84 6.69 1.84 6.06 2.63 5.75L11.63 2.15C11.85 2.06 12.15 2.06 12.37 2.15Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 11L3 17C3 17.83 3.94 18.3 4.4 18.4L10.55 20.82C11.35 21.13 12.64 21.13 13.44 20.82L19.59 18.4C20.05 18.3 20.99 17.83 20.99 17L20.99 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Shipping Method</span>
                        <p class="detail-value">@Order.ShippingMethod</p>
                        <span class="detail-meta">@DeliveryWindowText</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Order.TrackingNumber))
                {
                    <div class="detail-card">
                        <div class="detail-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 10C10.1046 10 11 9.10457 11 8C11 6.89543 10.1046 6 9 6C7.89543 6 7 6.89543 7 8C7 9.10457 7.89543 10 9 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2.67 18.95L7.6 15.64C8.39 15.11 9.53 15.17 10.24 15.78L10.57 16.07C11.35 16.74 12.61 16.74 13.39 16.07L17.55 12.5C18.33 11.83 19.59 11.83 20.37 12.5L22 13.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">Tracking Number</span>
                            <p class="detail-value tracking-number">@Order.TrackingNumber</p>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Order.CourierName))
                {
                    <div class="detail-card">
                        <div class="detail-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M20.59 22C20.59 18.13 16.74 15 12 15C7.26 15 3.41 18.13 3.41 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">Courier</span>
                            <p class="detail-value">@Order.CourierName</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Contact Support *@
        <div class="support-section">
            <div class="support-card">
                <div class="support-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <path d="M21.97 18.33C21.97 18.69 21.89 19.06 21.72 19.42C21.55 19.78 21.33 20.12 21.04 20.44C20.55 20.98 20.01 21.37 19.4 21.62C18.8 21.87 18.15 22 17.45 22C16.43 22 15.34 21.76 14.19 21.27C13.04 20.78 11.89 20.12 10.75 19.29C9.6 18.45 8.51 17.52 7.47 16.49C6.44 15.45 5.51 14.36 4.68 13.22C3.86 12.08 3.2 10.94 2.72 9.81C2.24 8.67 2 7.58 2 6.54C2 5.86 2.12 5.21 2.36 4.61C2.6 4 2.98 3.44 3.51 2.94C4.15 2.31 4.85 2 5.59 2C5.87 2 6.15 2.06 6.4 2.18C6.66 2.3 6.89 2.48 7.07 2.74L9.39 6.01C9.57 6.26 9.7 6.49 9.79 6.71C9.88 6.92 9.93 7.13 9.93 7.32C9.93 7.56 9.86 7.8 9.72 8.03C9.59 8.26 9.4 8.5 9.16 8.74L8.4 9.53C8.29 9.64 8.24 9.77 8.24 9.93C8.24 10.01 8.25 10.08 8.27 10.16C8.3 10.24 8.33 10.3 8.35 10.36C8.53 10.69 8.84 11.12 9.28 11.64C9.73 12.16 10.21 12.69 10.73 13.22C11.27 13.75 11.79 14.24 12.32 14.69C12.84 15.13 13.27 15.43 13.61 15.61C13.66 15.63 13.72 15.66 13.79 15.69C13.87 15.72 13.95 15.73 14.04 15.73C14.21 15.73 14.34 15.67 14.45 15.56L15.21 14.81C15.46 14.56 15.7 14.37 15.93 14.25C16.16 14.11 16.39 14.04 16.64 14.04C16.83 14.04 17.03 14.08 17.25 14.17C17.47 14.26 17.7 14.39 17.95 14.56L21.26 16.91C21.52 17.09 21.7 17.3 21.81 17.55C21.91 17.8 21.97 18.05 21.97 18.33Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"/>
                    </svg>
                </div>
                <div class="support-content">
                    <h3>Need Help?</h3>
                    <p>If you have any questions about your order, our customer support team is here to help.</p>
                    <button class="btn-contact-support" @onclick="ContactSupport">
                        Contact Support
                    </button>
                </div>
            </div>
        </div>
    }
</div>
