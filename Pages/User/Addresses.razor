@page "/user/addresses"
@layout SubashaVentures.Layout.User.UserLayout
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Domain.User
@using SubashaVentures.Domain.Enums
@using SubashaVentures.Services.VisualElements
@inject NavigationManager Navigation
@inject IVisualElementsService VisualElements

<div class="addresses-page">
    <div class="page-header">
        <div>
            <h1>My Addresses</h1>
            <p>Manage your delivery and billing addresses</p>
        </div>
        <PrimaryButton OnClick="OpenAddAddressModal" Icon="+" Size="PrimaryButton.ButtonSize.Medium">
            Add New Address
        </PrimaryButton>
    </div>

    @if (IsLoading)
    {
        <div class="addresses-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading addresses..." />
        </div>
    }
    else if (!AddressList.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">
                @((MarkupString)addressIconLarge)
            </div>
            <h2>No Addresses Yet</h2>
            <p>Add your first delivery address to make checkout faster</p>
            <PrimaryButton OnClick="OpenAddAddressModal" Size="PrimaryButton.ButtonSize.Large">
                Add Address
            </PrimaryButton>
        </div>
    }
    else
    {
        <div class="addresses-grid">
            @foreach (var address in AddressList)
            {
                <div class="address-card @(address.IsDefault ? "default" : "")">
                    @if (address.IsDefault)
                    {
                        <span class="default-badge">
                            <span class="badge-icon">@((MarkupString)starIcon)</span>
                            <span>Default</span>
                        </span>
                    }
                    
                    <div class="address-checkbox">
                        <input type="checkbox" 
                               id="addr-@address.Id" 
                               @bind="SelectedAddresses[address.Id]" />
                    </div>

                    <div class="address-content">
                        <h3>@address.FullName</h3>
                        <p class="address-phone">
                            <span class="address-icon">@((MarkupString)phoneIcon)</span>
                            <span>@address.PhoneNumber</span>
                        </p>
                        @if (!string.IsNullOrEmpty(address.Email))
                        {
                            <p class="address-email">
                                <span class="address-icon">@((MarkupString)mailIcon)</span>
                                <span>@address.Email</span>
                            </p>
                        }
                        <p class="address-text">
                            <span class="address-icon">@((MarkupString)addressIcon)</span>
                            <span>
                                @address.AddressLine1<br />
                                @if (!string.IsNullOrEmpty(address.AddressLine2))
                                {
                                    @address.AddressLine2<br />
                                }
                                @address.City, @address.State @address.PostalCode<br />
                                @address.Country
                            </span>
                        </p>
                        <span class="address-type">@address.Type</span>
                    </div>

                    <div class="address-actions">
                        <button class="btn-icon" @onclick="() => EditAddress(address)" title="Edit">
                            @((MarkupString)editIcon)
                        </button>
                        @if (!address.IsDefault)
                        {
                            <button class="btn-icon" @onclick="() => SetDefaultAddress(address.Id)" title="Set as default">
                                @((MarkupString)starIcon)
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        @if (SelectedAddresses.Any(x => x.Value))
        {
            <div class="bulk-actions">
                <SecondaryButton OnClick="DeleteSelectedAddresses" 
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                Size="SecondaryButton.ButtonSize.Medium">
                    Delete Selected (@SelectedAddresses.Count(x => x.Value))
                </SecondaryButton>
            </div>
        }
    }
</div>

<DynamicModal @ref="AddressModal"
              Title="@(IsEditMode ? "Edit Address" : "Add New Address")"
              Size="DynamicModal.ModalSize.Medium"
              IsOpen="@IsModalOpen"
              OnConfirm="SaveAddress"
              OnCancel="CloseModal"
              ConfirmText="@(IsEditMode ? "Update" : "Add Address")"
              IsProcessing="@IsSaving">
    <BodyContent>
        <div class="address-form">
            <div class="form-notice">
                <span class="notice-icon">@((MarkupString)lockIcon)</span>
                <p>Your address information is securely stored and used only for delivery purposes.</p>
            </div>

            <!-- Auto-Fill Button -->
            <div class="auto-fill-section">
                <button class="btn-auto-fill" 
                        @onclick="AutoFillAddress" 
                        disabled="@IsAutoFilling"
                        type="button">
                    @if (IsAutoFilling)
                    {
                        <span class="spinner"></span>
                        <span>Detecting Location...</span>
                    }
                    else
                    {
                        <span class="icon">@((MarkupString)globeIcon)</span>
                        <span>Auto-Fill from Location</span>
                    }
                </button>
                <p class="auto-fill-hint">Automatically detect and fill your address details</p>
            </div>

            <InputField @bind-Value="CurrentAddress.FullName"
                       Label="Full Name"
                       Placeholder="Enter full name"
                       IsRequired="true"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("name"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("name"))" />

            <div class="phone-input-wrapper">
                <label class="input-label">
                    Phone Number <span class="required-mark">*</span>
                </label>
                <div class="phone-input-container">
                    <span class="phone-prefix">
                        <span class="prefix-icon">@((MarkupString)phoneIcon)</span>
                        <span class="prefix-text">+234</span>
                    </span>
                    <input type="tel" 
                           class="phone-input"
                           placeholder="801 234 5678"
                           value="@(CurrentAddress.PhoneNumber?.Replace("+234", ""))"
                           @oninput="@(e => HandlePhoneNumberChange("+234" + e.Value?.ToString()))"
                           maxlength="10"
                           pattern="[0-9]*" />
                </div>
                @if (!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Phone"))))
                {
                    <span class="error-message">
                        <span class="error-icon">@((MarkupString)warningIcon)</span>
                        @ValidationErrors.FirstOrDefault(e => e.Contains("Phone"))
                    </span>
                }
                <span class="helper-text">Enter 10 digits after +234</span>
            </div>

            <InputField @bind-Value="CurrentAddress.Email"
                       Label="Email (Optional)"
                       Type="email"
                       Placeholder="your.email@example.com"
                       IsRequired="false" />

            <InputField @bind-Value="CurrentAddress.AddressLine1"
                       Label="Delivery Address"
                       Placeholder="Street address, house number, etc."
                       IsRequired="true"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Address"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("Address"))" />

            <InputField @bind-Value="CurrentAddress.AddressLine2"
                       Label="Address Line 2 (Optional)"
                       Placeholder="Apartment, suite, unit, building, floor, etc." />

            <div class="form-row">
                <div class="form-field">
                    <label>State <span class="required">*</span></label>
                    <select @bind="CurrentAddress.State" class="form-select" required>
                        <option value="">Select State</option>
                        @foreach (var state in NigerianStates)
                        {
                            <option value="@state">@state</option>
                        }
                    </select>
                    @if (!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("State"))))
                    {
                        <span class="error-message">
                            <span class="error-icon">@((MarkupString)warningIcon)</span>
                            @ValidationErrors.FirstOrDefault(e => e.Contains("State"))
                        </span>
                    }
                </div>

                <InputField @bind-Value="CurrentAddress.City"
                           Label="City"
                           Placeholder="Enter city"
                           IsRequired="true"
                           HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("City"))))"
                           ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("City"))" />
            </div>

            <InputField @bind-Value="CurrentAddress.PostalCode"
                       Label="Postal Code"
                       Placeholder="Enter postal code (e.g., 100001)"
                       IsRequired="true"
                       MaxLength="6"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Postal"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("Postal"))" />

            <div class="form-field">
                <label>Address Type</label>
                <div class="address-type-options">
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Shipping" 
                               @onchange="() => CurrentAddress.Type = AddressType.Shipping" 
                               checked="@(CurrentAddress.Type == AddressType.Shipping)" />
                        <span>Shipping</span>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Billing" 
                               @onchange="() => CurrentAddress.Type = AddressType.Billing"
                               checked="@(CurrentAddress.Type == AddressType.Billing)" />
                        <span>Billing</span>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Both" 
                               @onchange="() => CurrentAddress.Type = AddressType.Both"
                               checked="@(CurrentAddress.Type == AddressType.Both)" />
                        <span>Both</span>
                    </label>
                </div>
            </div>

            <div class="form-checkbox">
                <label>
                    <input type="checkbox" @bind="CurrentAddress.IsDefault" />
                    <span>Set as default address</span>
                </label>
            </div>
        </div>
    </BodyContent>
</DynamicModal>

<ConfirmationPopup @ref="DeleteConfirmPopup"
                   Title="Delete Addresses"
                   Message="Are you sure you want to delete the selected address(es)? This action cannot be undone."
                   Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                   ConfirmButtonText="Delete"
                   OnConfirm="ConfirmDeleteAddresses" />

<!-- Auto-Fill Info Popup with higher z-index -->
<InfoPopup @ref="AutoFillInfoPopup"
           Title="@AutoFillPopupTitle"
           Icon="@AutoFillPopupIcon"
           Message="@AutoFillPopupMessage"
           ShowCancelButton="false"
           ConfirmButtonText="OK"
           OnConfirm="CloseAutoFillPopup" 
           CssClass="high-z-index" />

@code {
    // SVG icons
    private string addressIcon = string.Empty;
    private string addressIconLarge = string.Empty;
    private string phoneIcon = string.Empty;
    private string mailIcon = string.Empty;
    private string starIcon = string.Empty;
    private string editIcon = string.Empty;
    private string lockIcon = string.Empty;
    private string globeIcon = string.Empty;
    private string warningIcon = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSvgIcons();
        await base.OnInitializedAsync();
    }

    private async Task LoadSvgIcons()
    {
        try
        {
            addressIcon = await VisualElements.GetCustomSvgAsync(
                SvgType.Address, width: 16, height: 16, fillColor: "currentColor"
            );

            addressIconLarge = await VisualElements.GetCustomSvgAsync(
                SvgType.Address, width: 64, height: 64, fillColor: "var(--primary-color)"
            );

            phoneIcon = VisualElements.GenerateSvg(
                "<path fill='currentColor' d='M6.62 10.79c1.44 2.83 3.76 5.15 6.59 6.59l2.2-2.2c.28-.28.67-.36 1.02-.25 1.12.37 2.32.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z'/>",
                16, 16, "0 0 24 24"
            );

            mailIcon = await VisualElements.GetCustomSvgAsync(
                SvgType.Mail, width: 16, height: 16, fillColor: "currentColor"
            );

            starIcon = await VisualElements.GetCustomSvgAsync(
                SvgType.Star, width: 16, height: 16, fillColor: "currentColor"
            );

            editIcon = VisualElements.GenerateSvg(
                "<path fill='currentColor' d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z'/>",
                18, 18, "0 0 24 24"
            );

            lockIcon = VisualElements.GenerateSvg(
                "<path fill='currentColor' d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z'/>",
                20, 20, "0 0 24 24"
            );

            globeIcon = VisualElements.GenerateSvg(
                "<path fill='currentColor' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/>",
                20, 20, "0 0 24 24"
            );

            warningIcon = await VisualElements.GetCustomSvgAsync(
                SvgType.Warning, width: 16, height: 16, fillColor: "currentColor"
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading SVG icons: {ex.Message}");
        }
    }
}
