@page "/user/addresses"
@layout SubashaVentures.Layout.User.UserLayout
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Domain.User
@using SubashaVentures.Domain.Enums

<div class="addresses-page">
    <div class="page-header">
        <div>
            <h1>My Addresses</h1>
            <p>Manage your delivery and billing addresses</p>
        </div>
        <PrimaryButton OnClick="OpenAddAddressModal" Icon="+" Size="PrimaryButton.ButtonSize.Medium">
            Add New Address
        </PrimaryButton>
    </div>

    @if (IsLoading)
    {
        <div class="addresses-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading addresses..." />
        </div>
    }
    else if (!AddressList.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">
                @((MarkupString)addressIconLarge)
            </div>
            <h2>No Addresses Yet</h2>
            <p>Add your first delivery address to make checkout faster</p>
            <PrimaryButton OnClick="OpenAddAddressModal" Size="PrimaryButton.ButtonSize.Large">
                Add Address
            </PrimaryButton>
        </div>
    }
    else
    {
        <div class="addresses-grid">
            @foreach (var address in AddressList)
            {
                <div class="address-card @(address.IsDefault ? "default" : "")">
                    @if (address.IsDefault)
                    {
                        <span class="default-badge">
                            <span class="badge-icon">@((MarkupString)starIcon)</span>
                            <span>Default</span>
                        </span>
                    }
                    
                    <div class="address-checkbox">
                        <input type="checkbox" 
                               id="addr-@address.Id" 
                               @bind="SelectedAddresses[address.Id]" />
                    </div>

                    <div class="address-content">
                        <h3>@address.FullName</h3>
                        <p class="address-phone">
                            <span class="address-icon">@((MarkupString)phoneIcon)</span>
                            <span>@address.PhoneNumber</span>
                        </p>
                        @if (!string.IsNullOrEmpty(address.Email))
                        {
                            <p class="address-email">
                                <span class="address-icon">@((MarkupString)mailIcon)</span>
                                <span>@address.Email</span>
                            </p>
                        }
                        <p class="address-text">
                            <span class="address-icon">@((MarkupString)addressIcon)</span>
                            <span>
                                @address.AddressLine1<br />
                                @if (!string.IsNullOrEmpty(address.AddressLine2))
                                {
                                    @address.AddressLine2<br />
                                }
                                @address.City, @address.State @address.PostalCode<br />
                                @address.Country
                            </span>
                        </p>
                        <span class="address-type">@address.Type</span>
                    </div>

                    <div class="address-actions">
                        <button class="btn-icon" @onclick="() => EditAddress(address)" title="Edit">
                            @((MarkupString)editIcon)
                        </button>
                        @if (!address.IsDefault)
                        {
                            <button class="btn-icon" @onclick="() => SetDefaultAddress(address.Id)" title="Set as default">
                                @((MarkupString)starIcon)
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        @if (SelectedAddresses.Any(x => x.Value))
        {
            <div class="bulk-actions">
                <SecondaryButton OnClick="DeleteSelectedAddresses" 
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                Size="SecondaryButton.ButtonSize.Medium">
                    Delete Selected (@SelectedAddresses.Count(x => x.Value))
                </SecondaryButton>
            </div>
        }
    }
</div>

<DynamicModal @ref="AddressModal"
              Title="@(IsEditMode ? "Edit Address" : "Add New Address")"
              Size="DynamicModal.ModalSize.Medium"
              IsOpen="@IsModalOpen"
              OnConfirm="SaveAddress"
              OnCancel="CloseModal"
              ConfirmText="@(IsEditMode ? "Update" : "Add Address")"
              IsProcessing="@IsSaving">
    <BodyContent>
        <div class="address-form">
            <div class="form-notice">
                <span class="notice-icon">@((MarkupString)lockIcon)</span>
                <p>Your address information is securely stored and used only for delivery purposes.</p>
            </div>

            <!-- Auto-Fill Button -->
            <div class="auto-fill-section">
                <button class="btn-auto-fill" 
                        @onclick="AutoFillAddress" 
                        disabled="@IsAutoFilling"
                        type="button">
                    @if (IsAutoFilling)
                    {
                        <span class="spinner"></span>
                        <span>Detecting Location...</span>
                    }
                    else
                    {
                        <span class="icon">@((MarkupString)globeIcon)</span>
                        <span>Auto-Fill from Location</span>
                    }
                </button>
                <p class="auto-fill-hint">Automatically detect and fill your address details</p>
            </div>

            <InputField @bind-Value="CurrentAddress.FullName"
                       Label="Full Name"
                       Placeholder="Enter full name"
                       IsRequired="true"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("name"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("name"))" />

            <div class="phone-input-wrapper">
                <label class="input-label">
                    Phone Number <span class="required-mark">*</span>
                </label>
                <div class="phone-input-container">
                    <span class="phone-prefix">
                        <span class="prefix-icon">@((MarkupString)phoneIcon)</span>
                        <span class="prefix-text">+234</span>
                    </span>
                    <input type="tel" 
                           class="phone-input"
                           placeholder="801 234 5678"
                           value="@(CurrentAddress.PhoneNumber?.Replace("+234", ""))"
                           @oninput="@(e => HandlePhoneNumberChange("+234" + e.Value?.ToString()))"
                           maxlength="10"
                           pattern="[0-9]*" />
                </div>
                @if (!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Phone"))))
                {
                    <span class="error-message">
                        <span class="error-icon">@((MarkupString)warningIcon)</span>
                        @ValidationErrors.FirstOrDefault(e => e.Contains("Phone"))
                    </span>
                }
                <span class="helper-text">Enter 10 digits after +234</span>
            </div>

            <InputField @bind-Value="CurrentAddress.Email"
                       Label="Email (Optional)"
                       Type="email"
                       Placeholder="your.email@example.com"
                       IsRequired="false" />

            <InputField @bind-Value="CurrentAddress.AddressLine1"
                       Label="Delivery Address"
                       Placeholder="Street address, house number, etc."
                       IsRequired="true"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Address"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("Address"))" />

            <InputField @bind-Value="CurrentAddress.AddressLine2"
                       Label="Address Line 2 (Optional)"
                       Placeholder="Apartment, suite, unit, building, floor, etc." />

            <div class="form-row">
                <div class="form-field">
                    <label>State <span class="required">*</span></label>
                    <select @bind="CurrentAddress.State" class="form-select" required>
                        <option value="">Select State</option>
                        @foreach (var state in NigerianStates)
                        {
                            <option value="@state">@state</option>
                        }
                    </select>
                    @if (!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("State"))))
                    {
                        <span class="error-message">
                            <span class="error-icon">@((MarkupString)warningIcon)</span>
                            @ValidationErrors.FirstOrDefault(e => e.Contains("State"))
                        </span>
                    }
                </div>

                <InputField @bind-Value="CurrentAddress.City"
                           Label="City"
                           Placeholder="Enter city"
                           IsRequired="true"
                           HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("City"))))"
                           ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("City"))" />
            </div>

            <InputField @bind-Value="CurrentAddress.PostalCode"
                       Label="Postal Code"
                       Placeholder="Enter postal code (e.g., 100001)"
                       IsRequired="true"
                       MaxLength="6"
                       HasError="@(!string.IsNullOrEmpty(ValidationErrors.FirstOrDefault(e => e.Contains("Postal"))))"
                       ErrorMessage="@ValidationErrors.FirstOrDefault(e => e.Contains("Postal"))" />

            <div class="form-field">
                <label>Address Type</label>
                <div class="address-type-options">
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Shipping" 
                               @onchange="() => CurrentAddress.Type = AddressType.Shipping" 
                               checked="@(CurrentAddress.Type == AddressType.Shipping)" />
                        <span>Shipping</span>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Billing" 
                               @onchange="() => CurrentAddress.Type = AddressType.Billing"
                               checked="@(CurrentAddress.Type == AddressType.Billing)" />
                        <span>Billing</span>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="addressType" value="Both" 
                               @onchange="() => CurrentAddress.Type = AddressType.Both"
                               checked="@(CurrentAddress.Type == AddressType.Both)" />
                        <span>Both</span>
                    </label>
                </div>
            </div>

            <div class="form-checkbox">
                <label>
                    <input type="checkbox" @bind="CurrentAddress.IsDefault" />
                    <span>Set as default address</span>
                </label>
            </div>
        </div>
    </BodyContent>
</DynamicModal>

<ConfirmationPopup @ref="DeleteConfirmPopup"
                   Title="Delete Addresses"
                   Message="Are you sure you want to delete the selected address(es)? This action cannot be undone."
                   Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                   ConfirmButtonText="Delete"
                   OnConfirm="ConfirmDeleteAddresses" />

<!-- Auto-Fill Info Popup with higher z-index -->
<InfoPopup @ref="AutoFillInfoPopup"
           Title="@AutoFillPopupTitle"
           Icon="@AutoFillPopupIcon"
           Message="@AutoFillPopupMessage"
           ShowCancelButton="false"
           ConfirmButtonText="OK"
           OnConfirm="CloseAutoFillPopup" />
