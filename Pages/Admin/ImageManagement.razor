@page "/admin/images"
@using SubashaVentures.Layout.Admin
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Admin.Images
@layout AdminLayout

<div class="image-management">
    <!-- Header -->
    <div class="im-header">
        <div class="im-header-left">
            <h1 class="im-title">Image Management</h1>
            <p class="im-subtitle">Upload and manage product images</p>
        </div>
        <div class="im-header-right">
            <PrimaryButton Variant="PrimaryButton.ButtonVariant.Primary"
                          Size="PrimaryButton.ButtonSize.Medium"
                          Icon="‚¨Ü"
                          OnClick="OpenUploadModal">
                Upload Images
            </PrimaryButton>
        </div>
    </div>

    <!-- Storage Stats -->
    <div class="im-stats">
        <div class="stat-card storage">
            <div class="stat-header">
                <span class="stat-label">Storage Used</span>
                <span class="stat-icon">üíæ</span>
            </div>
            <div class="stat-body">
                <div class="storage-bar">
                    <div class="storage-fill" style="width: @storagePercentage%"></div>
                </div>
                <div class="storage-info">
                    <span class="used">@usedStorage</span>
                    <span class="total">of @totalStorage</span>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üñºÔ∏è</div>
            <div class="stat-info">
                <span class="stat-label">Total Images</span>
                <span class="stat-value">@totalImages</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìÇ</div>
            <div class="stat-info">
                <span class="stat-label">Categories</span>
                <span class="stat-value">@totalFolders</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üîó</div>
            <div class="stat-info">
                <span class="stat-label">Referenced</span>
                <span class="stat-value">@referencedImages</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="im-toolbar">
        <div class="im-filters">
            <select class="filter-select folder-select" @onchange="HandleFolderChange">
                <option value="">All Folders</option>
                <option value="products">Products (General)</option>
                <option value="products/mens">Men's Fashion</option>
                <option value="products/womens">Women's Fashion</option>
                <option value="products/children">Children's</option>
                <option value="products/baby">Baby & Toddler</option>
                <option value="products/home">Home & Living</option>
                <option value="banners">Banners</option>
                <option value="categories">Categories</option>
            </select>

            <InputField @bind-Value="searchQuery"
                       Placeholder="Search images..."
                       PrefixIcon="üîç"
                       ShowClearButton="true"
                       CssClass="search-input"
                       @bind-Value:after="ApplyFiltersAndSort" />

            <select class="filter-select" @onchange="HandleSortChange">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name-az">Name (A-Z)</option>
                <option value="name-za">Name (Z-A)</option>
                <option value="size-largest">Largest First</option>
                <option value="size-smallest">Smallest First</option>
            </select>
        </div>

        <div class="im-view-controls">
            @if (selectedImages.Any())
            {
                <span class="selection-count">@selectedImages.Count selected</span>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkDownload">
                    Download
                </SecondaryButton>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkDelete"
                                CssClass="btn-danger">
                    Delete
                </SecondaryButton>
            }

            <button class="view-toggle @(gridSize == "small" ? "active" : "")" 
                    @onclick="@(() => { gridSize = "small"; StateHasChanged(); })">
                ‚ñ¶‚ñ¶
            </button>
            <button class="view-toggle @(gridSize == "medium" ? "active" : "")" 
                    @onclick="@(() => { gridSize = "medium"; StateHasChanged(); })">
                ‚ñ¶
            </button>
            <button class="view-toggle @(gridSize == "large" ? "active" : "")" 
                    @onclick="@(() => { gridSize = "large"; StateHasChanged(); })">
                ‚ñ¢
            </button>
        </div>
    </div>

    <!-- Image Grid using AdminImageCard -->
    @if (isLoading)
    {
        <div class="im-loading">
            <div class="loading-spinner"></div>
            <p>Loading images...</p>
        </div>
    }
    else if (!filteredImages.Any())
    {
        <div class="im-empty">
            <div class="empty-icon">üñºÔ∏è</div>
            <h3>No images found</h3>
            <p>@(string.IsNullOrEmpty(searchQuery) ? "Upload your first image to get started" : "No images match your search")</p>
            <PrimaryButton OnClick="OpenUploadModal">
                Upload Images
            </PrimaryButton>
        </div>
    }
    else
    {
        <div class="im-grid @gridSize">
            @foreach (var image in paginatedImages)
            {
                <AdminImageCard Image="@image"
                               IsSelected="@selectedImages.Contains(image.Id)"
                               OnCopyUrl="@(() => HandleCopyUrl(image))"
                               OnDownload="@(() => HandleDownload(image))"
                               OnDelete="@(() => HandleDelete(image))"
                               OnSelectionChanged="@((args) => HandleImageSelect(args.imageId, new ChangeEventArgs { Value = args.isSelected }))" />
            }
        </div>

        <!-- Pagination -->
        <div class="im-pagination">
            <div class="pagination-info">
                Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredImages.Count) of @filteredImages.Count images
            </div>
            <div class="pagination-controls">
                <button class="page-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(currentPage == 1)">
                    ‚Üê Previous
                </button>
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNumber = i;
                    <button class="page-btn @(pageNumber == currentPage ? "active" : "")" 
                            @onclick="@(() => GoToPage(pageNumber))">
                        @pageNumber
                    </button>
                }
                
                <button class="page-btn" 
                        @onclick="NextPage" 
                        disabled="@(currentPage == totalPages)">
                    Next ‚Üí
                </button>
            </div>
        </div>
    }
</div>

<!-- Upload Modal -->
<DynamicModal @ref="uploadModal"
              Title="Upload Images"
              Size="DynamicModal.ModalSize.Large"
              IsOpen="@isUploadModalOpen"
              ShowFooter="false"
              OnClose="CloseUploadModal">
    <BodyContent>
        <div class="upload-modal-content">
            
            <!-- Folder Selection -->
            <div class="upload-section">
                <label class="upload-label">Upload to Folder</label>
                <select class="upload-select" @bind="uploadFolder">
                    <option value="products">Products (General)</option>
                    <option value="products/mens">Men's Fashion</option>
                    <option value="products/womens">Women's Fashion</option>
                    <option value="products/children">Children's</option>
                    <option value="products/baby">Baby & Toddler</option>
                    <option value="products/home">Home & Living</option>
                    <option value="banners">Banners</option>
                    <option value="categories">Categories</option>
                </select>
            </div>

            <!-- Compression Toggle -->
            <div class="upload-section">
                <label class="compression-toggle">
                    <input type="checkbox"
                           @bind="enableCompression"
                           class="compression-checkbox" />
                    <span class="compression-label">
                        Enable Image Compression (Recommended)
                    </span>
                    <span class="compression-hint">
                        Reduces file size while maintaining quality
                    </span>
                </label>
            </div>

            <!-- File Dropzone -->
            <div class="upload-dropzone-wrapper"
                 @ondragover:preventDefault="true"
                 @ondragenter:preventDefault="true"
                 @ondrop="HandleDrop"
                 @ondragenter="HandleDragEnter"
                 @ondragleave="HandleDragLeave">
                
                <InputFile OnChange="HandleFileSelect"
                          multiple
                          accept="image/*"
                          id="imageUploadInput"
                          class="file-input-native" />
                
                <label for="imageUploadInput" 
                       class="upload-dropzone @(isDragging ? "dragging" : "")">
                    <div class="dropzone-content">
                        <div class="dropzone-icon">üìÅ</div>
                        <h3>Drag & drop images here</h3>
                        <p>or</p>
                        <div class="browse-btn-wrapper">
                            <span class="browse-btn">Browse Files</span>
                        </div>
                        <p class="upload-hint">Supports: JPG, PNG, WebP, GIF (Max 50MB)</p>
                    </div>
                </label>
            </div>

            <!-- Upload Queue -->
            @if (uploadQueue.Any())
            {
                <div class="upload-queue">
                    <div class="queue-header">
                        <h4>Upload Queue (@uploadQueue.Count files)</h4>
                        <button class="clear-queue" @onclick="ClearQueue" type="button">Clear All</button>
                    </div>

                    @foreach (var item in uploadQueue)
                    {
                        <div class="queue-item @item.Status">
                            <div class="queue-preview">
                                <img src="@item.PreviewUrl" alt="@item.FileName" />
                            </div>
                            <div class="queue-info">
                                <span class="queue-name">@item.FileName</span>
                                <span class="queue-size">@item.FormattedSize</span>
                                @if (!string.IsNullOrEmpty(item.ErrorMessage))
                                {
                                    <span class="queue-error">@item.ErrorMessage</span>
                                }
                            </div>
                            <div class="queue-progress">
                                @if (item.Status == "uploading")
                                {
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @item.Progress%"></div>
                                    </div>
                                    <span class="progress-text">@item.Progress%</span>
                                }
                                else if (item.Status == "success")
                                {
                                    <span class="status-icon success">‚úì</span>
                                }
                                else if (item.Status == "error")
                                {
                                    <span class="status-icon error">‚úó</span>
                                }
                                else
                                {
                                    <span class="status-icon pending">‚è≥</span>
                                }
                            </div>
                            <button class="queue-remove" type="button" @onclick="@(() => RemoveFromQueue(item))">‚úï</button>
                        </div>
                    }
                </div>

                <!-- Action Buttons -->
                <div class="upload-actions">
                    <SecondaryButton OnClick="CloseUploadModal"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    IsDisabled="@isUploading"
                                    Size="SecondaryButton.ButtonSize.Medium">
                        Cancel
                    </SecondaryButton>
                    <PrimaryButton OnClick="StartUpload"
                                   IsDisabled="@isUploading"
                                   IsLoading="@isUploading"
                                   Size="PrimaryButton.ButtonSize.Medium">
                        Upload @uploadQueue.Count Image@(uploadQueue.Count != 1 ? "s" : "")
                    </PrimaryButton>
                </div>
            }
        </div>
    </BodyContent>
</DynamicModal>
<!-- Confirmation Popup -->
<ConfirmationPopup @ref="confirmationPopup"
                   IsOpen="@isConfirmationOpen"
                   Title="@(imageToDelete != null ? "Delete Image?" : $"Delete {imagesToDelete.Count} Images?")"
                   Message="@(imageToDelete != null ? $"Are you sure you want to delete \"{imageToDelete.FileName}\"?" : $"Are you sure you want to delete {imagesToDelete.Count} selected images?")"
                   WarningText="This action cannot be undone."
                   Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                   ConfirmButtonText="@(isDeleting ? "Deleting..." : "Delete")"
                   CancelButtonText="Cancel"
                   IsProcessing="@isDeleting"
                   OnConfirm="ConfirmDelete"
                   OnCancel="CancelDelete" />
