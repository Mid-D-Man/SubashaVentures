@page "/admin/users"
@using SubashaVentures.Layout.Admin
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Notifications
@using SubashaVentures.Components.Admin.Users
@using SubashaVentures.Domain.User
@layout AdminLayout

<div class="user-management">
    <!-- Notification Component -->
    <NotificationComponent @ref="notificationComponent" 
                          Position="NotificationPosition.TopRight"
                          AutoDismissTime="5000" />

    <!-- Header -->
    <div class="um-header">
        <div class="um-header-left">
            <h1 class="um-title">User Management</h1>
            <p class="um-subtitle">Manage customer accounts and permissions</p>
        </div>
        <div class="um-header-right">
            <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                           Size="SecondaryButton.ButtonSize.Medium"
                           Icon="‚¨á"
                           OnClick="HandleExport">
                Export Users
            </SecondaryButton>
            <PrimaryButton Variant="PrimaryButton.ButtonVariant.Primary"
                          Size="PrimaryButton.ButtonSize.Medium"
                          Icon="‚ûï"
                          OnClick="OpenCreateUserModal">
                Add User
            </PrimaryButton>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="um-stats">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <span class="stat-label">Total Users</span>
                <span class="stat-value">@userStats.TotalUsers</span>
            </div>
        </div>

        <div class="stat-card active">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <span class="stat-label">Active Users</span>
                <span class="stat-value">@userStats.ActiveUsers</span>
            </div>
        </div>

        <div class="stat-card verified">
            <div class="stat-icon">üîí</div>
            <div class="stat-info">
                <span class="stat-label">Verified</span>
                <span class="stat-value">@userStats.VerifiedUsers</span>
            </div>
        </div>

        <div class="stat-card new">
            <div class="stat-icon">üÜï</div>
            <div class="stat-info">
                <span class="stat-label">New Today</span>
                <span class="stat-value">@userStats.NewUsersToday</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="um-toolbar">
        <div class="um-filters">
            <InputField Value="@searchQuery"
                       ValueChanged="@((value) => { searchQuery = value; HandleSearch(); })"
                       Placeholder="Search users..."
                       PrefixIcon="üîç"
                       ShowClearButton="true"
                       CssClass="search-input" />

            <select class="filter-select" @onchange="HandleStatusFilter">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Suspended">Suspended</option>
                <option value="Deleted">Deleted</option>
            </select>

            <select class="filter-select" @onchange="HandleTierFilter">
                <option value="">All Tiers</option>
                <option value="Bronze">Bronze</option>
                <option value="Silver">Silver</option>
                <option value="Gold">Gold</option>
                <option value="Platinum">Platinum</option>
            </select>

            <select class="filter-select" @onchange="HandleVerificationFilter">
                <option value="">All Verification</option>
                <option value="verified">Email Verified</option>
                <option value="unverified">Not Verified</option>
                <option value="phone-verified">Phone Verified</option>
            </select>

            <select class="filter-select" @onchange="HandleSortChange">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name-az">Name (A-Z)</option>
                <option value="name-za">Name (Z-A)</option>
                <option value="spent-high">Highest Spent</option>
                <option value="spent-low">Lowest Spent</option>
                <option value="orders-high">Most Orders</option>
            </select>
        </div>

        <div class="um-view-controls">
            @if (selectedUsers.Any())
            {
                <span class="selection-count">@selectedUsers.Count selected</span>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkActivate">
                    Activate
                </SecondaryButton>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkSuspend"
                                CssClass="btn-warning">
                    Suspend
                </SecondaryButton>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="ClearSelection">
                    Clear
                </SecondaryButton>
            }

            <button class="view-toggle @(viewMode == "grid" ? "active" : "")" 
                    @onclick="@(() => viewMode = "grid")"
                    title="Grid View">
                ‚ñ¶
            </button>
            <button class="view-toggle @(viewMode == "list" ? "active" : "")" 
                    @onclick="@(() => viewMode = "list")"
                    title="List View">
                ‚ò∞
            </button>
        </div>
    </div>

    <!-- Content Area -->
    @if (isLoading)
    {
        <div class="um-loading">
            <div class="loading-spinner"></div>
            <p>Loading users...</p>
        </div>
    }
    else if (!filteredUsers.Any())
    {
        <div class="um-empty">
            <div class="empty-icon">üë§</div>
            <h3>No users found</h3>
            <p>@(string.IsNullOrEmpty(searchQuery) ? "No users in the system yet" : "Try adjusting your search or filters")</p>
        </div>
    }
    else
    {
        @if (viewMode == "grid")
        {
            <!-- Grid View -->
            <div class="um-grid">
                @foreach (var user in paginatedUsers)
                {
                    <AdminUserCard User="@user"
                                  AllowSelection="true"
                                  IsSelected="@selectedUsers.Contains(user.Id)"
                                  OnViewDetails="@((u) => OpenUserDetailsModal(u))"
                                  OnSendMessage="@((u) => HandleSendMessage(u))"
                                  OnViewOrders="@((u) => HandleViewOrders(u))"
                                  OnToggleSuspend="@((args) => HandleToggleSuspend(args.user, args.isSuspended))"
                                  OnDelete="@((u) => HandleDeleteUser(u))"
                                  OnSelectionChanged="@((args) => HandleSelectionChanged(args.userId, args.isSelected))"
                                  OnCardClick="@((u) => OpenUserDetailsModal(u))" />
                }
            </div>
        }
        else
        {
            <!-- List View -->
            <div class="um-table-container">
                <table class="um-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" 
                                       @onchange="HandleSelectAll"
                                       checked="@(selectedUsers.Count == paginatedUsers.Count && paginatedUsers.Any())" />
                            </th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Tier</th>
                            <th>Orders</th>
                            <th>Spent</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in paginatedUsers)
                        {
                            <tr class="@(selectedUsers.Contains(user.Id) ? "selected" : "")">
                                <td>
                                    <input type="checkbox"
                                           checked="@selectedUsers.Contains(user.Id)"
                                           @onchange="@((e) => HandleSelectionChanged(user.Id, (bool)e.Value))" />
                                </td>
                                <td>
                                    <div class="table-user-info">
                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                        {
                                            <img src="@user.AvatarUrl" alt="@user.DisplayName" />
                                        }
                                        else
                                        {
                                            <div class="user-avatar-placeholder">@user.Initials</div>
                                        }
                                        <div>
                                            <span class="user-name">@user.DisplayName</span>
                                            @if (user.IsEmailVerified)
                                            {
                                                <span class="verified-badge" title="Verified">‚úì</span>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    <span class="status-badge @GetStatusClass(user.AccountStatus)">
                                        @user.AccountStatus
                                    </span>
                                </td>
                                <td>
                                    <span class="tier-badge" style="--tier-color: @GetTierColor(user.MembershipTier)">
                                        @user.MembershipTier
                                    </span>
                                </td>
                                <td>@user.TotalOrders</td>
                                <td>@user.DisplayTotalSpent</td>
                                <td>@user.MemberSince</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" @onclick="@(() => OpenUserDetailsModal(user))" title="View Details">
                                            üëÅÔ∏è
                                        </button>
                                        <button class="action-btn" @onclick="@(() => HandleSendMessage(user))" title="Send Message">
                                            ‚úâÔ∏è
                                        </button>
                                        <button class="action-btn danger" @onclick="@(() => HandleDeleteUser(user))" title="Delete">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <!-- Pagination -->
        <div class="um-pagination">
            <div class="pagination-info">
                Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredUsers.Count) of @filteredUsers.Count users
            </div>
            <div class="pagination-controls">
                <button class="page-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(currentPage == 1)">
                    ‚Üê Previous
                </button>
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNumber = i;
                    <button class="page-btn @(pageNumber == currentPage ? "active" : "")" 
                            @onclick="@(() => GoToPage(pageNumber))">
                        @pageNumber
                    </button>
                }
                
                <button class="page-btn" 
                        @onclick="NextPage" 
                        disabled="@(currentPage == totalPages)">
                    Next ‚Üí
                </button>
            </div>
        </div>
    }
</div>

<!-- Create/Edit User Modal -->
<DynamicModal @ref="userModal"
              Title="@(isEditMode ? "Edit User" : "Create User")"
              Size="DynamicModal.ModalSize.Large"
              IsOpen="@isUserModalOpen"
              ShowFooter="false"
              IsScrollable="true"
              OnClose="CloseUserModal">
    <BodyContent>
        <div class="user-form">
            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>
                
                <div class="form-row">
                    <InputField @bind-Value="userForm.FirstName"
                               Label="First Name"
                               Placeholder="John"
                               IsRequired="true"
                               HasError="@(!string.IsNullOrEmpty(validationErrors.GetValueOrDefault("FirstName")))"
                               ErrorMessage="@validationErrors.GetValueOrDefault("FirstName")" />

                    <InputField @bind-Value="userForm.LastName"
                               Label="Last Name"
                               Placeholder="Doe"
                               IsRequired="true"
                               HasError="@(!string.IsNullOrEmpty(validationErrors.GetValueOrDefault("LastName")))"
                               ErrorMessage="@validationErrors.GetValueOrDefault("LastName")" />
                </div>

                <InputField @bind-Value="userForm.Email"
                           Label="Email Address"
                           Type="email"
                           Placeholder="user@example.com"
                           IsRequired="true"
                           IsReadOnly="@isEditMode"
                           HasError="@(!string.IsNullOrEmpty(validationErrors.GetValueOrDefault("Email")))"
                           ErrorMessage="@validationErrors.GetValueOrDefault("Email")"
                           HelperText="@(isEditMode ? "Email cannot be changed after creation" : "")" />

                @if (!isEditMode)
                {
                    <InputField @bind-Value="userForm.Password"
                               Label="Password"
                               Type="password"
                               Placeholder="Enter secure password"
                               IsRequired="true"
                               HasError="@(!string.IsNullOrEmpty(validationErrors.GetValueOrDefault("Password")))"
                               ErrorMessage="@validationErrors.GetValueOrDefault("Password"))"
                               HelperText="Minimum 8 characters, include uppercase, lowercase, and number" />
                }

                <InputField @bind-Value="userForm.PhoneNumber"
                           Label="Phone Number"
                           Type="tel"
                           Placeholder="+234 XXX XXX XXXX" />
            </div>

            <!-- Additional Details -->
            <div class="form-section">
                <h3 class="section-title">Additional Details</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-select" @bind="userForm.Gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" 
                               class="form-input"
                               @bind="userForm.DateOfBirth"
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <SecondaryButton OnClick="CloseUserModal"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                Size="SecondaryButton.ButtonSize.Large">
                    Cancel
                </SecondaryButton>
                <PrimaryButton OnClick="HandleSaveUser"
                              Size="PrimaryButton.ButtonSize.Large"
                              IsLoading="@isSaving"
                              IsDisabled="@isSaving">
                    @(isEditMode ? "Update User" : "Create User")
                </PrimaryButton>
            </div>
        </div>
    </BodyContent>
</DynamicModal>

<!-- User Details Modal -->
<DynamicModal @ref="detailsModal"
              Title="User Details"
              Size="DynamicModal.ModalSize.Large"
              IsOpen="@isDetailsModalOpen"
              ShowFooter="false"
              IsScrollable="true"
              OnClose="CloseDetailsModal">
    <BodyContent>
        @if (selectedUser != null)
        {
            <div class="user-details">
                <!-- Profile Section -->
                <div class="details-section">
                    <div class="profile-header">
                        @if (!string.IsNullOrEmpty(selectedUser.AvatarUrl))
                        {
                            <img src="@selectedUser.AvatarUrl" alt="@selectedUser.DisplayName" class="profile-avatar" />
                        }
                        else
                        {
                            <div class="profile-avatar-placeholder">@selectedUser.Initials</div>
                        }
                        <div class="profile-info">
                            <h2>@selectedUser.DisplayName</h2>
                            <p class="profile-email">@selectedUser.Email</p>
                            <div class="profile-badges">
                                @if (selectedUser.IsEmailVerified)
                                {
                                    <span class="badge verified">‚úì Email Verified</span>
                                }
                                @if (selectedUser.IsPhoneVerified)
                                {
                                    <span class="badge verified">üì± Phone Verified</span>
                                }
                                <span class="badge tier" style="--tier-color: @GetTierColor(selectedUser.MembershipTier)">
                                    @selectedUser.MembershipTier Member
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="details-stats">
                    <div class="stat-box">
                        <span class="stat-icon">üõçÔ∏è</span>
                        <div>
                            <span class="stat-number">@selectedUser.TotalOrders</span>
                            <span class="stat-text">Total Orders</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">üí∞</span>
                        <div>
                            <span class="stat-number">@selectedUser.DisplayTotalSpent</span>
                            <span class="stat-text">Total Spent</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">‚≠ê</span>
                        <div>
                            <span class="stat-number">@selectedUser.LoyaltyPoints</span>
                            <span class="stat-text">Loyalty Points</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">üìù</span>
                        <div>
                            <span class="stat-number">@selectedUser.ReviewsCount</span>
                            <span class="stat-text">Reviews</span>
                        </div>
                    </div>
                </div>

                <!-- Information Grid -->
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Phone Number:</span>
                        <span class="detail-value">@(selectedUser.PhoneNumber ?? "Not provided")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Account Status:</span>
                        <span class="status-badge @GetStatusClass(selectedUser.AccountStatus)">
                            @selectedUser.AccountStatus
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member Since:</span>
                        <span class="detail-value">@selectedUser.MemberSince</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Login:</span>
                        <span class="detail-value">
                            @(selectedUser.LastLoginAt?.ToString("MMM dd, yyyy HH:mm") ?? "Never")
                        </span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="details-actions">
                    <PrimaryButton OnClick="@(() => OpenEditUserModal(selectedUser))"
                                  Icon="‚úèÔ∏è">
                        Edit Profile
                    </PrimaryButton>
                    <SecondaryButton OnClick="@(() => HandleSendMessage(selectedUser))"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    Icon="‚úâÔ∏è">
                        Send Message
                    </SecondaryButton>
                    <SecondaryButton OnClick="@(() => HandleViewOrders(selectedUser))"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    Icon="üì¶">
                        View Orders
                    </SecondaryButton>
                </div>
            </div>
        }
    </BodyContent>
</DynamicModal>

<!-- Delete Confirmation -->
<ConfirmationPopup @ref="deleteConfirmationPopup"
                  IsOpen="@showDeleteConfirmation"
                  Title="@(usersToDelete != null ? "Delete Multiple Users?" : "Delete User?")"
                  Message="@GetDeleteMessage()"
                  WarningText="This action will soft-delete the user(s). They can be recovered later."
                  Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                  ConfirmButtonText="Delete"
                  CancelButtonText="Cancel"
                  IsProcessing="@isSaving"
                  OnConfirm="@(usersToDelete != null ? ConfirmBulkDelete : ConfirmDeleteUser)"
                  OnCancel="@(() => { showDeleteConfirmation = false; userToDelete = null; usersToDelete = null; })"
                  OnClose="@(() => { showDeleteConfirmation = false; userToDelete = null; usersToDelete = null; })" />

@code {
    // Code is in .razor.cs file
}
