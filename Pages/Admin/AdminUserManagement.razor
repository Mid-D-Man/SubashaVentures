@* Pages/Admin/AdminUserManagement.razor - FIXED CALLBACKS *@
@page "/admin/users"
@using SubashaVentures.Layout.Admin
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Notifications
@using SubashaVentures.Components.Admin.Users
@using SubashaVentures.Domain.User
@layout AdminLayout

<div class="user-management">
    <!-- Notification Component -->
    <NotificationComponent @ref="notificationComponent" 
                          Position="NotificationPosition.TopRight"
                          AutoDismissTime="5000" />

    <!-- Header, Stats, Toolbar remain the same... -->
    <div class="um-header">
        <div class="um-header-left">
            <h1 class="um-title">User Management</h1>
            <p class="um-subtitle">Manage customer accounts and permissions</p>
        </div>
        <div class="um-header-right">
            <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                           Size="SecondaryButton.ButtonSize.Medium"
                           Icon="‚¨á"
                           OnClick="HandleExport">
                Export
            </SecondaryButton>
            <PrimaryButton Variant="PrimaryButton.ButtonVariant.Primary"
                          Size="PrimaryButton.ButtonSize.Medium"
                          Icon="‚ûï"
                          OnClick="OpenCreateUserModal">
                Add User
            </PrimaryButton>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="um-stats">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <span class="stat-label">Total Users</span>
                <span class="stat-value">@stats.TotalUsers</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <span class="stat-label">Active Users</span>
                <span class="stat-value">@stats.ActiveUsers</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚è∏Ô∏è</div>
            <div class="stat-info">
                <span class="stat-label">Suspended</span>
                <span class="stat-value">@stats.SuspendedUsers</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìß</div>
            <div class="stat-info">
                <span class="stat-label">Verified</span>
                <span class="stat-value">@stats.VerifiedUsers</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="um-toolbar">
        <div class="um-filters">
            <InputField Value="@searchQuery"
                        ValueChanged="@((value) => { searchQuery = value; HandleSearch(); })"
                        Placeholder="Search users..."
                        PrefixIcon="üîç"
                        ShowClearButton="true"
                        CssClass="search-input" />

            <select class="filter-select" @onchange="HandleStatusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                <option value="deleted">Deleted</option>
            </select>

            <select class="filter-select" @onchange="HandleVerificationFilter">
                <option value="">All Verification</option>
                <option value="verified">Verified</option>
                <option value="unverified">Unverified</option>
            </select>

            <select class="filter-select" @onchange="HandleTierFilter">
                <option value="">All Tiers</option>
                <option value="Bronze">Bronze</option>
                <option value="Silver">Silver</option>
                <option value="Gold">Gold</option>
                <option value="Platinum">Platinum</option>
            </select>

            <select class="filter-select" @onchange="HandleSortChange">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name-az">Name (A-Z)</option>
                <option value="name-za">Name (Z-A)</option>
                <option value="orders-high">Most Orders</option>
                <option value="spent-high">Highest Spending</option>
            </select>
        </div>

        <div class="um-view-controls">
            @if (selectedUsers.Any())
            {
                <span class="selection-count">@selectedUsers.Count selected</span>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkActivate">
                    Activate
                </SecondaryButton>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkSuspend">
                    Suspend
                </SecondaryButton>
            }

            <button class="view-toggle @(viewMode == "grid" ? "active" : "")" 
                    @onclick="@(() => viewMode = "grid")"
                    title="Grid View">
                ‚ñ¶
            </button>
            <button class="view-toggle @(viewMode == "list" ? "active" : "")" 
                    @onclick="@(() => viewMode = "list")"
                    title="List View">
                ‚ò∞
            </button>
        </div>
    </div>

    <!-- Content Area -->
    @if (isLoading)
    {
        <div class="um-loading">
            <div class="loading-spinner"></div>
            <p>Loading users...</p>
        </div>
    }
    else if (!filteredUsers.Any())
    {
        <div class="um-empty">
            <div class="empty-icon">üë•</div>
            <h3>No users found</h3>
            <p>@(string.IsNullOrEmpty(searchQuery) ? "Start by adding your first user" : "Try adjusting your search or filters")</p>
            <PrimaryButton OnClick="OpenCreateUserModal">
                Add User
            </PrimaryButton>
        </div>
    }
    else
    {
        @if (viewMode == "grid")
        {
            <!-- FIXED: Grid View with correct callbacks -->
            <div class="um-grid">
                @foreach (var user in paginatedUsers)
                {
                    <AdminUserCard User="@user"
                                 IsSelected="@selectedUsers.Contains(user.Id)"
                                 OnViewDetails="@HandleViewUserDetails"
                                 OnSendMessage="@HandleSendUserMessage"
                                 OnViewOrders="@HandleViewUserOrders"
                                 OnSuspend="@HandleSuspendUser"
                                 OnActivate="@HandleActivateUser"
                                 OnDelete="@HandleDeleteUser"
                                 OnVerifyEmail="@HandleVerifyEmail"
                                 OnSelectionChanged="@HandleSelectionChanged"
                                 OnCardClick="@HandleViewUserDetails" />
                }
            </div>
        }
        else
        {
            <!-- List View remains the same... -->
            <div class="um-table-container">
                <table class="um-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" 
                                       @onchange="HandleSelectAll"
                                       checked="@(selectedUsers.Count == paginatedUsers.Count && paginatedUsers.Any())" />
                            </th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Tier</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in paginatedUsers)
                        {
                            <tr class="@(selectedUsers.Contains(user.Id) ? "selected" : "")">
                                <td>
                              @* Line ~212 - FIXED *@
<input type="checkbox"
       checked="@selectedUsers.Contains(user.Id)"
       @onchange="@((e) => HandleSelectionChanged((user.Id, (bool)(e.Value ?? false))))" />
                                </td>
                                <td>
                                    <div class="table-user-info">
                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                        {
                                            <img src="@user.AvatarUrl" alt="@user.DisplayName" />
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder">@user.Initials</div>
                                        }
                                        <div>
                                            <span class="user-name">@user.DisplayName</span>
                                            @if (user.IsVerified)
                                            {
                                                <span class="verified-badge" title="Verified">‚úì</span>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    <span class="status-badge @GetStatusClass(user.AccountStatus)">
                                        @user.AccountStatus
                                    </span>
                                </td>
                                <td>
                                    <span class="tier-badge @GetTierClass(user.MembershipTier)">
                                        @user.MembershipTier
                                    </span>
                                </td>
                                <td>@user.TotalOrders</td>
                                <td>@user.DisplayTotalSpent</td>
                                <td>@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" @onclick="@(() => HandleViewUserDetails(user))" title="Edit">
                                            ‚úèÔ∏è
                                        </button>
                                        @if (user.AccountStatus == "Active")
                                        {
                                            <button class="action-btn" @onclick="@(() => HandleSuspendUser(user))" title="Suspend">
                                                ‚è∏Ô∏è
                                            </button>
                                        }
                                        else if (user.AccountStatus == "Suspended")
                                        {
                                            <button class="action-btn" @onclick="@(() => HandleActivateUser(user))" title="Activate">
                                                ‚ñ∂Ô∏è
                                            </button>
                                        }
                                        <button class="action-btn danger" @onclick="@(() => HandleDeleteUser(user))" title="Delete">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <!-- Pagination -->
        <div class="um-pagination">
            <div class="pagination-info">
                Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredUsers.Count) of @filteredUsers.Count users
            </div>
            <div class="pagination-controls">
                <button class="page-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(currentPage == 1)">
                    ‚Üê Previous
                </button>
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNumber = i;
                    <button class="page-btn @(pageNumber == currentPage ? "active" : "")" 
                            @onclick="@(() => GoToPage(pageNumber))">
                        @pageNumber
                    </button>
                }
                
                <button class="page-btn" 
                        @onclick="NextPage" 
                        disabled="@(currentPage == totalPages)">
                    Next ‚Üí
                </button>
            </div>
        </div>
    }
</div>

<!-- Modals remain the same but are included for completeness -->
<DynamicModal @ref="userModal"
              Title="@(isEditMode ? "Edit User" : "Create User")"
              Size="DynamicModal.ModalSize.Large"
              IsOpen="@isUserModalOpen"
              ShowFooter="false"
              IsScrollable="true"
              OnClose="CloseUserModal">
    <BodyContent>
        <div class="user-form">
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>
                
                <div class="form-row">
                    <InputField @bind-Value="userForm.FirstName"
                               Label="First Name"
                               Placeholder="John"
                               IsRequired="true"
                               HasError="@validationErrors.ContainsKey("FirstName")"
                               ErrorMessage="@(validationErrors.ContainsKey("FirstName") ? validationErrors["FirstName"] : "")" />

                    <InputField @bind-Value="userForm.LastName"
                               Label="Last Name"
                               Placeholder="Doe"
                               IsRequired="true"
                               HasError="@validationErrors.ContainsKey("LastName")"
                               ErrorMessage="@(validationErrors.ContainsKey("LastName") ? validationErrors["LastName"] : "")" />
                </div>

                <InputField @bind-Value="userForm.Email"
                           Label="Email Address"
                           Type="email"
                           Placeholder="john.doe@example.com"
                           IsRequired="true"
                           HasError="@validationErrors.ContainsKey("Email")"
                           ErrorMessage="@(validationErrors.ContainsKey("Email") ? validationErrors["Email"] : "")" />

                @if (!isEditMode)
                {
                    <InputField @bind-Value="userForm.Password"
                               Label="Password"
                               Type="password"
                               Placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                               IsRequired="true"
                               HasError="@validationErrors.ContainsKey("Password")"
                               ErrorMessage="@(validationErrors.ContainsKey("Password") ? validationErrors["Password"] : "")"
                               HelperText="Minimum 8 characters" />
                }

                <InputField @bind-Value="userForm.PhoneNumber"
                           Label="Phone Number"
                           Type="tel"
                           Placeholder="+234 XXX XXX XXXX" />
            </div>

            @if (isEditMode)
            {
                <div class="form-section">
                    <h3 class="section-title">Account Settings</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Account Status</label>
                        <select class="form-select" @bind="userForm.AccountStatus">
                            <option value="Active">Active</option>
                            <option value="Suspended">Suspended</option>
                        </select>
                    </div>

                    @if (userForm.AccountStatus == "Suspended")
                    {
                        <div class="form-group">
                            <label class="form-label">Suspension Reason</label>
                            <textarea class="form-textarea"
                                     @bind="userForm.SuspensionReason"
                                     placeholder="Reason for suspension..."
                                     rows="3"></textarea>
                        </div>
                    }

                    <div class="form-group">
                        <label class="form-label">Membership Tier</label>
                        <select class="form-select" @bind="userForm.MembershipTier">
                            <option value="Bronze">Bronze</option>
                            <option value="Silver">Silver</option>
                            <option value="Gold">Gold</option>
                            <option value="Platinum">Platinum</option>
                        </select>
                    </div>

                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" @bind="userForm.IsEmailVerified" />
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Email Verified</span>
                        </label>

                        <label class="toggle-switch">
                            <input type="checkbox" @bind="userForm.IsPhoneVerified" />
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Phone Verified</span>
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Statistics</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Orders</span>
                            <span class="stat-value">@userForm.TotalOrders</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Spent</span>
                            <span class="stat-value">‚Ç¶@userForm.TotalSpent.ToString("N0")</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Loyalty Points</span>
                            <span class="stat-value">@userForm.LoyaltyPoints</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value">@userForm.CreatedAt.ToString("MMM yyyy")</span>
                        </div>
                    </div>
                </div>
            }

            <div class="form-actions">
                <SecondaryButton OnClick="CloseUserModal"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                Size="SecondaryButton.ButtonSize.Large">
                    Cancel
                </SecondaryButton>
                <PrimaryButton OnClick="HandleSaveUser"
                              Size="PrimaryButton.ButtonSize.Large"
                              IsLoading="@isSaving"
                              IsDisabled="@isSaving">
                    @(isEditMode ? "Update User" : "Create User")
                </PrimaryButton>
            </div>
        </div>
    </BodyContent>
</DynamicModal>

<ConfirmationPopup @ref="deleteConfirmationPopup"
                  IsOpen="@showDeleteConfirmation"
                  Title="@GetDeleteTitle()"
                  Message="@GetDeleteMessage()"
                  WarningText="This action cannot be undone."
                  Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                  ConfirmButtonText="Delete"
                  CancelButtonText="Cancel"
                  IsProcessing="@isSaving"
                  OnConfirm="@ConfirmDeleteUser"
                  OnCancel="@(() => { showDeleteConfirmation = false; userToDelete = null; })"
                  OnClose="@(() => { showDeleteConfirmation = false; userToDelete = null; })" />

<ConfirmationPopup @ref="suspendConfirmationPopup"
                  IsOpen="@showSuspendConfirmation"
                  Title="Suspend User?"
                  Message="@GetSuspendMessage()"
                  WarningText="The user will not be able to access their account."
                  Variant="ConfirmationPopup.ConfirmationVariant.Warning"
                  ConfirmButtonText="Suspend"
                  CancelButtonText="Cancel"
                  IsProcessing="@isSaving"
                  OnConfirm="@ConfirmSuspendUser"
                  OnCancel="@(() => { showSuspendConfirmation = false; userToSuspend = null; })"
                  OnClose="@(() => { showSuspendConfirmation = false; userToSuspend = null; })" />

@code {
    private string GetDeleteTitle()
    {
        return userToDelete != null ? "Delete User?" : "No User Selected";
    }

    private string GetDeleteMessage()
    {
        if (userToDelete != null)
        {
            return $"Are you sure you want to delete '{userToDelete.DisplayName}'? This will permanently remove their account and all associated data.";
        }
        return "No user selected for deletion.";
    }

    private string GetSuspendMessage()
    {
        if (userToSuspend != null)
        {
            return $"Are you sure you want to suspend '{userToSuspend.DisplayName}'? They will not be able to access their account until reactivated.";
        }
        return "No user selected for suspension.";
    }
}
