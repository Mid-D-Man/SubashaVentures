@page "/admin/orders"
@using SubashaVentures.Layout.Admin
@using SubashaVentures.Components.Shared.Buttons
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.Notifications
@using SubashaVentures.Components.Admin.Orders
@using SubashaVentures.Domain.Order
@layout AdminLayout

<div class="order-management">
    <!-- Notification Component -->
    <NotificationComponent @ref="notificationComponent" 
                          Position="NotificationPosition.TopRight"
                          AutoDismissTime="5000" />

    <!-- Header -->
    <div class="om-header">
        <div class="om-header-left">
            <h1 class="om-title">Order Management</h1>
            <p class="om-subtitle">Manage and track all customer orders</p>
        </div>
        <div class="om-header-right">
            <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                           Size="SecondaryButton.ButtonSize.Medium"
                           Icon="üîÑ"
                           OnClick="RefreshOrders"
                           IsLoading="@isRefreshing">
                Refresh
            </SecondaryButton>
            <SecondaryButton Variant="SecondaryButton.ButtonVariant.Outline"
                           Size="SecondaryButton.ButtonSize.Medium"
                           Icon="‚¨á"
                           OnClick="HandleExport">
                Export
            </SecondaryButton>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="om-stats">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-info">
                <span class="stat-label">Total Orders</span>
                <span class="stat-value">@totalOrders</span>
            </div>
        </div>

        <div class="stat-card pending">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-info">
                <span class="stat-label">Pending</span>
                <span class="stat-value">@pendingOrders</span>
            </div>
        </div>

        <div class="stat-card processing">
            <div class="stat-icon">‚öôÔ∏è</div>
            <div class="stat-info">
                <span class="stat-label">Processing</span>
                <span class="stat-value">@processingOrders</span>
            </div>
        </div>

        <div class="stat-card shipped">
            <div class="stat-icon">üöö</div>
            <div class="stat-info">
                <span class="stat-label">Shipped</span>
                <span class="stat-value">@shippedOrders</span>
            </div>
        </div>

        <div class="stat-card delivered">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <span class="stat-label">Delivered</span>
                <span class="stat-value">@deliveredOrders</span>
            </div>
        </div>

        <div class="stat-card revenue">
            <div class="stat-icon">üí∞</div>
            <div class="stat-info">
                <span class="stat-label">Total Revenue</span>
                <span class="stat-value">‚Ç¶@totalRevenue.ToString("N0")</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="om-toolbar">
        <div class="om-filters">
            <InputField Value="@searchQuery"
                        ValueChanged="@((value) => { searchQuery = value; HandleSearch(); })"
                        Placeholder="Search orders..."
                        PrefixIcon="üîç"
                        ShowClearButton="true"
                        CssClass="search-input" />

            <select class="filter-select" @onchange="HandleStatusFilter">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Processing">Processing</option>
                <option value="Shipped">Shipped</option>
                <option value="Delivered">Delivered</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Failed">Failed</option>
                <option value="Refunded">Refunded</option>
            </select>

            <select class="filter-select" @onchange="HandlePaymentFilter">
                <option value="">All Payments</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Failed">Failed</option>
                <option value="Refunded">Refunded</option>
            </select>

            <select class="filter-select" @onchange="HandleSortChange">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="amount-high">Amount (High)</option>
                <option value="amount-low">Amount (Low)</option>
                <option value="pending-delivery">Pending Delivery</option>
            </select>
        </div>

        <div class="om-view-controls">
            @if (selectedOrders.Any())
            {
                <span class="selection-count">@selectedOrders.Count selected</span>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkMarkShipped">
                    Mark Shipped
                </SecondaryButton>
                <SecondaryButton Size="SecondaryButton.ButtonSize.Small"
                                Variant="SecondaryButton.ButtonVariant.Outline"
                                OnClick="HandleBulkMarkDelivered">
                    Mark Delivered
                </SecondaryButton>
            }

            <button class="view-toggle @(viewMode == "grid" ? "active" : "")" 
                    @onclick="@(() => viewMode = "grid")"
                    title="Grid View">
                ‚ñ¶
            </button>
            <button class="view-toggle @(viewMode == "list" ? "active" : "")" 
                    @onclick="@(() => viewMode = "list")"
                    title="List View">
                ‚ò∞
            </button>
        </div>
    </div>

    <!-- Content Area -->
    @if (isLoading)
    {
        <div class="om-loading">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large"
                           Variant="LoadingSpinner.SpinnerVariant.Circle"
                           Message="Loading orders..." />
        </div>
    }
    else if (!filteredOrders.Any())
    {
        <div class="om-empty">
            <div class="empty-icon">üì¶</div>
            <h3>No orders found</h3>
            <p>@(string.IsNullOrEmpty(searchQuery) ? "No orders have been placed yet" : "Try adjusting your search or filters")</p>
        </div>
    }
    else
    {
        @if (viewMode == "grid")
        {
            <div class="om-grid">
                @foreach (var order in paginatedOrders)
                {
                    <AdminOrderCard Order="@order"
                                   ServerTime="@currentServerTime"
                                   IsSelected="@selectedOrders.Contains(order.Id)"
                                   OnOrderClick="@((o) => OpenOrderDetailsModal(o))"
                                   OnSelectionChanged="@((args) => HandleSelectionChanged(args.orderId, args.isSelected))" />
                }
            </div>
        }
        else
        {
            <div class="om-table-container">
                <table class="om-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" 
                                       @onchange="HandleSelectAll"
                                       checked="@(selectedOrders.Count == paginatedOrders.Count && paginatedOrders.Any())" />
                            </th>
                            <th>Order Number</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Delivery</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in paginatedOrders)
                        {
                            <tr class="@(selectedOrders.Contains(order.Id) ? "selected" : "")"
                                @onclick="@(() => OpenOrderDetailsModal(order))">
                                <td @onclick:stopPropagation="true">
                                    <input type="checkbox"
                                           checked="@selectedOrders.Contains(order.Id)"
                                           @onchange="@((e) => HandleSelectionChanged(order.Id, (bool)e.Value))" />
                                </td>
                                <td>
                                    <div class="order-number">
                                        <span class="number">@order.OrderNumber</span>
                                        @if (IsOrderUrgent(order))
                                        {
                                            <span class="urgent-badge">üî• Urgent</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-info">
                                        <span class="name">@order.CustomerName</span>
                                        <span class="email">@order.CustomerEmail</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="item-count">@order.TotalItems items</span>
                                </td>
                                <td>
                                    <span class="order-total">@order.DisplayTotal</span>
                                </td>
                                <td>
                                    <span class="payment-badge @order.PaymentStatus.ToString().ToLower()">
                                        @order.PaymentStatus
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge @order.Status.ToString().ToLower()">
                                        @order.Status
                                    </span>
                                </td>
                                <td>
                                    <span class="order-date">@order.CreatedAt.ToString("MMM dd, yyyy")</span>
                                </td>
                                <td>
                                    @if (order.Status == OrderStatus.Shipped || order.Status == OrderStatus.Processing)
                                    {
                                        var timeLeft = GetEstimatedDeliveryTime(order);
                                        <span class="delivery-time @(timeLeft.TotalHours < 24 ? "urgent" : "")">
                                            @FormatTimeLeft(timeLeft)
                                        </span>
                                    }
                                    else if (order.Status == OrderStatus.Delivered)
                                    {
                                        <span class="delivered-date">
                                            @order.DeliveredAt?.ToString("MMM dd")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="delivery-pending">-</span>
                                    }
                                </td>
                                <td @onclick:stopPropagation="true">
                                    <div class="table-actions">
                                        <button class="action-btn" @onclick="@(() => OpenOrderDetailsModal(order))" title="View Details">
                                            üëÅÔ∏è
                                        </button>
                                        @if (order.Status != OrderStatus.Delivered && order.Status != OrderStatus.Cancelled)
                                        {
                                            <button class="action-btn" @onclick="@(() => OpenUpdateStatusModal(order))" title="Update Status">
                                                ‚ö°
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <!-- Pagination -->
        <div class="om-pagination">
            <div class="pagination-info">
                Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredOrders.Count) of @filteredOrders.Count orders
            </div>
            <div class="pagination-controls">
                <button class="page-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(currentPage == 1)">
                    ‚Üê Previous
                </button>
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNumber = i;
                    <button class="page-btn @(pageNumber == currentPage ? "active" : "")" 
                            @onclick="@(() => GoToPage(pageNumber))">
                        @pageNumber
                    </button>
                }
                
                <button class="page-btn" 
                        @onclick="NextPage" 
                        disabled="@(currentPage == totalPages)">
                    Next ‚Üí
                </button>
            </div>
        </div>
    }
</div>

<!-- ===== ORDER DETAILS MODAL ===== -->
<DynamicModal @ref="orderDetailsModal"
              Title="@($"Order Details - {selectedOrderForDetails?.OrderNumber}")"
              Size="DynamicModal.ModalSize.Large"
              IsOpen="@isOrderDetailsModalOpen"
              ShowFooter="false"
              IsScrollable="true"
              OnClose="CloseOrderDetailsModal">
    <BodyContent>
        @if (selectedOrderForDetails != null)
        {
            <div class="order-details-modal">
                <!-- Order Header -->
                <div class="details-header">
                    <div class="header-left">
                        <h2 class="order-number-large">@selectedOrderForDetails.OrderNumber</h2>
                        <span class="order-date-created">Placed on @selectedOrderForDetails.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")</span>
                    </div>
                    <div class="header-right">
                        <span class="status-badge-large @selectedOrderForDetails.Status.ToString().ToLower()">
                            @selectedOrderForDetails.Status
                        </span>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="details-section">
                    <h3 class="section-title">üë§ Customer Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">@selectedOrderForDetails.CustomerName</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">@selectedOrderForDetails.CustomerEmail</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">@selectedOrderForDetails.CustomerPhone</span>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="details-section">
                    <h3 class="section-title">üì¶ Order Items (@selectedOrderForDetails.TotalItems)</h3>
                    <div class="items-list">
                        @foreach (var item in selectedOrderForDetails.Items)
                        {
                            <div class="order-item">
                                <div class="item-image">
                                    <img src="@item.ImageUrl" alt="@item.ProductName" />
                                </div>
                                <div class="item-details">
                                    <h4 class="item-name">@item.ProductName</h4>
                                    <p class="item-sku">SKU: @item.Sku</p>
                                    @if (!string.IsNullOrEmpty(item.Size) || !string.IsNullOrEmpty(item.Color))
                                    {
                                        <p class="item-variant">
                                            @if (!string.IsNullOrEmpty(item.Size))
                                            {
                                                <span>Size: @item.Size</span>
                                            }
                                            @if (!string.IsNullOrEmpty(item.Color))
                                            {
                                                <span>Color: @item.Color</span>
                                            }
                                        </p>
                                    }
                                </div>
                                <div class="item-quantity">
                                    <span>√ó@item.Quantity</span>
                                </div>
                                <div class="item-price">
                                    <span class="unit-price">‚Ç¶@item.Price.ToString("N0")</span>
                                    <span class="subtotal">‚Ç¶@item.Subtotal.ToString("N0")</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="details-section">
                    <h3 class="section-title">üí∞ Order Summary</h3>
                    <div class="order-summary">
                        <div class="summary-row">
                            <span class="summary-label">Subtotal:</span>
                            <span class="summary-value">‚Ç¶@selectedOrderForDetails.Subtotal.ToString("N0")</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Shipping:</span>
                            <span class="summary-value">‚Ç¶@selectedOrderForDetails.ShippingCost.ToString("N0")</span>
                        </div>
                        @if (selectedOrderForDetails.Discount > 0)
                        {
                            <div class="summary-row discount">
                                <span class="summary-label">Discount:</span>
                                <span class="summary-value">-‚Ç¶@selectedOrderForDetails.Discount.ToString("N0")</span>
                            </div>
                        }
                        @if (selectedOrderForDetails.Tax > 0)
                        {
                            <div class="summary-row">
                                <span class="summary-label">Tax:</span>
                                <span class="summary-value">‚Ç¶@selectedOrderForDetails.Tax.ToString("N0")</span>
                            </div>
                        }
                        <div class="summary-row total">
                            <span class="summary-label">Total:</span>
                            <span class="summary-value">‚Ç¶@selectedOrderForDetails.Total.ToString("N0")</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="details-section">
                    <h3 class="section-title">üí≥ Payment Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Method:</span>
                            <span class="info-value">@selectedOrderForDetails.PaymentMethod</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="payment-badge @selectedOrderForDetails.PaymentStatus.ToString().ToLower()">
                                @selectedOrderForDetails.PaymentStatus
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedOrderForDetails.PaymentReference))
                        {
                            <div class="info-item">
                                <span class="info-label">Reference:</span>
                                <span class="info-value reference">@selectedOrderForDetails.PaymentReference</span>
                            </div>
                        }
                        @if (selectedOrderForDetails.PaidAt.HasValue)
                        {
                            <div class="info-item">
                                <span class="info-label">Paid At:</span>
                                <span class="info-value">@selectedOrderForDetails.PaidAt.Value.ToString("MMM dd, yyyy h:mm tt")</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="details-section">
                    <h3 class="section-title">üöö Shipping Information</h3>
                    <div class="info-grid">
                        <div class="info-item full-width">
                            <span class="info-label">Address:</span>
                            <span class="info-value">@selectedOrderForDetails.ShippingAddress</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Method:</span>
                            <span class="info-value">@selectedOrderForDetails.ShippingMethod</span>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedOrderForDetails.TrackingNumber))
                        {
                            <div class="info-item">
                                <span class="info-label">Tracking:</span>
                                <span class="info-value tracking">@selectedOrderForDetails.TrackingNumber</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(selectedOrderForDetails.CourierName))
                        {
                            <div class="info-item">
                                <span class="info-label">Courier:</span>
                                <span class="info-value">@selectedOrderForDetails.CourierName</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Delivery Timeline -->
                @if (selectedOrderForDetails.Status == OrderStatus.Shipped || selectedOrderForDetails.Status == OrderStatus.Processing)
                {
                    var timeLeft = GetEstimatedDeliveryTime(selectedOrderForDetails);
                    var isOverdue = timeLeft.TotalHours < 0;
                    
                    <div class="details-section">
                        <h3 class="section-title">‚è±Ô∏è Delivery Timeline</h3>
                        <div class="delivery-timeline @(isOverdue ? "overdue" : "")">
                            <div class="timeline-info">
                                <span class="timeline-label">Estimated Delivery:</span>
                                <span class="timeline-value">
                                    @if (isOverdue)
                                    {
                                        <span class="overdue-text">‚ö†Ô∏è OVERDUE by @FormatTimeLeft(TimeSpan.FromHours(Math.Abs(timeLeft.TotalHours)))</span>
                                    }
                                    else
                                    {
                                        @FormatTimeLeft(timeLeft)
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                }

                <!-- Order Timeline -->
                <div class="details-section">
                    <h3 class="section-title">üìÖ Order Timeline</h3>
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-marker">‚úì</div>
                            <div class="timeline-content">
                                <span class="timeline-title">Order Placed</span>
                                <span class="timeline-date">@selectedOrderForDetails.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                            </div>
                        </div>
                        
                        @if (selectedOrderForDetails.Status != OrderStatus.Pending)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker">‚úì</div>
                                <div class="timeline-content">
                                    <span class="timeline-title">Processing</span>
                                    <span class="timeline-date">@(selectedOrderForDetails.UpdatedAt?.ToString("MMM dd, yyyy h:mm tt") ?? "In progress")</span>
                                </div>
                            </div>
                        }
                        
                        @if (selectedOrderForDetails.ShippedAt.HasValue)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker">‚úì</div>
                                <div class="timeline-content">
                                    <span class="timeline-title">Shipped</span>
                                    <span class="timeline-date">@selectedOrderForDetails.ShippedAt.Value.ToString("MMM dd, yyyy h:mm tt")</span>
                                </div>
                            </div>
                        }
                        
                        @if (selectedOrderForDetails.DeliveredAt.HasValue)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker">‚úì</div>
                                <div class="timeline-content">
                                    <span class="timeline-title">Delivered</span>
                                    <span class="timeline-date">@selectedOrderForDetails.DeliveredAt.Value.ToString("MMM dd, yyyy h:mm tt")</span>
                                </div>
                            </div>
                        }
                        
                        @if (selectedOrderForDetails.CancelledAt.HasValue)
                        {
                            <div class="timeline-item cancelled">
                                <div class="timeline-marker">‚úï</div>
                                <div class="timeline-content">
                                    <span class="timeline-title">Cancelled</span>
                                    <span class="timeline-date">@selectedOrderForDetails.CancelledAt.Value.ToString("MMM dd, yyyy h:mm tt")</span>
                                    @if (!string.IsNullOrEmpty(selectedOrderForDetails.CancellationReason))
                                    {
                                        <span class="timeline-reason">Reason: @selectedOrderForDetails.CancellationReason</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Admin Actions -->
                <div class="details-actions">
                    @if (selectedOrderForDetails.Status != OrderStatus.Delivered && selectedOrderForDetails.Status != OrderStatus.Cancelled)
                    {
                        <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                      Variant="PrimaryButton.ButtonVariant.Primary"
                                      OnClick="@(() => OpenUpdateStatusModal(selectedOrderForDetails))">
                            Update Status
                        </PrimaryButton>
                    }
                    
                    @if (selectedOrderForDetails.CanCancel)
                    {
                        <SecondaryButton Size="SecondaryButton.ButtonSize.Large"
                                        Variant="SecondaryButton.ButtonVariant.Outline"
                                        OnClick="@(() => OpenCancelOrderModal(selectedOrderForDetails))"
                                        CssClass="btn-danger-outline">
                            Cancel Order
                        </SecondaryButton>
                    }
                    
                    <SecondaryButton Size="SecondaryButton.ButtonSize.Large"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    OnClick="CloseOrderDetailsModal">
                        Close
                    </SecondaryButton>
                </div>
            </div>
        }
    </BodyContent>
</DynamicModal>

<!-- ===== UPDATE STATUS MODAL ===== -->
<DynamicModal @ref="updateStatusModal"
              Title="Update Order Status"
              Size="DynamicModal.ModalSize.Medium"
              IsOpen="@isUpdateStatusModalOpen"
              ShowFooter="false"
              OnClose="CloseUpdateStatusModal">
    <BodyContent>
        @if (selectedOrderForStatusUpdate != null)
        {
            <div class="update-status-form">
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="status-badge @selectedOrderForStatusUpdate.Status.ToString().ToLower()">
                        @selectedOrderForStatusUpdate.Status
                    </span>
                </div>

                <div class="form-group">
                    <label class="form-label">New Status *</label>
                    <select class="form-select" @bind="newStatus">
                        <option value="">Select new status...</option>
                        @if (selectedOrderForStatusUpdate.Status == OrderStatus.Pending)
                        {
                            <option value="Processing">Processing</option>
                            <option value="Cancelled">Cancelled</option>
                        }
                        @if (selectedOrderForStatusUpdate.Status == OrderStatus.Processing)
                        {
                            <option value="Shipped">Shipped</option>
                            <option value="Cancelled">Cancelled</option>
                        }
                        @if (selectedOrderForStatusUpdate.Status == OrderStatus.Shipped)
                        {
                            <option value="Delivered">Delivered</option>
                        }
                    </select>
                </div>

                @if (newStatus == "Shipped")
                {
                    <div class="form-group">
                        <label class="form-label">Tracking Number</label>
                        <InputField @bind-Value="trackingNumber"
                                   Placeholder="Enter tracking number"
                                   CssClass="full-width" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Courier Name</label>
                        <InputField @bind-Value="courierName"
                                   Placeholder="e.g., DHL, FedEx, Local Courier"
                                   CssClass="full-width" />
                    </div>
                }

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-textarea"
                             @bind="statusUpdateNotes"
                             placeholder="Add any notes about this status update..."
                             rows="4"></textarea>
                </div>

                <div class="form-actions">
                    <SecondaryButton Size="SecondaryButton.ButtonSize.Large"
                                    Variant="SecondaryButton.ButtonVariant.Outline"
                                    OnClick="CloseUpdateStatusModal">
                        Cancel
                    </SecondaryButton>
                    <PrimaryButton Size="PrimaryButton.ButtonSize.Large"
                                  Variant="PrimaryButton.ButtonVariant.Primary"
                                  OnClick="HandleUpdateStatus"
                                  IsLoading="@isSaving"
                                  IsDisabled="@(string.IsNullOrEmpty(newStatus) || isSaving)">
                        Update Status
                    </PrimaryButton>
                </div>
            </div>
        }
    </BodyContent>
</DynamicModal>

<!-- ===== CANCEL ORDER MODAL ===== -->
<ConfirmationPopup @ref="cancelOrderPopup"
                  IsOpen="@isCancelOrderModalOpen"
                  Title="Cancel Order?"
                  Message="@($"Are you sure you want to cancel order {selectedOrderForCancellation?.OrderNumber}?")"
                  WarningText="This action cannot be undone. The customer will be notified."
                  Variant="ConfirmationPopup.ConfirmationVariant.Danger"
                  ConfirmButtonText="Cancel Order"
                  CancelButtonText="Keep Order"
                  IsProcessing="@isSaving"
                  OnConfirm="HandleCancelOrder"
                  OnCancel="CloseCancelOrderModal"
                  OnClose="CloseCancelOrderModal">
    <ChildContent>
        <div class="cancellation-form">
            <label class="form-label">Cancellation Reason *</label>
            <textarea class="form-textarea"
                     @bind="cancellationReason"
                     placeholder="Please provide a reason for cancelling this order..."
                     rows="4"></textarea>
        </div>
    </ChildContent>
</ConfirmationPopup>
