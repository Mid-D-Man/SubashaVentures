// Pages/Auth/OAuthCallback.razor - WITH ROLE-BASED REDIRECT
@page "/auth/callback"
@using Microsoft.AspNetCore.Components.Authorization
@using SubashaVentures.Services.Auth
@using SubashaVentures.Services.Supabase
@using SubashaVentures.Services.Users
@using SubashaVentures.Utilities.HelperScripts
@using LogLevel = SubashaVentures.Utilities.Logging.LogLevel
@inject SupabaseAuthService AuthService
@inject NavigationManager NavigationManager
@inject IBlazorAppLocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService

<div class="oauth-callback-container">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <h3>@statusMessage</h3>
        <p>@detailMessage</p>
    </div>
</div>

@code {
    private string statusMessage = "Completing sign in...";
    private string detailMessage = "Please wait while we authenticate your account.";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await MID_HelperFunctions.DebugMessageAsync(
                $"OAuth callback page loaded at: {NavigationManager.Uri}",
                LogLevel.Info
            );

            // Handle the OAuth callback
            var result = await AuthService.HandleOAuthCallbackAsync();

            if (result.Success)
            {
                statusMessage = "Sign in successful!";
                detailMessage = "Redirecting...";

                // Notify auth state changed
                if (AuthStateProvider is SupabaseAuthStateProvider provider)
                {
                    provider.NotifyAuthenticationStateChanged();
                }

                await Task.Delay(500);

                // âœ… ROLE-BASED REDIRECT
                var destination = await DetermineRedirectDestinationAsync();

                await MID_HelperFunctions.DebugMessageAsync(
                    $"Redirecting to: {destination}",
                    LogLevel.Info
                );

                NavigationManager.NavigateTo(destination, forceLoad: false);
            }
            else
            {
                statusMessage = "Authentication failed";
                detailMessage = result.Message;

                await MID_HelperFunctions.DebugMessageAsync(
                    $"OAuth callback failed: {result.Message}",
                    LogLevel.Error
                );

                await Task.Delay(3000);
                NavigationManager.NavigateTo("signin", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            statusMessage = "An error occurred";
            detailMessage = "Please try signing in again.";

            await MID_HelperFunctions.LogExceptionAsync(ex, "OAuth callback");

            await Task.Delay(3000);
            NavigationManager.NavigateTo("signin", forceLoad: false);
        }
    }

    /// <summary>
    /// Determine redirect destination based on user role
    /// </summary>
    private async Task<string> DetermineRedirectDestinationAsync()
    {
        try
        {
            // Check if there's a stored return URL
            var returnUrl = await LocalStorage.GetItemAsync<string>("oauth_return_url");
            await LocalStorage.RemoveItemAsync("oauth_return_url");

            if (!string.IsNullOrEmpty(returnUrl))
            {
                await MID_HelperFunctions.DebugMessageAsync(
                    $"Using stored return URL: {returnUrl}",
                    LogLevel.Info
                );
                return returnUrl;
            }

            // Get current user to check role
            var user = await AuthService.GetCurrentUserAsync();
            if (user == null)
            {
                return "/"; // Fallback to home
            }

            // Get user profile with roles
            var userProfile = await UserService.GetUserByIdAsync(user.Id);
            
            if (userProfile == null)
            {
                await MID_HelperFunctions.DebugMessageAsync(
                    "User profile not found, redirecting to home",
                    LogLevel.Warning
                );
                return "/";
            }

            // Check if user is superior admin
            if (userProfile.IsSuperiorAdmin)
            {
                await MID_HelperFunctions.DebugMessageAsync(
                    $"Superior admin detected: {user.Email}, redirecting to admin panel",
                    LogLevel.Info
                );
                return "admin";
            }

            // Regular user - go to home
            await MID_HelperFunctions.DebugMessageAsync(
                $"Regular user detected: {user.Email}, redirecting to home",
                LogLevel.Info
            );
            
            return "/";
        }
        catch (Exception ex)
        {
            await MID_HelperFunctions.LogExceptionAsync(ex, "Determining redirect destination");
            return "/"; // Fallback to home on error
        }
    }
}
