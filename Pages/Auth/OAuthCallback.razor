// Pages/Auth/OAuthCallback.razor
@page "/auth/callback"
@using SubashaVentures.Services.Auth
@using SubashaVentures.Utilities.HelperScripts
@using LogLevel = SubashaVentures.Utilities.Logging.LogLevel
@inject SupabaseAuthService AuthService
@inject NavigationManager NavigationManager
@inject IBlazorAppLocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider

<div class="oauth-callback-container">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <h3>@statusMessage</h3>
        <p>@detailMessage</p>
    </div>
</div>

@code {
    private string statusMessage = "Completing sign in...";
    private string detailMessage = "Please wait while we authenticate your account.";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await MID_HelperFunctions.DebugMessageAsync(
                "OAuth callback page loaded",
                LogLevel.Info
            );

            // Small delay to let Supabase process the tokens
            await Task.Delay(1000);

            // Handle the OAuth callback
            var result = await AuthService.HandleOAuthCallbackAsync();

            if (result.Success)
            {
                statusMessage = "Sign in successful!";
                detailMessage = "Redirecting to your dashboard...";

                // Notify auth state changed
                if (AuthStateProvider is SupabaseAuthStateProvider provider)
                {
                    provider.NotifyAuthenticationStateChanged();
                }

                await Task.Delay(500);

                // Get return URL if stored
                var returnUrl = await LocalStorage.GetItemAsync<string>("oauth_return_url");
                await LocalStorage.RemoveItemAsync("oauth_return_url");

                var destination = !string.IsNullOrEmpty(returnUrl) ? returnUrl : "/";

                await MID_HelperFunctions.DebugMessageAsync(
                    $"Redirecting to: {destination}",
                    LogLevel.Info
                );

                NavigationManager.NavigateTo(destination, forceLoad: false);
            }
            else
            {
                statusMessage = "Authentication failed";
                detailMessage = result.Message;

                await MID_HelperFunctions.DebugMessageAsync(
                    $"OAuth callback failed: {result.Message}",
                    LogLevel.Error
                );

                await Task.Delay(3000);
                NavigationManager.NavigateTo("/signin", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            statusMessage = "An error occurred";
            detailMessage = "Please try signing in again.";

            await MID_HelperFunctions.LogExceptionAsync(ex, "OAuth callback");

            await Task.Delay(3000);
            NavigationManager.NavigateTo("/signin", forceLoad: false);
        }
    }
}

<style>
    .oauth-callback-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-light, #f5f7fa) 0%, var(--primary-color, #96994A) 100%);
        padding: 2rem;
    }

    .loading-spinner {
        text-align: center;
        background: white;
        padding: 3rem;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
    }

    .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 2rem;
        border: 4px solid rgba(150, 153, 74, 0.2);
        border-top-color: var(--primary-color, #96994A);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-spinner h3 {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary, #333);
        margin: 0 0 1rem 0;
    }

    .loading-spinner p {
        font-size: 0.95rem;
        color: var(--text-secondary, #666);
        margin: 0;
        line-height: 1.6;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    [data-theme="dark"] .loading-spinner {
        background: var(--card-bg, #1e1e1e);
    }

    [data-theme="dark"] .loading-spinner h3 {
        color: var(--text-primary, #f8f9fa);
    }

    [data-theme="dark"] .loading-spinner p {
        color: var(--text-secondary, #dee2e6);
    }

    [data-theme="dark"] .spinner {
        border-color: rgba(184, 187, 106, 0.2);
        border-top-color: var(--primary-color, #B8BB6A);
    }

    @media (max-width: 768px) {
        .loading-spinner {
            padding: 2rem;
        }

        .loading-spinner h3 {
            font-size: 1.25rem;
        }

        .loading-spinner p {
            font-size: 0.875rem;
        }
    }
</style>
