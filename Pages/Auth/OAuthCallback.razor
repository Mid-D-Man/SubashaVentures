// Pages/Auth/OAuthCallback.razor
@page "/auth/callback"
@using Microsoft.AspNetCore.Components.Authorization
@using SubashaVentures.Services.Auth
@using SubashaVentures.Services.Supabase
@using SubashaVentures.Utilities.HelperScripts
@using LogLevel = SubashaVentures.Utilities.Logging.LogLevel
@inject SupabaseAuthService AuthService
@inject NavigationManager NavigationManager
@inject IBlazorAppLocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider

<div class="oauth-callback-container">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <h3>@statusMessage</h3>
        <p>@detailMessage</p>
    </div>
</div>

@code {
    private string statusMessage = "Completing sign in...";
    private string detailMessage = "Please wait while we authenticate your account.";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await MID_HelperFunctions.DebugMessageAsync(
                "OAuth callback page loaded",
                LogLevel.Info
            );

            // Small delay to let Supabase process the tokens
          //  await Task.Delay(1000);

            // Handle the OAuth callback
            var result = await AuthService.HandleOAuthCallbackAsync();

            if (result.Success)
            {
                statusMessage = "Sign in successful!";
                detailMessage = "Redirecting to your dashboard...";

                // Notify auth state changed
                if (AuthStateProvider is SupabaseAuthStateProvider provider)
                {
                    provider.NotifyAuthenticationStateChanged();
                }

                await Task.Delay(500);

                // Get return URL if stored
                var returnUrl = await LocalStorage.GetItemAsync<string>("oauth_return_url");
                await LocalStorage.RemoveItemAsync("oauth_return_url");

                var destination = !string.IsNullOrEmpty(returnUrl) ? returnUrl : "/";

                await MID_HelperFunctions.DebugMessageAsync(
                    $"Redirecting to: {destination}",
                    LogLevel.Info
                );

                NavigationManager.NavigateTo(destination, forceLoad: false);
            }
            else
            {
                statusMessage = "Authentication failed";
                detailMessage = result.Message;

                await MID_HelperFunctions.DebugMessageAsync(
                    $"OAuth callback failed: {result.Message}",
                    LogLevel.Error
                );

                await Task.Delay(3000);
                NavigationManager.NavigateTo("signin", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            statusMessage = "An error occurred";
            detailMessage = "Please try signing in again.";

            await MID_HelperFunctions.LogExceptionAsync(ex, "OAuth callback");

            await Task.Delay(3000);
            NavigationManager.NavigateTo("signin", forceLoad: false);
        }
    }
}
