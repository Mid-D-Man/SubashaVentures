@page "/product/{slug}"
@using SubashaVentures.Components.Shared.Cards
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Components.Shared.Modals
@using SubashaVentures.Layout.Products
@using SubashaVentures.Domain.Enums
@layout ProductDetailsLayout


<PageTitle>@(Product?.Name ?? "Product Details") - SubashaVentures</PageTitle>

<div class="product-details-page">
    @if (IsLoading)
    {
        <div class="loading-container">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading product details..." />
        </div>
    }
    else if (Product == null)
    {
        <div class="error-container">
            <div class="error-icon">
                @if (!string.IsNullOrEmpty(warningSvg))
                {
                    @((MarkupString)warningSvg)
                }
            </div>
            <h2>Product Not Found</h2>
            <p>The product you're looking for doesn't exist or has been removed.</p>
            <button class="btn-primary" @onclick="NavigateToShop">Browse Products</button>
        </div>
    }
    else
    {
        <div class="product-container">
            @* Image Gallery Section *@
            <div class="product-images">
                <div class="main-image">
                    @if (ImageLoading)
                    {
                        <SkeletonCard CssClass="image-skeleton" />
                    }
                    else if (!string.IsNullOrEmpty(SelectedImage))
                    {
                        <img src="@SelectedImage" alt="@Product.Name" @onload="HandleImageLoad" />
                    }
                    else
                    {
                        <div class="image-placeholder">
                            @if (!string.IsNullOrEmpty(allProductsSvg))
                            {
                                @((MarkupString)allProductsSvg)
                            }
                        </div>
                    }
                    
                    @* Badges *@
                    <div class="image-badges">
                        @if (Product.IsFeatured)
                        {
                            <span class="badge badge-featured">
                                @if (!string.IsNullOrEmpty(starSvg))
                                {
                                    <span class="badge-icon">@((MarkupString)starSvg)</span>
                                }
                                <span>Featured</span>
                            </span>
                        }
                        @if (Product.IsOnSale && Product.Discount > 0)
                        {
                            <span class="badge badge-sale">
                                @if (!string.IsNullOrEmpty(flameSvg))
                                {
                                    <span class="badge-icon">@((MarkupString)flameSvg)</span>
                                }
                                <span>-@Product.Discount% OFF</span>
                            </span>
                        }
                        @if (!Product.IsInStock)
                        {
                            <span class="badge badge-out-of-stock">
                                @if (!string.IsNullOrEmpty(warningSvg))
                                {
                                    <span class="badge-icon">@((MarkupString)warningSvg)</span>
                                }
                                <span>Out of Stock</span>
                            </span>
                        }
                    </div>
                </div>
                
                @if (Product.Images != null && Product.Images.Count > 1)
                {
                    <div class="thumbnail-gallery">
                        @foreach (var image in Product.Images)
                        {
                            <div class="thumbnail @(image == SelectedImage ? "active" : "")" 
                                 @onclick="() => SelectImage(image)">
                                @if (ThumbnailsLoading)
                                {
                                    <div class="thumbnail-skeleton"></div>
                                }
                                else
                                {
                                    <img src="@image" alt="@Product.Name" />
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            @* Product Info Section *@
            <div class="product-info">
                <div class="product-header">
                    <div class="category-breadcrumb">
                        <span @onclick="NavigateToShop" class="breadcrumb-link">Shop</span>
                        <span class="separator">/</span>
                        <span @onclick="() => NavigateToCategory(Product.CategoryId)" class="breadcrumb-link">@Product.Category</span>
                    </div>
                    
                    <h1 class="product-title">@Product.Name</h1>
                    
                    @* Brand *@
                    @if (!string.IsNullOrEmpty(Product.Brand))
                    {
                        <p class="product-brand">by <strong>@Product.Brand</strong></p>
                    }
                    
                    @* Rating *@
                    @if (Product.Rating > 0)
                    {
                        <div class="product-rating">
                            <div class="stars">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    int currentStar = i;
                                    <span class="star @(currentStar <= Product.Rating ? "filled" : "")">
                                        @if (!string.IsNullOrEmpty(starSvg))
                                        {
                                            @((MarkupString)starSvg)
                                        }
                                    </span>
                                }
                            </div>
                            <span class="rating-text">@Product.DisplayRating</span>
                            <span class="review-count">(@Product.ReviewCount reviews)</span>
                        </div>
                    }
                </div>
@* Price Section *@
                <div class="price-section">
                    <div class="price-wrapper">
                        @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                        {
                            <span class="original-price">@Product.DisplayOriginalPrice</span>
                        }
                        <span class="current-price">@GetVariantPrice()</span>
                    </div>
                    @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                    {
                        var savings = Product.OriginalPrice.Value - Product.Price;
                        <div class="savings-badge">
                            @if (!string.IsNullOrEmpty(checkMarkSvg))
                            {
                                <span class="savings-icon">@((MarkupString)checkMarkSvg)</span>
                            }
                            <span>You save ₦@savings.ToString("N0") (@Product.Discount% off)</span>
                        </div>
                    }
                </div>

                @* Stock Status *@
                <div class="stock-status @(GetVariantStock() > 0 ? "in-stock" : "out-of-stock")">
                    <span class="status-icon">
                        @if (GetVariantStock() > 0)
                        {
                            @if (!string.IsNullOrEmpty(checkMarkSvg))
                            {
                                @((MarkupString)checkMarkSvg)
                            }
                        }
                        else
                        {
                            @if (!string.IsNullOrEmpty(closeSvg))
                            {
                                @((MarkupString)closeSvg)
                            }
                        }
                    </span>
                    <span class="status-text">@GetStockStatus()</span>
                    @if (GetVariantStock() > 0 && GetVariantStock() <= 10)
                    {
                        <span class="stock-count">
                            @if (!string.IsNullOrEmpty(warningSvg))
                            {
                                <span class="warning-icon">@((MarkupString)warningSvg)</span>
                            }
                            Only @GetVariantStock() left!
                        </span>
                    }
                </div>

                @* Description *@
                @if (!string.IsNullOrEmpty(Product.Description))
                {
                    <div class="product-description">
                        <h3>Description</h3>
                        <p>@Product.Description</p>
                    </div>
                }

                @* Variant Selection *@
                @if (Product.Sizes != null && Product.Sizes.Any())
                {
                    <div class="variant-selector">
                        <label class="variant-label">Size</label>
                        <div class="variant-options">
                            @foreach (var size in Product.Sizes)
                            {
                                <button class="variant-btn @(SelectedSize == size ? "selected" : "")"
                                        @onclick="() => SelectSize(size)">
                                    @size
                                </button>
                            }
                        </div>
                    </div>
                }

                @if (Product.Colors != null && Product.Colors.Any())
                {
                    <div class="variant-selector">
                        <label class="variant-label">Color</label>
                        <div class="variant-options">
                            @foreach (var color in Product.Colors)
                            {
                                var colorHex = GetColorHex(color);
                                <button class="variant-btn color-btn @(SelectedColor == color ? "selected" : "")"
                                        @onclick="() => SelectColor(color)"
                                        title="@color">
                                    @if (!string.IsNullOrEmpty(colorHex))
                                    {
                                        <span class="color-swatch" style="background-color: @colorHex"></span>
                                    }
                                    <span class="color-name">@color</span>
                                </button>
                            }
                        </div>
                    </div>
                }

                @* Shipping Info *@
                <div class="shipping-info">
                    <h3>Shipping Information</h3>
                    @if (GetVariantHasFreeShipping())
                    {
                        <div class="shipping-item free-shipping">
                            <span class="shipping-icon">
                                @if (!string.IsNullOrEmpty(shippingSvg))
                                {
                                    @((MarkupString)shippingSvg)
                                }
                            </span>
                            <span class="shipping-text">FREE Shipping</span>
                        </div>
                    }
                    else
                    {
                        <div class="shipping-item">
                            <span class="shipping-icon">
                                @if (!string.IsNullOrEmpty(shippingSvg))
                                {
                                    @((MarkupString)shippingSvg)
                                }
                            </span>
                            <span class="shipping-text">Shipping: ₦@GetVariantShippingCost().ToString("N0")</span>
                        </div>
                    }
                    <div class="shipping-item">
                        <span class="shipping-icon">
                            @if (!string.IsNullOrEmpty(weightSvg))
                            {
                                @((MarkupString)weightSvg)
                            }
                        </span>
                        <span class="shipping-text">Weight: @GetVariantWeight() kg</span>
                    </div>
                </div>

                @* Quantity Selector *@
                @if (GetVariantStock() > 0)
                {
                    <div class="quantity-section">
                        <label class="quantity-label">Quantity</label>
                        <div class="quantity-selector">
                            <button class="qty-btn" @onclick="DecreaseQuantity" disabled="@(SelectedQuantity <= 1)">
                                <span>−</span>
                            </button>
                            <input type="number" 
                                   class="qty-input" 
                                   @bind="SelectedQuantity" 
                                   @bind:event="oninput"
                                   min="1" 
                                   max="@GetVariantStock()" 
                                   @onchange="ValidateQuantity" />
                            <button class="qty-btn" @onclick="IncreaseQuantity" disabled="@(SelectedQuantity >= GetVariantStock())">
                                <span>+</span>
                            </button>
                        </div>
                        <span class="quantity-info">Max: @GetVariantStock()</span>
                    </div>
                }
@* Action Buttons *@
                <div class="action-buttons">
                    @if (IsInCart)
                    {
                        <button class="btn-view-cart" @onclick="NavigateToCart">
                            <span class="btn-icon">
                                @if (!string.IsNullOrEmpty(checkMarkSvg))
                                {
                                    @((MarkupString)checkMarkSvg)
                                }
                            </span>
                            <span>IN CART - VIEW CART</span>
                        </button>
                    }
                    else
                    {
                        <button class="btn-add-cart @(IsAddingToCart ? "loading" : "")" 
                                @onclick="HandleAddToCart"
                                disabled="@(GetVariantStock() == 0 || IsAddingToCart)">
                            @if (IsAddingToCart)
                            {
                                <span class="btn-spinner"></span>
                                <span>Adding...</span>
                            }
                            else if (GetVariantStock() > 0)
                            {
                                <span class="btn-icon">
                                    @if (!string.IsNullOrEmpty(cartSvg))
                                    {
                                        @((MarkupString)cartSvg)
                                    }
                                </span>
                                <span>ADD TO CART</span>
                            }
                            else
                            {
                                <span>OUT OF STOCK</span>
                            }
                        </button>
                    }
                    
                    <button class="btn-buy-now @(IsPurchasing ? "loading" : "")"
                            @onclick="HandleBuyNow"
                            disabled="@(GetVariantStock() == 0 || IsPurchasing)">
                        @if (IsPurchasing)
                        {
                            <span class="btn-spinner"></span>
                            <span>Processing...</span>
                        }
                        else
                        {
                            <span class="btn-icon">
                                @if (!string.IsNullOrEmpty(buyNowSvg))
                                {
                                    @((MarkupString)buyNowSvg)
                                }
                            </span>
                            <span>BUY NOW</span>
                        }
                    </button>
                </div>

                <div class="secondary-actions">
                    @if (IsInWishlist)
                    {
                        <button class="btn-view-wishlist" @onclick="NavigateToWishlist">
                            <span class="heart-icon heart-filled">
                                @if (!string.IsNullOrEmpty(heartSvg))
                                {
                                    @((MarkupString)heartSvg)
                                }
                            </span>
                            <span>IN WISHLIST - VIEW</span>
                        </button>
                    }
                    else
                    {
                        <button class="btn-wishlist @(IsTogglingWishlist ? "loading" : "")" 
                                @onclick="HandleWishlistToggle"
                                disabled="@IsTogglingWishlist">
                            @if (IsTogglingWishlist)
                            {
                                <span class="btn-spinner-small"></span>
                            }
                            else
                            {
                                <span class="heart-icon">
                                    @if (!string.IsNullOrEmpty(heartSvg))
                                    {
                                        @((MarkupString)heartSvg)
                                    }
                                </span>
                                <span>ADD TO WISHLIST</span>
                            }
                        </button>
                    }
                </div>

                @* Tags *@
                @if (Product.Tags != null && Product.Tags.Any())
                {
                    <div class="product-tags">
                        <h3>Tags</h3>
                        <div class="tags-list">
                            @foreach (var tag in Product.Tags)
                            {
                                <span class="tag">@tag</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Long Description *@
        @if (!string.IsNullOrEmpty(Product.LongDescription))
        {
            <div class="long-description-section">
                <h2>Product Details</h2>
                <div class="long-description-content">
                    @((MarkupString)Product.LongDescription)
                </div>
            </div>
        }

        @* Reviews Section *@
        <div class="reviews-section">
            <div class="reviews-header">
                <h2>Customer Reviews</h2>
                @if (IsAuthenticated)
                {
                    <button class="btn-write-review" @onclick="OpenReviewForm">
                        @if (!string.IsNullOrEmpty(editSvg))
                        {
                            <span class="review-icon">@((MarkupString)editSvg)</span>
                        }
                        <span>Write a Review</span>
                    </button>
                }
            </div>

            @if (ShowReviewForm)
            {
                <div class="review-form-container">
                    <ProductReviewForm ProductId="@Product.Id.ToString()"
                                      OnReviewSubmitted="HandleReviewSubmitted"
                                      OnCancel="CloseReviewForm" />
                </div>
            }

            <div class="reviews-list">
                @if (Reviews.Any())
                {
                    @foreach (var review in Reviews)
                    {
                        <CustomerReviewCard Review="@review" />
                    }
                }
                else
                {
                    <div class="no-reviews">
                        <p>No reviews yet. Be the first to review this product!</p>
                    </div>
                }
            </div>
        </div>

        @* Related Products *@
        @if (RelatedProducts.Any())
        {
            <div class="related-products-section">
                <RelatedProducts Products="@RelatedProducts" 
                                OnAddToCart="HandleRelatedAddToCart"
                                OnToggleFavorite="HandleRelatedToggleFavorite" />
            </div>
        }
    }
</div>

@* Review Submission Confirmation Modal *@
<ConfirmationPopup @ref="ReviewConfirmationPopup"
                   IsOpen="@ShowReviewConfirmation"
                   Title="Review Submitted!"
                   Message="Thank you for your review. It will be verified and approved by our team before being displayed."
                   Variant="ConfirmationPopup.ConfirmationVariant.Success"
                   ConfirmButtonText="OK"
                   ShowCancelButton="false"
                   OnConfirm="CloseReviewConfirmation"
                   OnClose="CloseReviewConfirmation" />
