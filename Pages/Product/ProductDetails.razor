@page "/product/{slug}"
@using SubashaVentures.Components.Shared.Cards
@using SubashaVentures.Components.Shared.Forms
@using SubashaVentures.Components.Shared.Loading
@using SubashaVentures.Domain.Product
@layout MainLayout

<div class="product-details-page">
    @if (IsLoading)
    {
        <div class="loading-container">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Large" Message="Loading product details..." />
        </div>
    }
    else if (Product == null)
    {
        <div class="error-container">
            <div class="error-icon">üì¶</div>
            <h2>Product Not Found</h2>
            <p>The product you're looking for doesn't exist or has been removed.</p>
            <button class="btn-primary" @onclick="NavigateToShop">Browse Products</button>
        </div>
    }
    else
    {
        <div class="product-container">
            @* Image Gallery Section *@
            <div class="product-images">
                <div class="main-image">
                    @if (!string.IsNullOrEmpty(SelectedImage))
                    {
                        <img src="@SelectedImage" alt="@Product.Name" />
                    }
                    else
                    {
                        <div class="image-placeholder">
                            <span class="placeholder-icon">üì¶</span>
                        </div>
                    }
                    
                    @* Badges *@
                    <div class="image-badges">
                        @if (Product.IsFeatured)
                        {
                            <span class="badge badge-featured">‚≠ê Featured</span>
                        }
                        @if (Product.IsOnSale && Product.Discount > 0)
                        {
                            <span class="badge badge-sale">-@Product.Discount% OFF</span>
                        }
                        @if (!Product.IsInStock)
                        {
                            <span class="badge badge-out-of-stock">Out of Stock</span>
                        }
                    </div>
                </div>
                
                @if (Product.Images != null && Product.Images.Count > 1)
                {
                    <div class="thumbnail-gallery">
                        @foreach (var image in Product.Images)
                        {
                            <div class="thumbnail @(image == SelectedImage ? "active" : "")" 
                                 @onclick="() => SelectImage(image)">
                                <img src="@image" alt="@Product.Name" />
                            </div>
                        }
                    </div>
                }
            </div>

            @* Product Info Section *@
            <div class="product-info">
                <div class="product-header">
                    <div class="category-breadcrumb">
                        <span @onclick="NavigateToShop" class="breadcrumb-link">Shop</span>
                        <span class="separator">/</span>
                        <span @onclick="() => NavigateToCategory(Product.CategoryId)" class="breadcrumb-link">@Product.Category</span>
                    </div>
                    
                    <h1 class="product-title">@Product.Name</h1>
                    
                    @* Brand *@
                    @if (!string.IsNullOrEmpty(Product.Brand))
                    {
                        <p class="product-brand">by <strong>@Product.Brand</strong></p>
                    }
                    
                    @* Rating *@
                    @if (Product.Rating > 0)
                    {
                        <div class="product-rating">
                            <div class="stars">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <span class="star @(i <= Product.Rating ? "filled" : "")">‚òÖ</span>
                                }
                            </div>
                            <span class="rating-text">@Product.DisplayRating</span>
                            <span class="review-count">(@Product.ReviewCount reviews)</span>
                        </div>
                    }
                </div>

                @* Price Section *@
                <div class="price-section">
                    <div class="price-wrapper">
                        @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                        {
                            <span class="original-price">@Product.DisplayOriginalPrice</span>
                        }
                        <span class="current-price">@Product.DisplayPrice</span>
                    </div>
                    @if (Product.IsOnSale && Product.OriginalPrice.HasValue)
                    {
                        var savings = Product.OriginalPrice.Value - Product.Price;
                        <div class="savings-badge">
                            You save ‚Ç¶@savings.ToString("N0") (@Product.Discount% off)
                        </div>
                    }
                </div>

                @* Stock Status *@
                <div class="stock-status @(Product.IsInStock ? "in-stock" : "out-of-stock")">
                    <span class="status-icon">@(Product.IsInStock ? "‚úì" : "‚úó")</span>
                    <span class="status-text">@Product.StockStatus</span>
                    @if (Product.Stock > 0 && Product.Stock <= 10)
                    {
                        <span class="stock-count">Only @Product.Stock left!</span>
                    }
                </div>

                @* Description *@
                @if (!string.IsNullOrEmpty(Product.Description))
                {
                    <div class="product-description">
                        <h3>Description</h3>
                        <p>@Product.Description</p>
                    </div>
                }

                @* Available Sizes (if any) *@
                @if (Product.Sizes != null && Product.Sizes.Any())
                {
                    <div class="product-sizes">
                        <h3>Available Sizes</h3>
                        <div class="size-list">
                            @foreach (var size in Product.Sizes)
                            {
                                <span class="size-badge">@size</span>
                            }
                        </div>
                        <p class="variant-note">Select size during checkout</p>
                    </div>
                }

                @* Available Colors (if any) *@
                @if (Product.Colors != null && Product.Colors.Any())
                {
                    <div class="product-colors">
                        <h3>Available Colors</h3>
                        <div class="color-list">
                            @foreach (var color in Product.Colors)
                            {
                                <span class="color-badge">@color</span>
                            }
                        </div>
                        <p class="variant-note">Select color during checkout</p>
                    </div>
                }

                @* Shipping Info *@
                <div class="shipping-info">
                    <h3>Shipping Information</h3>
                    @if (Product.HasFreeShipping)
                    {
                        <div class="shipping-item free-shipping">
                            <span class="shipping-icon">üöö</span>
                            <span class="shipping-text">FREE Shipping</span>
                        </div>
                    }
                    else
                    {
                        <div class="shipping-item">
                            <span class="shipping-icon">üöö</span>
                            <span class="shipping-text">Shipping: ‚Ç¶@Product.BaseShippingCost.ToString("N0")</span>
                        </div>
                    }
                    <div class="shipping-item">
                        <span class="shipping-icon">‚öñÔ∏è</span>
                        <span class="shipping-text">Weight: @Product.BaseWeight kg</span>
                    </div>
                </div>

                @* Quantity Selector *@
                @if (Product.IsInStock)
                {
                    <div class="quantity-section">
                        <label>Quantity</label>
                        <div class="quantity-selector">
                            <button class="qty-btn" @onclick="DecreaseQuantity" disabled="@(SelectedQuantity <= 1)">‚àí</button>
                            <input type="number" class="qty-input" @bind="SelectedQuantity" min="1" max="@Product.Stock" />
                            <button class="qty-btn" @onclick="IncreaseQuantity" disabled="@(SelectedQuantity >= Product.Stock)">+</button>
                        </div>
                    </div>
                }

                @* Action Buttons *@
                <div class="action-buttons">
                    <button class="btn-add-to-cart @(IsAddingToCart ? "loading" : "")" 
                            @onclick="HandleAddToCart"
                            disabled="@(!Product.IsInStock || IsAddingToCart)">
                        @if (IsAddingToCart)
                        {
                            <span class="btn-spinner"></span>
                            <span>Adding to Cart...</span>
                        }
                        else if (IsInCart)
                        {
                            <span>‚úì Added to Cart</span>
                        }
                        else if (Product.IsInStock)
                        {
                            <span>üõí Add to Cart (@SelectedQuantity)</span>
                        }
                        else
                        {
                            <span>Out of Stock</span>
                        }
                    </button>
                    
                    <button class="btn-wishlist @(IsInWishlist ? "active" : "") @(IsTogglingWishlist ? "loading" : "")" 
                            @onclick="HandleWishlistToggle"
                            disabled="@IsTogglingWishlist">
                        @if (IsTogglingWishlist)
                        {
                            <span class="btn-spinner-small"></span>
                        }
                        else
                        {
                            <span class="heart-icon">@(IsInWishlist ? "‚ô•" : "‚ô°")</span>
                            <span>@(IsInWishlist ? "In Wishlist" : "Add to Wishlist")</span>
                        }
                    </button>
                </div>

                @* Tags *@
                @if (Product.Tags != null && Product.Tags.Any())
                {
                    <div class="product-tags">
                        <h3>Tags</h3>
                        <div class="tags-list">
                            @foreach (var tag in Product.Tags)
                            {
                                <span class="tag">@tag</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Long Description *@
        @if (!string.IsNullOrEmpty(Product.LongDescription))
        {
            <div class="long-description-section">
                <h2>Product Details</h2>
                <div class="long-description-content">
                    @((MarkupString)Product.LongDescription)
                </div>
            </div>
        }

        @* Reviews Section *@
        <div class="reviews-section">
            <div class="reviews-header">
                <h2>Customer Reviews</h2>
                @if (IsAuthenticated)
                {
                    <button class="btn-write-review" @onclick="OpenReviewForm">
                        ‚úçÔ∏è Write a Review
                    </button>
                }
            </div>

            @if (ShowReviewForm)
            {
                <div class="review-form-container">
                    <ProductReviewForm ProductId="@Product.Id.ToString()"
                                      OnReviewSubmitted="HandleReviewSubmitted"
                                      OnCancel="CloseReviewForm" />
                </div>
            }

            <div class="reviews-list">
                @if (Reviews.Any())
                {
                    @foreach (var review in Reviews)
                    {
                        <CustomerReviewCard Review="@review" />
                    }
                }
                else
                {
                    <div class="no-reviews">
                        <p>No reviews yet. Be the first to review this product!</p>
                    </div>
                }
            </div>
        </div>

        @* Related Products *@
        @if (RelatedProducts.Any())
        {
            <div class="related-products-section">
                <RelatedProducts Products="@RelatedProducts" />
            </div>
        }
    }
</div>

@code {
    // Implementation in ProductDetails.razor.cs
}